<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixOnce</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(94, 129, 172, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(129, 178, 154, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(72, 119, 147, 0.08) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
        }

        /* ===== GLASS EFFECT ===== */
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0 16px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -1px;
        }

        .logo-text {
            display: inline-flex;
            align-items: baseline;
            direction: ltr;
        }

        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-center .project-name {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: #ccc;
        }

        .header-center .project-name:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* CSS Icons - clean, no emoji */
        .icon-refresh {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: none;
        }
        .glass-btn:hover .icon-refresh {
            animation: spin 0.5s linear;
        }

        .icon-settings {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 50%;
            position: relative;
        }
        .icon-settings::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            border: 2px solid currentColor;
            border-radius: 50%;
        }

        /* Activity & Error Icons - CSS based */
        .icon-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .icon-dot.file { background: #81b29a; }
        .icon-dot.command { background: #f2cc8f; }
        .icon-dot.error { background: #e76f51; }
        .icon-dot.warning { background: #f2cc8f; }
        .icon-dot.critical { background: #ff4444; box-shadow: 0 0 6px rgba(255,68,68,0.5); }

        /* Feed header icons */
        .feed-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #81b29a;
        }
        .feed-icon.active {
            background: #81b29a;
            box-shadow: 0 0 8px rgba(129, 178, 154, 0.5);
            animation: pulse-dot 2s infinite;
        }
        .feed-icon.error {
            background: #e76f51;
            box-shadow: 0 0 8px rgba(231, 111, 81, 0.5);
        }

        /* Small glass buttons */
        .glass-btn.small {
            padding: 4px 8px;
            font-size: 0.7rem;
        }
        .glass-btn.small .icon-refresh {
            width: 10px;
            height: 10px;
            border-width: 1.5px;
        }

        /* Unified Insights Section */
        .insights-section .section-content {
            padding: 12px;
        }
        .unified-insights {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .unified-insights .memory-card {
            position: relative;
            padding-left: 20px;
        }
        .insight-type-dot {
            position: absolute;
            left: 8px;
            top: 12px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .insight-type-dot.lesson { background: #81b29a; }
        .insight-type-dot.decision { background: #5e81ac; }
        .insight-type-dot.avoid { background: #e76f51; }
        .insights-empty {
            text-align: center;
            color: #555;
            font-size: 0.8rem;
            padding: 16px;
        }
        .insight-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            padding-top: 12px;
            margin-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .logo-f {
            color: #5e81ac;
            font-weight: 700;
        }

        .logo-o {
            position: relative;
            display: inline-block;
            color: #5e81ac;
            font-weight: 700;
        }

        /* Checkmark inside the O */
        .logo-o::after {
            content: '✓';
            position: absolute;
            top: 52%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.65rem;
            font-weight: 700;
            color: #81b29a;
        }

        .project-name {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
            cursor: pointer;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .project-name:hover {
            background: rgba(255,255,255,0.05);
            color: #888;
        }

        .project-switcher {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 4px;
        }

        .switch-project-btn {
            background: rgba(94, 129, 172, 0.2);
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #5e81ac;
            transition: all 0.2s;
        }

        .switch-project-btn:hover {
            background: rgba(94, 129, 172, 0.3);
            color: #81b29a;
        }

        .switch-icon {
            display: inline-block;
            transform: rotate(90deg);
        }

        /* Removed old header-refresh-btn - now using glass-btn */

        /* Project List in Switcher */
        .project-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
        }

        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .project-item:hover {
            background: rgba(94, 129, 172, 0.2);
        }

        .project-item.active {
            border-color: #81b29a;
            background: rgba(129, 178, 154, 0.15);
        }

        .project-item-name {
            font-weight: 500;
            color: #fff;
        }

        .project-item-stack {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        .project-item-issues {
            background: rgba(255,100,100,0.2);
            color: #ff6b6b;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .project-item-issues.zero {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .no-projects {
            text-align: center;
            padding: 24px;
            color: #666;
        }

        /* ===== ACTIVE PROJECT CARD (Phase 1) ===== */
        .project-active-card {
            background: linear-gradient(135deg, rgba(129, 178, 154, 0.2) 0%, rgba(94, 129, 172, 0.2) 100%);
            border: 2px solid #81b29a;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-active-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(129, 178, 154, 0.3);
        }

        .project-active-badge {
            font-size: 0.75rem;
            color: #81b29a;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .project-active-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .project-active-stack {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 12px;
        }

        .project-active-goal {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #e0e0e0;
            margin-bottom: 12px;
            direction: rtl;
        }

        .project-active-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .project-active-stats span {
            font-size: 0.8rem;
            color: #ccc;
        }

        .stat-errors { color: #ff6b6b !important; }
        .stat-insights { color: #ffd93d !important; }
        .stat-decisions { color: #6bcfff !important; }

        .project-active-btn {
            width: 100%;
            padding: 12px;
            background: #81b29a;
            border: none;
            border-radius: 8px;
            color: #1a1a2e;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-active-btn:hover {
            background: #9dc8b2;
        }

        .project-section-title {
            font-size: 0.85rem;
            color: #888;
            margin: 16px 0 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            direction: rtl;
        }

        .project-section-stale {
            color: #666;
        }

        .project-item-stale {
            opacity: 0.6;
        }

        .project-item-time {
            font-size: 0.75rem;
            color: #888;
        }

        /* ===== STATUS ===== */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            margin: 16px 0;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .status-bar.clear {
            background: rgba(129, 178, 154, 0.15);
            border: 1px solid rgba(129, 178, 154, 0.3);
            color: #81b29a;
        }

        .status-bar.warning {
            background: rgba(242, 204, 143, 0.15);
            border: 1px solid rgba(242, 204, 143, 0.3);
            color: #f2cc8f;
        }

        .status-bar.error {
            background: rgba(231, 111, 81, 0.15);
            border: 1px solid rgba(231, 111, 81, 0.3);
            color: #e76f51;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ===== LIVE STATE (Simplified) ===== */
        .live-state {
            padding: 16px 20px;
            margin: 16px 0;
            text-align: center;
        }

        /* ===== HERO CARD (Focus Mode) ===== */
        .hero-card {
            background: linear-gradient(145deg, rgba(20, 25, 45, 0.95) 0%, rgba(15, 20, 35, 0.98) 100%);
            border: 1px solid rgba(129, 178, 154, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #81b29a, #5e81ac, #81b29a);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .hero-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #81b29a;
            margin-bottom: 16px;
        }

        .hero-status-dot {
            width: 8px;
            height: 8px;
            background: #81b29a;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(129, 178, 154, 0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 8px rgba(129, 178, 154, 0); }
        }

        .hero-status.disconnected { color: #e76f51; }
        .hero-status.disconnected .hero-status-dot {
            background: #e76f51;
            animation: none;
        }

        .live-badge {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
            animation: pulse-badge 2s ease-in-out infinite;
        }

        .live-badge.disconnected {
            background: rgba(150, 150, 150, 0.2);
            color: #888;
            animation: none;
        }

        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .sync-counter {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 193, 7, 0.15);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #ffc107;
            cursor: default;
            transition: all 0.2s;
        }

        .sync-counter:hover {
            background: rgba(255, 193, 7, 0.25);
            transform: scale(1.05);
        }

        .sync-icon {
            font-size: 0.9rem;
        }

        .sync-value {
            font-weight: 600;
        }

        .sync-label {
            opacity: 0.8;
        }

        .hero-project-name {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .hero-project-meta {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 20px;
        }

        .hero-project-meta span {
            margin-left: 8px;
        }

        .hero-goal {
            background: rgba(94, 129, 172, 0.15);
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .hero-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .hero-goal-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #5e81ac;
        }

        .hero-goal-time {
            font-size: 0.7rem;
            color: #888;
        }

        .hero-goal-text {
            font-size: 1.05rem;
            color: #e0e0e0;
            line-height: 1.5;
            font-weight: 500;
        }

        .hero-goal-history {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .goal-history-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 6px;
        }

        .goal-history-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .goal-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #888;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }

        .goal-history-item .goal-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .goal-history-item .goal-time {
            font-size: 0.7rem;
            color: #666;
            margin-left: 8px;
        }

        .hero-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .hero-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #aaa;
        }

        .hero-stat.clickable {
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .hero-stat.clickable:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.05);
        }

        .hero-stat-value {
            font-weight: 600;
            color: #fff;
        }

        .hero-stat.errors .hero-stat-value { color: #ff6b6b; }
        .hero-stat.insights .hero-stat-value { color: #ffd93d; }
        .hero-stat.decisions .hero-stat-value { color: #6bcfff; }

        /* Protocol Compliance Widget */
        .compliance-widget {
            background: rgba(30, 30, 35, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 16px;
        }

        .compliance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .compliance-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
        }

        .compliance-status {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .compliance-status.ok {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .compliance-status.warning {
            background: rgba(255, 217, 61, 0.2);
            color: #ffd93d;
        }

        .compliance-status.error {
            background: rgba(231, 111, 81, 0.2);
            color: #e76f51;
        }

        .compliance-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .compliance-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .compliance-item .icon {
            width: 16px;
            text-align: center;
        }

        .compliance-item.ok { color: #81b29a; }
        .compliance-item.warning { color: #ffd93d; }
        .compliance-item.error { color: #e76f51; }

        .hero-btn {
            width: 100%;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            color: #0a0a12;
            background: linear-gradient(135deg, #81b29a 0%, #6a9e87 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hero-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(129, 178, 154, 0.4);
        }

        .hero-btn-icon {
            font-size: 1.2rem;
        }

        /* ===== COLLAPSIBLE SECTIONS ===== */
        .collapse-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapse-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .collapse-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .collapse-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            font-size: 1rem;
        }

        .collapse-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #ccc;
        }

        .collapse-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #888;
        }

        .collapse-count.has-items {
            background: rgba(94, 129, 172, 0.3);
            color: #5e81ac;
        }

        .collapse-count.has-errors {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .collapse-arrow {
            font-size: 0.8rem;
            color: #666;
            transition: transform 0.2s;
        }

        .collapse-section.open .collapse-arrow {
            transform: rotate(180deg);
        }

        .collapse-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapse-section.open .collapse-content {
            max-height: 500px;
        }

        .collapse-inner {
            padding: 0 16px 16px;
        }

        /* Legacy support - hide old elements (Focus Mode) */
        .live-state { display: none !important; }
        .quick-stats { display: none !important; }
        .browser-errors-feed { display: none !important; }
        #unified-insights-section { display: none !important; }
        .unified-insights-section { display: none !important; }
        .section.insights-section { display: none !important; }
        .connection-status { display: none !important; }

        .live-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #ccc;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .live-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .live-action-btn.primary {
            background: rgba(94, 129, 172, 0.2);
            border-color: rgba(94, 129, 172, 0.4);
            color: #fff;
        }

        .live-action-btn.primary:hover {
            background: rgba(94, 129, 172, 0.3);
        }

        .reset-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(231, 111, 81, 0.3);
            border-radius: 8px;
            color: #e76f51;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            background: rgba(231, 111, 81, 0.1);
        }

        /* ===== HUMAN UI: What Changed Today (v2 with diff stats) ===== */
        .changes-card {
            margin: 16px 0;
            padding: 0;
            overflow: hidden;
        }
        .changes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            flex-wrap: wrap;
            gap: 10px;
        }
        .changes-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .changes-filter {
            display: flex;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 2px;
        }
        .filter-btn {
            padding: 5px 10px;
            font-size: 0.75rem;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            color: rgba(255,255,255,0.8);
        }
        .filter-btn.active {
            background: rgba(94, 129, 172, 0.3);
            color: #fff;
        }
        .changes-title {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
        }
        .changes-count {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .changes-legend {
            display: flex;
            gap: 16px;
            padding: 8px 18px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            direction: rtl;
        }
        .legend-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #888;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            opacity: 0.5;
            min-width: 28px;
            min-height: 28px;
            position: relative;
        }
        .legend-item:hover {
            opacity: 1;
            background: rgba(255,255,255,0.08);
            transform: scale(1.1);
        }
        .legend-item.active {
            opacity: 1;
            background: rgba(255,255,255,0.15);
            color: #fff;
        }
        /* Custom tooltip */
        .legend-item::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            margin-bottom: 4px;
            z-index: 100;
        }
        .legend-item:hover::after {
            opacity: 1;
            visibility: visible;
        }
        .legend-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .legend-icon::before {
            content: '';
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        .legend-icon::after {
            position: absolute;
            font-weight: bold;
            font-size: 8px;
        }
        .legend-icon.edit::before {
            background: rgba(94, 129, 172, 0.25);
            border: 1.5px solid #5e81ac;
        }
        .legend-icon.edit::after {
            content: '╱';
            color: #5e81ac;
            font-size: 9px;
        }
        .legend-icon.write::before {
            background: rgba(129, 178, 154, 0.25);
            border: 1.5px solid #81b29a;
            border-radius: 3px;
        }
        .legend-icon.write::after {
            content: '+';
            color: #81b29a;
            font-size: 10px;
        }
        .legend-icon.bash::before {
            background: rgba(242, 164, 93, 0.25);
            border: 1.5px solid #f2a45d;
            border-radius: 4px;
        }
        .legend-icon.bash::after {
            content: '>';
            color: #f2a45d;
            font-family: monospace;
            font-size: 9px;
        }
        .legend-icon.read::before {
            background: rgba(180, 142, 173, 0.25);
            border: 1.5px solid #b48ead;
        }
        .legend-icon.read::after {
            content: '•';
            color: #b48ead;
            font-size: 12px;
        }
        .legend-icon.error::before {
            background: rgba(231, 111, 81, 0.25);
            border: 1.5px solid #e76f51;
        }
        .legend-icon.error::after {
            content: '!';
            color: #e76f51;
        }
        .legend-icon.insight::before {
            background: rgba(255, 217, 61, 0.25);
            border: 1.5px solid #ffd93d;
        }
        .legend-icon.insight::after {
            content: '✦';
            color: #ffd93d;
            font-size: 10px;
        }
        /* Full size icon for change items */
        .change-icon.insight::before {
            background: rgba(255, 217, 61, 0.25);
            border: 2px solid #ffd93d;
            border-radius: 50%;
        }
        .change-icon.insight::after {
            content: '✦';
            color: #ffd93d;
            font-size: 12px;
        }
        /* Decision icon */
        .legend-icon.decision::before {
            background: rgba(107, 207, 255, 0.25);
            border: 1.5px solid #6bcfff;
        }
        .legend-icon.decision::after {
            content: '⚡';
            font-size: 8px;
        }
        .change-icon.decision::before {
            background: rgba(107, 207, 255, 0.25);
            border: 2px solid #6bcfff;
            border-radius: 50%;
        }
        .change-icon.decision::after {
            content: '⚡';
            color: #6bcfff;
            font-size: 10px;
            font-size: 9px;
        }
        .changes-list {
            padding: 8px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .changes-empty {
            padding: 24px;
            text-align: center;
            color: #666;
            font-size: 0.85rem;
        }
        .change-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .change-item:hover {
            background: rgba(255,255,255,0.05);
        }
        .change-item:last-child {
            border-bottom: none;
        }
        .change-item.recent {
            background: rgba(129, 178, 154, 0.08);
        }
        [dir="rtl"] .change-item.recent {
            border-left: 3px solid #81b29a;
        }
        [dir="ltr"] .change-item.recent {
            border-right: 3px solid #81b29a;
        }
        .change-item.recent:hover {
            background: rgba(129, 178, 154, 0.15);
        }
        .change-item.error-item {
            background: rgba(231, 111, 81, 0.05);
        }
        .change-item.error-item:hover {
            background: rgba(231, 111, 81, 0.1);
        }
        [dir="rtl"] .change-item.error-item {
            border-left: 3px solid #e76f51;
        }
        [dir="ltr"] .change-item.error-item {
            border-right: 3px solid #e76f51;
        }
        .change-item.insight-item {
            background: rgba(255, 217, 61, 0.05);
        }
        .change-item.insight-item:hover {
            background: rgba(255, 217, 61, 0.1);
        }
        [dir="rtl"] .change-item.insight-item {
            border-left: 3px solid #ffd93d;
        }
        [dir="ltr"] .change-item.insight-item {
            border-right: 3px solid #ffd93d;
        }
        .live-badge {
            font-size: 0.65rem;
            color: #81b29a;
            background: rgba(129, 178, 154, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            animation: pulse-live 2s ease-in-out infinite;
        }
        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .change-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }
        .change-icon::before {
            content: '';
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .change-icon::after {
            position: absolute;
            font-weight: bold;
            font-size: 12px;
        }
        /* Edit - Blue circle with diagonal line (pencil) */
        .change-icon.edit::before {
            background: rgba(94, 129, 172, 0.25);
            border: 2px solid #5e81ac;
            border-radius: 50%;
        }
        .change-icon.edit::after {
            content: '╱';
            color: #5e81ac;
            font-size: 14px;
            transform: rotate(-10deg);
        }
        /* Write - Green square with + (new file) */
        .change-icon.write::before {
            background: rgba(129, 178, 154, 0.25);
            border: 2px solid #81b29a;
            border-radius: 4px;
        }
        .change-icon.write::after {
            content: '+';
            color: #81b29a;
            font-size: 16px;
            font-weight: bold;
        }
        /* Bash - Orange rounded square with > (terminal) */
        .change-icon.bash::before {
            background: rgba(242, 164, 93, 0.25);
            border: 2px solid #f2a45d;
            border-radius: 6px;
        }
        .change-icon.bash::after {
            content: '>';
            color: #f2a45d;
            font-family: monospace;
            font-size: 14px;
        }
        /* Read - Purple circle with dot (eye) */
        .change-icon.read::before {
            background: rgba(180, 142, 173, 0.25);
            border: 2px solid #b48ead;
            border-radius: 50%;
        }
        .change-icon.read::after {
            content: '•';
            color: #b48ead;
            font-size: 18px;
        }
        /* Error - Red circle with ! */
        .change-icon.error::before {
            background: rgba(231, 111, 81, 0.25);
            border: 2px solid #e76f51;
            border-radius: 50%;
        }
        .change-icon.error::after {
            content: '!';
            color: #e76f51;
            font-size: 14px;
        }
        .change-action {
            color: rgba(255,255,255,0.5);
            font-weight: 400;
        }
        [dir="rtl"] .change-action {
            margin-left: 4px;
        }
        [dir="ltr"] .change-action {
            margin-right: 4px;
        }
        .change-info {
            flex: 1;
            min-width: 0;
        }
        .change-name {
            font-size: 0.9rem;
            color: #fff;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .change-time {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
        }
        .change-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #888;
        }
        .change-badge.sensitive {
            background: rgba(231, 111, 81, 0.15);
            color: #e76f51;
        }
        .changes-footer {
            padding: 12px 18px;
            border-top: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        .changes-show-more {
            background: none;
            border: none;
            color: #5e81ac;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 4px 12px;
        }
        .changes-show-more:hover {
            text-decoration: underline;
        }

        /* ===== Technical Drawer ===== */
        .tech-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            max-width: 90vw;
            height: 100vh;
            background: rgba(22, 33, 62, 0.98);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .tech-drawer.open {
            right: 0;
        }
        .tech-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .tech-drawer-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .tech-drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tech-drawer-title {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
        }
        .tech-drawer-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        .tech-drawer-close:hover {
            color: #fff;
        }
        .tech-drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .drawer-section {
            margin-bottom: 20px;
        }
        .drawer-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .drawer-value {
            font-size: 0.9rem;
            color: #e0e0e0;
            word-break: break-all;
        }
        .drawer-value.mono {
            font-family: monospace;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.3);
            padding: 8px 12px;
            border-radius: 6px;
            color: #81b29a;
        }
        .drawer-action-btn {
            width: 100%;
            padding: 12px;
            background: rgba(94, 129, 172, 0.2);
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 8px;
            color: #5e81ac;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }
        .drawer-action-btn:hover {
            background: rgba(94, 129, 172, 0.3);
        }
        .drawer-action-btn.secondary {
            background: transparent;
            border-color: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.6);
        }
        .drawer-action-btn.secondary:hover {
            background: rgba(255,255,255,0.05);
            color: #fff;
        }
        .drawer-hero {
            padding: 16px;
            background: linear-gradient(135deg, rgba(94, 129, 172, 0.15) 0%, rgba(129, 178, 154, 0.1) 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .drawer-hero-text {
            font-size: 1rem;
            color: #e0e0e0;
            line-height: 1.5;
        }
        .drawer-hero-text strong {
            color: #fff;
        }
        .drawer-divider {
            height: 1px;
            background: rgba(255,255,255,0.08);
            margin: 20px 0;
        }
        .drawer-diff {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .diff-added {
            color: #81b29a;
            font-weight: 600;
            font-family: monospace;
            font-size: 0.95rem;
        }
        .diff-removed {
            color: #e76f51;
            font-weight: 600;
            font-family: monospace;
            font-size: 0.95rem;
        }
        .diff-label {
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
        }

        /* Activity Feed (keeping for browser errors) */
        .activity-feed {
            margin: 20px auto;
            max-width: 600px;
            padding: 0;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(30,30,40,0.9) 0%, rgba(20,20,30,0.95) 100%);
            border: 1px solid rgba(129, 178, 154, 0.2);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .activity-feed-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 20px;
            background: linear-gradient(90deg, rgba(129, 178, 154, 0.15) 0%, transparent 100%);
            border-bottom: 1px solid rgba(129, 178, 154, 0.2);
        }

        /* feed-icon styling is now in the icon section above */

        .activity-feed-title {
            font-weight: 700;
            font-size: 1rem;
            color: #fff;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .activity-feed.live .activity-feed-header {
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.2) 0%, rgba(129, 178, 154, 0.15) 50%, transparent 100%);
        }

        .activity-feed.live .feed-icon {
            animation: pulse-live 0.5s ease-in-out infinite;
        }

        @keyframes pulse-live {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.8; }
        }

        /* Glass-style action buttons */
        .glass-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            color: #888;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .glass-btn.danger:hover {
            background: rgba(231, 111, 81, 0.15);
            border-color: rgba(231, 111, 81, 0.3);
            color: #e76f51;
        }
        .refresh-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 5px 8px;
            border-radius: 8px;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .refresh-btn:hover {
            background: rgba(129, 178, 154, 0.15);
            border-color: rgba(129, 178, 154, 0.3);
            transform: rotate(180deg);
        }
        .refresh-btn.spinning {
            animation: spin 0.5s linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .clear-all-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 5px 8px;
            border-radius: 8px;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
            color: #888;
        }
        .clear-all-btn:hover {
            background: rgba(231, 111, 81, 0.15);
            border-color: rgba(231, 111, 81, 0.3);
            color: #e76f51;
        }

        /* Connection status indicator */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            backdrop-filter: blur(8px);
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 12px;
        }
        .connection-status.connected {
            border-color: rgba(129, 178, 154, 0.3);
        }
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        .connection-status.connected .connection-dot {
            background: #81b29a;
            box-shadow: 0 0 8px rgba(129, 178, 154, 0.5);
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .connection-time {
            color: #81b29a;
            font-weight: 500;
        }

        /* Quick Stats Bar */
        .quick-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .stat-item {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            backdrop-filter: blur(8px);
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #81b29a;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }
        .stat-item.errors .stat-value {
            color: #e76f51;
        }
        .stat-item.solutions .stat-value {
            color: #f2cc8f;
        }

        .activity-item-actions {
            display: inline-flex;
            gap: 2px;
            margin-left: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .activity-item:hover .activity-item-actions {
            opacity: 1;
        }
        .activity-item-edit,
        .activity-item-delete {
            cursor: pointer;
            font-size: 0.65rem;
            padding: 3px 6px;
            color: #666;
            border-radius: 6px;
            transition: all 0.15s;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(4px);
        }
        .activity-item-edit:hover {
            color: #81b29a;
            background: rgba(129, 178, 154, 0.15);
            border-color: rgba(129, 178, 154, 0.3);
        }
        .activity-item-delete:hover {
            color: #e76f51;
            background: rgba(231, 111, 81, 0.15);
            border-color: rgba(231, 111, 81, 0.3);
        }

        .activity-feed-badge {
            background: linear-gradient(135deg, #81b29a 0%, #5e9b7e 100%);
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
            box-shadow: 0 2px 8px rgba(129, 178, 154, 0.4);
        }

        .activity-feed-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 12px;
        }

        .activity-feed-list::-webkit-scrollbar {
            width: 6px;
        }

        .activity-feed-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }

        .activity-feed-list::-webkit-scrollbar-thumb {
            background: rgba(129, 178, 154, 0.3);
            border-radius: 3px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .activity-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(129, 178, 154, 0.2);
            transform: translateX(4px);
        }

        .activity-item.latest {
            background: linear-gradient(90deg, rgba(129, 178, 154, 0.15) 0%, rgba(129, 178, 154, 0.05) 100%);
            border: 1px solid rgba(129, 178, 154, 0.3);
            animation: pulse-latest 2s ease-in-out infinite;
        }

        @keyframes pulse-latest {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(129, 178, 154, 0.4);
                border-color: rgba(129, 178, 154, 0.3);
            }
            50% {
                box-shadow: 0 0 20px 2px rgba(129, 178, 154, 0.2);
                border-color: rgba(129, 178, 154, 0.5);
            }
        }

        .activity-item.latest .icon-dot {
            animation: bounce-icon 1s ease-in-out infinite;
        }

        @keyframes bounce-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .activity-item .icon-dot {
            flex-shrink: 0;
        }

        .activity-item-name {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .activity-item-name-main {
            color: #fff;
            font-weight: 500;
        }

        .activity-item-name-tech {
            color: #666;
            font-size: 0.7rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .activity-item.latest .activity-item-name-main {
            color: #81b29a;
        }

        .activity-item.latest .activity-item-name-tech {
            color: #5e9b7e;
        }

        .activity-item-time {
            color: #888;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.05);
            padding: 3px 8px;
            border-radius: 6px;
        }

        .activity-item.latest .activity-item-time {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        /* Dimmed items (other projects) */
        .activity-item.dimmed {
            opacity: 0.45;
        }
        .activity-item.dimmed:hover {
            opacity: 0.7;
        }
        .activity-item.dimmed .activity-item-name-main {
            color: #888;
        }

        /* Project tag */
        .activity-item-project {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
            color: #666;
            margin-left: 6px;
            white-space: nowrap;
        }
        .activity-item.current-project .activity-item-project {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        /* Tool/Source badge */
        .activity-item-tool {
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 3px;
            background: rgba(100,100,100,0.3);
            color: #999;
            margin-left: 4px;
            white-space: nowrap;
            font-weight: 500;
        }
        .activity-item-tool.claude {
            background: rgba(217, 143, 100, 0.25);
            color: #d98f64;
        }
        .activity-item-tool.cursor {
            background: rgba(100, 149, 237, 0.25);
            color: #6495ed;
        }
        .activity-item-tool.watcher {
            background: rgba(150, 150, 150, 0.2);
            color: #888;
        }

        /* Solution badge */
        .solution-badge {
            font-size: 0.6rem;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(129, 178, 154, 0.15);
            border: 1px solid rgba(129, 178, 154, 0.3);
            color: #81b29a;
            margin-left: 4px;
            white-space: nowrap;
            font-weight: 500;
        }
        .solution-badge::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #81b29a;
            border-radius: 50%;
            margin-right: 4px;
        }
        /* Error source tag */
        .error-source {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(100, 149, 237, 0.2);
            color: #6495ed;
            margin-left: 4px;
            white-space: nowrap;
            font-weight: 500;
        }
        .activity-item.has-solution {
            border-left: 2px solid #81b29a;
        }

        /* Browser errors feed styling */
        .browser-errors-feed {
            border-top: 1px solid rgba(231, 111, 81, 0.2);
            margin-top: 8px;
        }
        .browser-errors-feed .activity-feed-header {
            background: rgba(231, 111, 81, 0.05);
            flex-wrap: wrap;
        }
        .browser-errors-feed .changes-filter {
            margin-left: auto;
            margin-right: 8px;
        }
        [dir="rtl"] .browser-errors-feed .changes-filter {
            margin-left: 8px;
            margin-right: auto;
        }
        .browser-errors-feed .activity-item {
            animation: none !important;
            transition: opacity 0.2s;
        }
        .browser-errors-feed .activity-feed-list {
            max-height: 200px;
            overflow-y: auto;
        }

        /* File path link */
        .activity-item-path {
            display: block;
            font-size: 0.65rem;
            color: #555;
            text-decoration: none;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 280px;
            transition: color 0.2s;
        }
        .activity-item-path:hover {
            color: #81b29a;
            text-decoration: underline;
        }

        .activity-empty {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 0.9rem;
        }

        .activity-empty::before {
            content: '💤';
            display: block;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Component Mapping Modal */
        .mapping-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mapping-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .mapping-modal-content {
            background: linear-gradient(135deg, #1e1e2e 0%, #141420 100%);
            border: 1px solid rgba(129, 178, 154, 0.3);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .mapping-modal.open .mapping-modal-content {
            transform: scale(1);
        }

        .mapping-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #fff;
        }

        .mapping-modal-file {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 16px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            word-break: break-all;
        }

        .mapping-modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(129, 178, 154, 0.3);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 16px;
            direction: rtl;
        }

        .mapping-modal-input:focus {
            outline: none;
            border-color: #81b29a;
        }

        .mapping-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .mapping-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .mapping-modal-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .mapping-modal-btn.save {
            background: linear-gradient(135deg, #81b29a 0%, #5e9b7e 100%);
            color: #fff;
        }

        .mapping-modal-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .activity-item {
            animation: slideIn 0.4s ease;
        }

        /* Hide old elements */
        .old-ui-hidden {
            display: none !important;
        }

        /* ===== CTA BUTTON ===== */
        .cta-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 20px;
            margin: 12px 0;
            background: rgba(94, 129, 172, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .cta-btn:hover {
            background: rgba(94, 129, 172, 0.3);
            border-color: rgba(94, 129, 172, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* ===== SECTION ===== */
        .section {
            margin-top: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .section-header .insights-filter {
            margin-left: auto;
            margin-right: 8px;
        }
        [dir="rtl"] .section-header .insights-filter {
            margin-left: 8px;
            margin-right: auto;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .section-count {
            font-size: 0.7rem;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #888;
            border-radius: 8px;
        }

        .clear-btn {
            font-size: 0.7rem;
            padding: 2px 8px;
            background: transparent;
            border: 1px solid rgba(231, 111, 81, 0.3);
            color: #e76f51;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(231, 111, 81, 0.15);
        }

        /* ===== FILTER/SORT CONTROLS ===== */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .filter-select {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(94, 129, 172, 0.3);
            color: #5e81ac;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            flex: 1;
            transition: all 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235e81ac' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }

        .filter-select:hover {
            background-color: rgba(94, 129, 172, 0.15);
            border-color: rgba(94, 129, 172, 0.5);
        }

        .filter-select option {
            background: #1a1a2e;
            color: #ccc;
            padding: 8px;
        }

        /* ===== SOLUTION CARD DELETE ===== */
        .solution-card {
            position: relative;
        }

        .solution-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border: none;
            background: rgba(231, 111, 81, 0.2);
            color: #e76f51;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .solution-card:hover .solution-delete {
            opacity: 1;
        }

        .solution-delete:hover {
            background: rgba(231, 111, 81, 0.4);
        }

        .history-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .clear-history-btn {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: transparent;
            border: 1px solid rgba(231, 111, 81, 0.3);
            color: #e76f51;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-history-btn:hover {
            background: rgba(231, 111, 81, 0.15);
        }

        /* ===== ISSUE CARD ===== */
        .issue-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .issue-card:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .issue-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .issue-dot.critical { background: #e76f51; }
        .issue-dot.error { background: #f4a261; }
        .issue-dot.warning { background: #f2cc8f; }

        .issue-content {
            flex: 1;
            min-width: 0;
        }

        .issue-message {
            font-size: 0.85rem;
            color: #d0d0d0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .issue-meta {
            font-size: 0.7rem;
            color: #555;
            margin-top: 3px;
        }

        .issue-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.05);
            color: #888;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .issue-badge.count {
            color: #e76f51;
            background: rgba(231, 111, 81, 0.15);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #555;
            font-size: 0.85rem;
        }

        /* ===== FOOTER ===== */
        .footer {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.04);
        }

        .footer-link {
            font-size: 0.75rem;
            color: #555;
            cursor: pointer;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: #888;
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            width: 90%;
            max-width: 360px;
            background: rgba(26, 26, 46, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 20px;
            text-align: center;
        }

        /* New Project Prompt */
        .new-project-prompt {
            text-align: center;
            padding: 8px 0;
            line-height: 1.6;
        }
        .new-project-prompt strong {
            color: #81b29a;
        }

        .editor-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .editor-option:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
        }

        .editor-name {
            font-size: 0.9rem;
            color: #d0d0d0;
        }

        .editor-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
            color: #666;
        }

        .editor-badge.ready {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .setup-btn {
            font-size: 0.6rem;
            padding: 3px 8px;
            background: rgba(94, 129, 172, 0.2);
            border: 1px solid rgba(94, 129, 172, 0.3);
            color: #5e81ac;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-btn:hover {
            background: rgba(94, 129, 172, 0.4);
        }

        .modal-hint {
            margin-top: 16px;
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            line-height: 1.5;
        }

        .usage-tip {
            margin-top: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(94, 129, 172, 0.15), rgba(129, 178, 154, 0.1));
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 12px;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .usage-tip-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .usage-tip-text {
            font-size: 0.75rem;
            color: #aaa;
            margin: 4px 0;
        }

        .usage-tip-command {
            display: inline-block;
            margin: 10px 0;
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(94, 129, 172, 0.5);
            border-radius: 8px;
            font-family: monospace;
            font-size: 1rem;
            color: #5e81ac;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .modal-close {
            display: block;
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            background: transparent;
            border: none;
            color: #555;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* ===== INPUT FIELDS ===== */
        .field {
            margin-bottom: 12px;
        }

        .field label {
            display: block;
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field input, .field textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.85rem;
        }

        .field input:focus, .field textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .field textarea {
            height: 80px;
            resize: none;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888;
        }

        /* ===== DETAIL MODAL ===== */
        .detail-modal {
            max-height: 80vh;
            overflow-y: auto;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .detail-type {
            font-size: 0.75rem;
            font-weight: 600;
            color: #e76f51;
            padding: 4px 10px;
            background: rgba(231, 111, 81, 0.15);
            border-radius: 6px;
        }

        .detail-close {
            background: none;
            border: none;
            color: #555;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .detail-message {
            font-size: 0.85rem;
            color: #d0d0d0;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 12px;
            word-break: break-word;
            direction: ltr;
            text-align: left;
        }

        .detail-location {
            font-size: 0.7rem;
            color: #555;
            margin-bottom: 16px;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section-title {
            font-size: 0.7rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            line-height: 1.6;
            overflow-x: auto;
        }

        .code-line {
            white-space: pre;
            color: #888;
        }

        .code-line.error {
            background: rgba(231, 111, 81, 0.15);
            color: #e76f51;
            margin: 0 -12px;
            padding: 0 12px;
        }

        .vars-list {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px 12px;
        }

        .var-row {
            display: flex;
            font-size: 0.75rem;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .var-row:last-child {
            border-bottom: none;
        }

        .var-name {
            color: #888;
            font-family: monospace;
            min-width: 80px;
        }

        .var-value {
            color: #81b29a;
            font-family: monospace;
            word-break: break-all;
        }

        /* ===== HISTORY PANEL ===== */
        .history-panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 60vh;
            background: rgba(22, 33, 62, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
        }

        .history-panel.open {
            display: block;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .history-close {
            background: none;
            border: none;
            color: #555;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .solution-card {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(129, 178, 154, 0.1);
            border: 1px solid rgba(129, 178, 154, 0.2);
            border-radius: 10px;
        }

        .solution-problem {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }

        .solution-fix {
            font-size: 0.8rem;
            color: #81b29a;
        }

        /* ===== NEW ERROR ANIMATION ===== */
        @keyframes pulse-error {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 111, 81, 0.4); }
            50% { box-shadow: 0 0 20px 10px rgba(231, 111, 81, 0.2); }
        }

        .issue-card.new-error {
            animation: pulse-error 1s ease-in-out 3;
            border: 1px solid rgba(231, 111, 81, 0.5);
        }

        .status-bar.new-error {
            animation: pulse-error 1s ease-in-out 3;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(231, 111, 81, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== SERVER CONNECT ===== */
        .server-connect {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            margin: 12px 0;
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .server-icon {
            font-size: 1.5rem;
        }

        .server-details {
            display: flex;
            flex-direction: column;
        }

        .server-label {
            font-size: 0.7rem;
            color: #666;
        }

        .server-url {
            font-size: 0.9rem;
            color: #e0e0e0;
            font-weight: 500;
        }

        .connect-btn {
            padding: 8px 16px;
            background: rgba(129, 178, 154, 0.2);
            border: 1px solid rgba(129, 178, 154, 0.3);
            border-radius: 8px;
            color: #81b29a;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connect-btn:hover {
            background: rgba(129, 178, 154, 0.3);
        }

        .connect-btn.connected {
            background: rgba(129, 178, 154, 0.15);
            border-color: rgba(129, 178, 154, 0.2);
            color: #81b29a;
            cursor: default;
        }

        .connect-btn.connected::before {
            content: '✓ ';
        }

        /* ===== AI MEMORY SECTION ===== */
        .memory-section {
            margin-top: 20px;
        }

        .memory-health {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 12px;
        }

        .memory-health-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .memory-health-icon {
            font-size: 1.2rem;
        }

        .memory-health-info {
            display: flex;
            flex-direction: column;
        }

        .memory-health-title {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .memory-health-status {
            font-size: 0.85rem;
            color: #e0e0e0;
            font-weight: 500;
        }

        .memory-health-bar {
            width: 60px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .memory-health-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s, background 0.3s;
        }

        .memory-health-fill.low { background: #81b29a; }
        .memory-health-fill.medium { background: #f2cc8f; }
        .memory-health-fill.high { background: #e76f51; }

        /* Handover Card */
        .handover-card {
            padding: 14px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 3px solid #5e81ac;
        }

        .handover-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .handover-title {
            font-size: 0.75rem;
            color: #5e81ac;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .handover-time {
            font-size: 0.7rem;
            color: #555;
        }

        .handover-content {
            font-size: 0.85rem;
            color: #d0d0d0;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .handover-empty {
            color: #555;
            font-style: italic;
        }

        .handover-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .handover-btn {
            font-size: 0.7rem;
            padding: 4px 10px;
            background: transparent;
            border: 1px solid rgba(94, 129, 172, 0.3);
            color: #5e81ac;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .handover-btn:hover {
            background: rgba(94, 129, 172, 0.15);
        }

        .handover-btn.copy {
            border-color: rgba(129, 178, 154, 0.3);
            color: #81b29a;
        }

        .handover-btn.copy:hover {
            background: rgba(129, 178, 154, 0.15);
        }

        /* ROI Card */
        .roi-card {
            padding: 14px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(129, 178, 154, 0.1), rgba(94, 129, 172, 0.1));
            border: 1px solid rgba(129, 178, 154, 0.2);
        }

        .roi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .roi-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #81b29a;
        }

        .roi-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            background: rgba(129, 178, 154, 0.2);
            border-radius: 10px;
            color: #81b29a;
        }

        .roi-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .roi-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .roi-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e0e0e0;
            line-height: 1;
        }

        .roi-label {
            font-size: 0.65rem;
            color: #666;
            margin-top: 4px;
        }

        .roi-insight {
            margin-top: 12px;
            padding: 8px 10px;
            background: rgba(129, 178, 154, 0.1);
            border-radius: 8px;
            font-size: 0.75rem;
            color: #81b29a;
            text-align: center;
            display: none;
        }

        .roi-insight.show {
            display: block;
        }

        /* Memory Cards (Decisions, Avoid) */
        .memory-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .memory-card {
            padding: 12px 14px;
            border-radius: 10px;
            position: relative;
        }

        .memory-card.decision {
            background: rgba(129, 178, 154, 0.1);
            border: 1px solid rgba(129, 178, 154, 0.2);
        }

        .memory-card.avoid {
            background: rgba(231, 111, 81, 0.1);
            border: 1px solid rgba(231, 111, 81, 0.2);
        }

        .memory-card.lesson {
            background: rgba(94, 129, 172, 0.1);
            border: 1px solid rgba(94, 129, 172, 0.2);
        }

        .memory-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .memory-card-title {
            font-size: 0.85rem;
            color: #e0e0e0;
            font-weight: 500;
            flex: 1;
        }

        .memory-card-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .memory-card-badge.used {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .memory-card-badge.unused {
            background: rgba(255, 255, 255, 0.05);
            color: #666;
        }

        .memory-card-project {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(94, 129, 172, 0.2);
            color: #5e81ac;
            margin-left: 8px;
            white-space: nowrap;
        }
        [dir="rtl"] .memory-card-project {
            margin-left: 0;
            margin-right: 8px;
        }

        .memory-card-reason {
            font-size: 0.75rem;
            color: #888;
        }

        .memory-card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 18px;
            height: 18px;
            border: none;
            background: rgba(231, 111, 81, 0.2);
            color: #e76f51;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .memory-card:hover .memory-card-delete {
            opacity: 1;
        }

        .memory-card-delete:hover {
            background: rgba(231, 111, 81, 0.4);
        }

        /* Add Memory Button */
        .add-memory-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #555;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-memory-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
            color: #888;
        }

        /* Empty Memory State */
        .memory-empty {
            text-align: center;
            padding: 20px;
            color: #555;
            font-size: 0.8rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.04);
        }

        .quick-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            color: #888;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #ccc;
        }

        .quick-action-btn.primary {
            background: rgba(94, 129, 172, 0.15);
            border-color: rgba(94, 129, 172, 0.3);
            color: #5e81ac;
        }

        .quick-action-btn.primary:hover {
            background: rgba(94, 129, 172, 0.25);
        }

        /* Collapsible sections */
        .section-toggle {
            cursor: pointer;
            user-select: none;
        }

        .section-toggle .toggle-icon {
            transition: transform 0.2s;
        }

        .section-toggle.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .section-content.collapsed {
            display: none;
        }

        /* ===== SAFETY SWITCH ===== */
        .safety-section {
            margin-top: 20px;
        }

        .safety-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
        }

        .safety-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .safety-icon {
            font-size: 1.2rem;
        }

        .safety-info {
            display: flex;
            flex-direction: column;
        }

        .safety-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .safety-status {
            font-size: 0.7rem;
            color: #81b29a;
        }

        .safety-status.off {
            color: #e76f51;
        }

        .safety-toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .safety-toggle.on {
            background: rgba(129, 178, 154, 0.4);
        }

        .safety-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #666;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .safety-toggle.on::after {
            left: 25px;
            background: #81b29a;
        }

        .pending-changes {
            margin-top: 12px;
        }

        .pending-card {
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: rgba(242, 204, 143, 0.1);
            border: 1px solid rgba(242, 204, 143, 0.2);
        }

        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .pending-file {
            font-size: 0.8rem;
            font-weight: 500;
            color: #f2cc8f;
            font-family: monospace;
        }

        .pending-status {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(242, 204, 143, 0.2);
            color: #f2cc8f;
        }

        .pending-status.approved {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .pending-desc {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 10px;
        }

        .pending-actions {
            display: flex;
            gap: 8px;
        }

        .pending-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pending-btn.approve {
            background: rgba(129, 178, 154, 0.2);
            border: 1px solid rgba(129, 178, 154, 0.3);
            color: #81b29a;
        }

        .pending-btn.approve:hover {
            background: rgba(129, 178, 154, 0.3);
        }

        .pending-btn.reject {
            background: rgba(231, 111, 81, 0.2);
            border: 1px solid rgba(231, 111, 81, 0.3);
            color: #e76f51;
        }

        .pending-btn.reject:hover {
            background: rgba(231, 111, 81, 0.3);
        }

        .pending-btn.preview {
            background: rgba(94, 129, 172, 0.2);
            border: 1px solid rgba(94, 129, 172, 0.3);
            color: #5e81ac;
        }

        .pending-btn.preview:hover {
            background: rgba(94, 129, 172, 0.3);
        }

        .change-history-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #555;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .change-history-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            color: #888;
        }

        /* Diff Viewer Modal */
        .diff-modal {
            max-width: 600px;
            max-height: 80vh;
        }

        .diff-viewer {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.7rem;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .diff-line {
            white-space: pre;
        }

        .diff-line.add {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .diff-line.remove {
            background: rgba(231, 111, 81, 0.2);
            color: #e76f51;
        }

        .diff-line.header {
            color: #5e81ac;
            font-weight: 600;
        }

        .diff-line.context {
            color: #666;
        }

        /* Change History Panel */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .history-item-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .history-item-file {
            font-size: 0.75rem;
            color: #ccc;
            font-family: monospace;
        }

        .history-item-desc {
            font-size: 0.7rem;
            color: #666;
        }

        .history-item-status {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .history-item-status.applied {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }

        .history-item-status.undone {
            background: rgba(94, 129, 172, 0.2);
            color: #5e81ac;
        }

        .history-item-status.rejected {
            background: rgba(231, 111, 81, 0.2);
            color: #e76f51;
        }

        .undo-btn {
            padding: 6px 12px;
            font-size: 0.7rem;
            background: rgba(94, 129, 172, 0.2);
            border: 1px solid rgba(94, 129, 172, 0.3);
            color: #5e81ac;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .undo-btn:hover {
            background: rgba(94, 129, 172, 0.3);
        }

        .no-pending {
            text-align: center;
            padding: 20px;
            color: #555;
            font-size: 0.8rem;
        }

        /* ===== SIMPLIFIED SESSION MODAL ===== */
        .session-option {
            padding: 12px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .session-option:hover {
            background: rgba(255, 255, 255, 0.12);
        }
        .session-option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .session-option-name {
            font-size: 0.95rem;
            font-weight: 500;
            color: #fff;
        }
        .session-option-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #888;
        }
        .session-option-badge.connected {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
        }
        .session-option-hint {
            font-size: 0.75rem;
            color: #666;
        }
        .session-extension {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #666;
            padding: 12px 0;
            margin-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .session-extension-btn {
            padding: 4px 12px;
            background: rgba(94, 129, 172, 0.2);
            border: 1px solid rgba(94, 129, 172, 0.3);
            border-radius: 6px;
            color: #5e81ac;
            text-decoration: none;
            font-size: 0.7rem;
        }
        .session-extension-btn:hover {
            background: rgba(94, 129, 172, 0.3);
        }

        /* ===== EDITOR CARDS IN MODAL (legacy) ===== */
        .editor-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .editor-hint {
            font-size: 0.75rem;
            color: #888;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .editor-hint strong {
            color: #81b29a;
        }

        .copy-prompt-btn {
            width: 100%;
            margin-top: 8px;
            padding: 10px;
            background: linear-gradient(135deg, #5e81ac 0%, #81b29a 100%);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-prompt-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(94, 129, 172, 0.3);
        }

        .copy-prompt-btn.copied {
            background: linear-gradient(135deg, #81b29a 0%, #81b29a 100%);
        }

        /* Cursor Commands */
        .cursor-mcp-note {
            font-size: 0.7rem;
            color: #888;
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(100, 149, 237, 0.1);
            border-radius: 6px;
            direction: rtl;
        }
        .cursor-commands {
            margin-top: 10px;
        }
        .cursor-cmd {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            direction: rtl;
        }
        .cursor-cmd:first-child {
            border-top: none;
        }
        .cursor-cmd-label {
            font-size: 0.7rem;
            color: #888;
            min-width: 60px;
        }
        .cursor-cmd-text {
            flex: 1;
            font-size: 0.75rem;
            color: #81b29a;
            background: rgba(0,0,0,0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        .cursor-cmd-copy {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
            padding: 4px;
        }
        .cursor-cmd-copy:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Chrome Extension Card */
        .extension-card {
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.1), rgba(52, 168, 83, 0.08));
            border: 1px solid rgba(66, 133, 244, 0.2);
            border-radius: 12px;
            text-align: center;
        }
        .extension-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .extension-icon {
            font-size: 1.2rem;
        }
        .extension-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e0e0e0;
        }
        .extension-desc {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 12px;
            direction: rtl;
        }
        .extension-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4285f4, #34a853);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .extension-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        .chrome-icon {
            width: 18px;
            height: 18px;
        }

        /* ===== PORT DETECTION ===== */
        .port-detected {
            display: none;
            margin: 12px 0;
            padding: 12px 16px;
            background: rgba(242, 204, 143, 0.1);
            border: 1px solid rgba(242, 204, 143, 0.3);
            border-radius: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .port-detected.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .port-detected-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .port-detected-icon {
            font-size: 1.2rem;
        }

        .port-detected-text {
            font-size: 0.85rem;
            color: #f2cc8f;
        }

        .port-detected-url {
            font-weight: 600;
            color: #fff;
        }

        .port-connect-btn {
            padding: 8px 16px;
            background: rgba(129, 178, 154, 0.2);
            border: 1px solid rgba(129, 178, 154, 0.4);
            border-radius: 8px;
            color: #81b29a;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .port-connect-btn:hover {
            background: rgba(129, 178, 154, 0.3);
            transform: translateY(-1px);
        }

        .port-dismiss-btn {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .port-dismiss-btn:hover {
            opacity: 1;
        }

        /* ===== WELCOME MODAL ===== */
        .welcome-modal {
            max-width: 400px;
            text-align: center;
        }

        .welcome-header {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            color: #888;
            margin-bottom: 24px;
        }

        .welcome-steps {
            text-align: left;
            margin-bottom: 24px;
        }

        .welcome-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 3px solid #81b29a;
        }

        .welcome-step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #81b29a 0%, #6a9e87 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #0a0a12;
            flex-shrink: 0;
        }

        .welcome-step-content {
            flex: 1;
        }

        .welcome-step-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .welcome-step-desc {
            font-size: 0.85rem;
            color: #888;
        }

        .welcome-test-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #81b29a 0%, #6a9e87 100%);
            border: none;
            border-radius: 10px;
            color: #0a0a12;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .welcome-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(129, 178, 154, 0.3);
        }

        .welcome-skip {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .welcome-skip:hover {
            color: #999;
        }

        .test-result {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .test-result.success {
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
            display: block;
        }

        .test-result.error {
            background: rgba(231, 111, 81, 0.2);
            color: #e76f51;
            display: block;
        }

        /* ===== ROI WIDGET ===== */
        .roi-widget {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .roi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .roi-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .roi-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            background: rgba(129, 178, 154, 0.2);
            color: #81b29a;
            border-radius: 4px;
        }

        .roi-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .roi-stat {
            text-align: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .roi-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #81b29a;
        }

        .roi-stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }

        .roi-stat.highlight .roi-stat-value {
            color: #ffd93d;
        }

    </style>
</head>
<body>
    <div class="toast" id="toast"></div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">
                <span class="logo-text">Fix<span class="logo-o">O</span>nce</span>
            </div>
            <div class="header-center">
                <div class="project-name" id="project-name" onclick="openProjectSwitcher()">My Project</div>
            </div>
            <div class="header-actions">
                <button class="glass-btn" onclick="refreshAll()" title="Refresh">
                    <span class="icon-refresh"></span>
                </button>
            </div>
        </div>

        <!-- CONNECTION STATUS -->
        <div class="connection-status" id="connection-status">
            <span class="connection-dot"></span>
            <span id="connection-text">Connecting...</span>
            <span class="connection-time" id="connection-time"></span>
        </div>

        <!-- QUICK STATS -->
        <div class="quick-stats">
            <div class="stat-item errors">
                <div class="stat-value" id="stat-errors">0</div>
                <div class="stat-label">Open Errors</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-fixed">0</div>
                <div class="stat-label">Fixed</div>
            </div>
            <div class="stat-item solutions">
                <div class="stat-value" id="stat-solutions">0</div>
                <div class="stat-label">Saved Solutions</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-insights">0</div>
                <div class="stat-label">Insights</div>
            </div>
        </div>

        <!-- HERO CARD (Focus Mode - Phase 1) -->
        <div class="hero-card" id="hero-card">
            <div class="hero-status" id="hero-status">
                <span class="hero-status-dot"></span>
                <span id="hero-status-text">AI MEMORY ACTIVE</span>
                <span class="live-badge" id="live-badge">LIVE</span>
            </div>
            <div class="sync-counter" id="sync-counter" title="הזרקות ידע: כמה פעמים Claude השתמש בזיכרון (פתרונות, החלטות, הקשר)">
                <span class="sync-icon">⚡</span>
                <span class="sync-value" id="sync-value">0</span>
                <span class="sync-label">syncs</span>
            </div>
            <div class="hero-project-name" id="hero-project-name">Loading...</div>
            <div class="hero-project-meta" id="hero-project-meta">
                <span id="hero-stack"></span>
                <span id="hero-path"></span>
            </div>
            <div class="hero-goal" id="hero-goal" style="display: none;">
                <div class="hero-goal-header">
                    <span class="hero-goal-label">🎯 Current Goal</span>
                    <span class="hero-goal-time" id="hero-goal-time"></span>
                </div>
                <div class="hero-goal-text" id="hero-goal-text"></div>
                <div class="hero-goal-history" id="hero-goal-history" style="display: none;">
                    <div class="goal-history-label">Previous:</div>
                    <div class="goal-history-list" id="goal-history-list"></div>
                </div>
            </div>
            <div class="hero-stats" id="hero-stats">
                <div class="hero-stat errors">
                    <span>⚠️</span>
                    <span class="hero-stat-value" id="hero-errors">0</span>
                    <span>שגיאות</span>
                </div>
                <div class="hero-stat insights clickable" onclick="openInsightsModal('insights')">
                    <span>💡</span>
                    <span class="hero-stat-value" id="hero-insights">0</span>
                    <span>תובנות</span>
                </div>
                <div class="hero-stat decisions clickable" onclick="openInsightsModal('decisions')">
                    <span>📌</span>
                    <span class="hero-stat-value" id="hero-decisions">0</span>
                    <span>החלטות</span>
                </div>
            </div>

            <!-- ROI Widget - Value Proof -->
            <div class="roi-widget" id="roi-widget">
                <div class="roi-header">
                    <span class="roi-title">📊 Your AI Memory Value</span>
                    <span class="roi-badge" id="roi-badge">Today</span>
                </div>
                <div class="roi-stats">
                    <div class="roi-stat highlight">
                        <div class="roi-stat-value" id="roi-syncs">0</div>
                        <div class="roi-stat-label">Memory Syncs</div>
                    </div>
                    <div class="roi-stat">
                        <div class="roi-stat-value" id="roi-solutions">0</div>
                        <div class="roi-stat-label">Solutions Reused</div>
                    </div>
                    <div class="roi-stat">
                        <div class="roi-stat-value" id="roi-time">0</div>
                        <div class="roi-stat-label">Minutes Saved</div>
                    </div>
                    <div class="roi-stat">
                        <div class="roi-stat-value" id="roi-prevented">0</div>
                        <div class="roi-stat-label">Errors Prevented</div>
                    </div>
                </div>
            </div>

            <!-- Protocol Compliance Widget -->
            <div class="compliance-widget" id="compliance-widget" style="display: none;">
                <div class="compliance-header">
                    <span class="compliance-title">Protocol Compliance</span>
                    <span class="compliance-status" id="compliance-status">-</span>
                </div>
                <div class="compliance-items" id="compliance-items">
                    <div class="compliance-item" id="comp-session">
                        <span class="icon">-</span>
                        <span>Session initialized</span>
                    </div>
                    <div class="compliance-item" id="comp-decisions">
                        <span class="icon">-</span>
                        <span>Decisions displayed</span>
                    </div>
                    <div class="compliance-item" id="comp-goal">
                        <span class="icon">-</span>
                        <span>Goal updated</span>
                    </div>
                </div>
            </div>

            <button class="hero-btn" id="hero-btn" onclick="openSessionModal()">
                <span class="hero-btn-icon">🧠</span>
                <span id="hero-btn-text">Start AI Session</span>
            </button>
        </div>

        <!-- Hidden: Port Detection (auto-connect now) -->
        <div class="port-detected" id="port-detected" style="display: none;">
            <div class="port-detected-info">
                <span class="port-detected-icon">🔍</span>
                <span class="port-detected-text">
                    <span id="port-detected-label">Detected:</span>
                    <span class="port-detected-url" id="port-detected-url">localhost:3000</span>
                </span>
            </div>
        </div>

        <!-- Legacy: Hidden for backward compatibility -->
        <div id="live-state" style="display:none;">
            <div id="live-state-status"><span id="live-state-status-text"></span></div>
            <div id="live-state-context"></div>
            <div id="live-state-path"></div>
            <div id="live-state-arch"><span id="live-state-arch-text"></span></div>
            <div id="live-state-main"><span id="live-state-goal"></span></div>
            <div id="live-state-insight"><div id="live-state-insight-text"></div></div>
        </div>

        <!-- Component Mapping Modal -->
        <div class="mapping-modal" id="mapping-modal" onclick="closeMappingModal(event)">
            <div class="mapping-modal-content" onclick="event.stopPropagation()">
                <div class="mapping-modal-title">Edit Component Name</div>
                <div class="mapping-modal-file" id="mapping-file"></div>
                <input type="text" class="mapping-modal-input" id="mapping-input" placeholder="Enter name...">
                <div class="mapping-modal-buttons">
                    <button class="mapping-modal-btn cancel" onclick="closeMappingModal()">Cancel</button>
                    <button class="mapping-modal-btn save" onclick="saveMapping()">Save</button>
                </div>
            </div>
        </div>

        <!-- Activity Feed (Human UI) -->
        <div class="changes-card glass" id="changes-card">
            <div class="changes-header">
                <div class="changes-header-left">
                    <span class="changes-title" id="changes-title">📋 Activity</span>
                    <span class="changes-count" id="changes-count">0</span>
                </div>
                <div class="changes-filter" id="changes-filter">
                    <button class="filter-btn" data-filter="all" onclick="setActivityFilter('all')">הכל</button>
                    <button class="filter-btn active" data-filter="project" onclick="setActivityFilter('project')">פרויקט נוכחי</button>
                </div>
            </div>
            <!-- מקרא סימונים (לחיץ לסינון) -->
            <div class="changes-legend" id="changes-legend">
                <span class="legend-item active" data-type="all" onclick="setTypeFilter('all')" title="הכל">✱</span>
                <span class="legend-item" data-type="edit" onclick="setTypeFilter('edit')" title="עריכה"><span class="legend-icon edit"></span></span>
                <span class="legend-item" data-type="write" onclick="setTypeFilter('write')" title="יצירה"><span class="legend-icon write"></span></span>
                <span class="legend-item" data-type="bash" onclick="setTypeFilter('bash')" title="פקודה"><span class="legend-icon bash"></span></span>
                <span class="legend-item" data-type="read" onclick="setTypeFilter('read')" title="קריאה"><span class="legend-icon read"></span></span>
                <span class="legend-item" data-type="error" onclick="setTypeFilter('error')" title="שגיאה"><span class="legend-icon error"></span></span>
                <span class="legend-item" data-type="insight" onclick="setTypeFilter('insight')" title="תובנה"><span class="legend-icon insight"></span></span>
                <span class="legend-item" data-type="decision" onclick="setTypeFilter('decision')" title="החלטה"><span class="legend-icon decision"></span></span>
            </div>
            <div class="changes-list" id="changes-list">
                <div class="changes-empty" id="changes-empty">
                    אין שינויים היום
                </div>
            </div>
            <div class="changes-footer" id="changes-footer" style="display:none;">
                <button class="changes-show-more" id="show-more-btn" onclick="loadMoreChanges()">
                    הצג עוד
                </button>
            </div>
        </div>

        <!-- Technical Drawer (slides from right) -->
        <div class="tech-drawer" id="tech-drawer">
            <div class="tech-drawer-header">
                <span class="tech-drawer-title" id="drawer-title">Technical Details</span>
                <button class="tech-drawer-close" onclick="closeDrawer()">×</button>
            </div>
            <div class="tech-drawer-content" id="drawer-content">
                <!-- Populated dynamically -->
            </div>
        </div>
        <div class="tech-drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>

        <!-- Browser Errors Feed -->
        <div class="activity-feed browser-errors-feed" id="browser-errors-feed">
            <div class="activity-feed-header">
                <span class="feed-icon error"></span>
                <span class="activity-feed-title">Errors</span>
                <span class="activity-feed-badge" id="browser-errors-count">0</span>
                <div class="changes-filter" id="errors-filter">
                    <button class="filter-btn active" data-filter="all" onclick="setErrorsFilter('all')">All</button>
                    <button class="filter-btn" data-filter="project" onclick="setErrorsFilter('project')">Project</button>
                </div>
                <button class="glass-btn small" onclick="loadBrowserErrors()" title="Refresh">
                    <span class="icon-refresh"></span>
                </button>
                <button class="glass-btn small danger" onclick="clearBrowserErrors()" title="Clear">×</button>
            </div>
            <div class="activity-feed-list" id="browser-errors-list">
                <div class="activity-empty" id="browser-errors-empty">
                    No errors<br>Errors from the extension will appear here
                </div>
            </div>
        </div>

        <!-- OLD STATUS (hidden) -->
        <div class="status-bar clear old-ui-hidden" id="status-bar">
            <span class="status-dot"></span>
            <span id="status-text">All Clear</span>
        </div>

        <!-- SERVER CONNECTION (hidden) -->
        <div class="server-connect glass old-ui-hidden" id="server-connect">
            <div class="server-info">
                <span class="server-icon">🌐</span>
                <div class="server-details">
                    <div class="server-label" id="server-label">You're working on:</div>
                    <div class="server-url" id="server-url">localhost:3000</div>
                </div>
            </div>
            <button class="connect-btn" id="connect-btn" onclick="connectServer()">Connect</button>
        </div>

        <!-- CTA (hidden) -->
        <button class="cta-btn old-ui-hidden" onclick="openSessionModal()">
            <span id="cta-text">Start AI Session</span>
        </button>

        <!-- AI MEMORY SECTION -->
        <div class="memory-section">
            <!-- Memory Health (hidden) -->
            <div class="memory-health glass old-ui-hidden" id="memory-health">
                <div class="memory-health-left">
                    <span class="memory-health-icon">🧠</span>
                    <div class="memory-health-info">
                        <span class="memory-health-title" id="memory-health-title">AI Memory</span>
                        <span class="memory-health-status" id="memory-health-status">Loading...</span>
                    </div>
                </div>
                <div class="memory-health-bar">
                    <div class="memory-health-fill low" id="memory-health-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Handover Card (hidden - replaced by Live State) -->
            <div class="handover-card glass old-ui-hidden" id="handover-card">
                <div class="handover-header">
                    <span class="handover-title" id="handover-title">📋 Last Session</span>
                    <span class="handover-time" id="handover-time"></span>
                </div>
                <div class="handover-content" id="handover-content">
                    <span class="handover-empty" id="handover-empty">No handover from previous session</span>
                </div>
                <div class="handover-actions">
                    <button class="handover-btn copy" onclick="copyContextForAI()" id="copy-context-btn">📋 Copy for AI</button>
                    <button class="handover-btn" onclick="clearHandover()" id="clear-handover-btn">Clear</button>
                </div>
            </div>

            <!-- Unified Insights Section -->
            <div class="section insights-section">
                <div class="section-header section-toggle" onclick="toggleSectionLegacy('insights')">
                    <span class="section-title">
                        <span class="toggle-icon">▼</span>
                        <span id="insights-title">Insights & Memory</span>
                    </span>
                    <span class="section-count" id="insights-count">0</span>
                    <div class="changes-filter insights-filter" id="insights-filter" onclick="event.stopPropagation()">
                        <button class="filter-btn" data-filter="all" onclick="setInsightsFilter('all')">All</button>
                        <button class="filter-btn active" data-filter="project" onclick="setInsightsFilter('project')">Project</button>
                    </div>
                </div>
                <div class="section-content" id="insights-content">
                    <!-- All insights unified -->
                    <div class="memory-cards unified-insights" id="unified-insights-list"></div>
                    <!-- Add buttons -->
                    <div class="insight-actions">
                        <button class="glass-btn small" onclick="openAddDecision()">+ Decision</button>
                        <button class="glass-btn small" onclick="openAddAvoid()">+ Avoid</button>
                    </div>
                </div>
            </div>

            <!-- ROI Card (hidden) -->
            <div class="roi-card glass old-ui-hidden" id="roi-card">
                <div class="roi-header">
                    <span class="roi-title" id="roi-title">📊 ROI</span>
                    <span class="roi-badge" id="roi-badge">Savings</span>
                </div>
                <div class="roi-stats">
                    <div class="roi-stat">
                        <span class="roi-value" id="roi-solutions">0</span>
                        <span class="roi-label" id="roi-solutions-label">Reused Solutions</span>
                    </div>
                    <div class="roi-stat">
                        <span class="roi-value" id="roi-sessions">0</span>
                        <span class="roi-label" id="roi-sessions-label">Sessions with Context</span>
                    </div>
                    <div class="roi-stat">
                        <span class="roi-value" id="roi-decisions">0</span>
                        <span class="roi-label" id="roi-decisions-label">Assisted Decisions</span>
                    </div>
                    <div class="roi-stat">
                        <span class="roi-value" id="roi-avoided">0</span>
                        <span class="roi-label" id="roi-avoided-label">Mistakes Avoided</span>
                    </div>
                </div>
            </div>

            <!-- Safety Switch Section (hidden) -->
            <div class="safety-section old-ui-hidden">
                <div class="section-header section-toggle" onclick="toggleSectionLegacy('safety')">
                    <span class="section-title">
                        <span class="toggle-icon">▼</span>
                        <span id="safety-section-title">🛡️ Safety Switch</span>
                    </span>
                    <span class="section-count" id="safety-pending-count">0</span>
                </div>
                <div class="section-content" id="safety-content">
                    <div class="safety-header glass">
                        <div class="safety-header-left">
                            <span class="safety-icon">🛡️</span>
                            <div class="safety-info">
                                <span class="safety-title" id="safety-title-text">Safety Switch</span>
                                <span class="safety-status" id="safety-status-text">Preview & approve changes</span>
                            </div>
                        </div>
                        <div class="safety-toggle on" id="safety-toggle" onclick="toggleSafety()"></div>
                    </div>

                    <!-- Pending Changes -->
                    <div class="pending-changes" id="pending-changes-container">
                        <div class="no-pending" id="no-pending-text">No pending changes</div>
                    </div>

                    <!-- History Button -->
                    <button class="change-history-btn" onclick="openChangeHistory()">
                        <span>📜</span> <span id="change-history-text">Change History</span>
                    </button>
                </div>
            </div>

            <!-- Quick Actions (hidden) -->
            <div class="quick-actions old-ui-hidden">
                <button class="quick-action-btn primary" onclick="copyContextForAI()">
                    <span>📋</span> <span id="quick-copy-text">Copy Context</span>
                </button>
                <button class="quick-action-btn" onclick="detectProject()">
                    <span>🔍</span> <span id="quick-detect-text">Detect Stack</span>
                </button>
            </div>
            <div class="quick-actions old-ui-hidden" style="margin-top: 8px;">
                <button class="quick-action-btn" onclick="exportMemory()">
                    <span>📤</span> <span id="quick-export-text">Export</span>
                </button>
                <button class="quick-action-btn" onclick="document.getElementById('import-file').click()">
                    <span>📥</span> <span id="quick-import-text">Import</span>
                </button>
                <input type="file" id="import-file" accept=".json" style="display:none" onchange="importMemory(event)">
            </div>
        </div>

        <!-- ISSUES (hidden) -->
        <div class="section old-ui-hidden" id="issues-section">
            <div class="section-header">
                <span class="section-title" id="issues-title">Active Issues</span>
                <div class="section-actions">
                    <span class="section-count" id="issues-count">0</span>
                    <button class="clear-btn" id="clear-btn" onclick="clearIssues()" style="display:none;">Clear</button>
                </div>
            </div>
            <div class="filter-bar">
                <select class="filter-select" id="domain-filter" onchange="renderIssues()">
                    <option value="all" id="filter-all">All Sources</option>
                </select>
                <select class="filter-select" id="sort-select" onchange="renderIssues()">
                    <option value="newest" id="sort-newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="critical">Critical First</option>
                    <option value="count">Most Recurring</option>
                </select>
            </div>
            <div id="issues-list"></div>
        </div>

    </div>

    <!-- HISTORY PANEL -->
    <div class="history-panel" id="history-panel">
        <div class="history-header">
            <span class="history-title" id="history-title">Solved Issues</span>
            <div class="history-actions">
                <button class="clear-history-btn" id="clear-history-btn" onclick="clearHistory()" style="display:none;">Clear All</button>
                <button class="history-close" onclick="closeHistory()">&times;</button>
            </div>
        </div>
        <div id="history-list"></div>
    </div>

    <!-- SESSION MODAL (Simplified) -->
    <div class="modal-overlay" id="session-modal">
        <div class="modal" style="max-width: 340px;">
            <div class="modal-title">Start Session</div>

            <!-- Claude Code -->
            <div class="session-option glass" onclick="launchEditor('claude')">
                <div class="session-option-row">
                    <span class="session-option-name">Claude Code</span>
                    <span class="session-option-badge connected">Connected</span>
                </div>
                <div class="session-option-hint">Say "hi" - auto-connects</div>
            </div>

            <!-- Cursor -->
            <div class="session-option glass" onclick="launchCursorOneClick()">
                <div class="session-option-row">
                    <span class="session-option-name">Cursor</span>
                    <span class="session-option-badge" style="background: rgba(129,178,154,0.2); color: #81b29a;">One Click</span>
                </div>
                <div class="session-option-hint">Setup + Launch automatically</div>
            </div>

            <!-- GitHub Copilot -->
            <div class="session-option glass" onclick="launchEditor('copilot')">
                <div class="session-option-row">
                    <span class="session-option-name">GitHub Copilot</span>
                    <span class="session-option-badge">VS Code</span>
                </div>
                <div class="session-option-hint">Copy context → Paste in chat</div>
            </div>

            <!-- Chrome Extension -->
            <div class="session-extension">
                <span>Chrome Extension for error capture</span>
                <a href="https://chromewebstore.google.com/detail/fixonce-error-trapper/nilbegoaeefhfdhaiigekedkpmkgoiep" target="_blank" class="session-extension-btn">Install</a>
            </div>

            <button class="modal-close" onclick="closeSessionModal()">Close</button>
        </div>
    </div>

    <!-- WELCOME MODAL (First Run Experience) -->
    <div class="modal-overlay" id="welcome-modal" onclick="if(event.target===this) completeWelcome()">
        <div class="modal welcome-modal">
            <div class="welcome-header">🧠 Welcome to FixOnce!</div>
            <div class="welcome-subtitle">Your AI now has persistent memory</div>

            <div class="welcome-steps">
                <div class="welcome-step">
                    <span class="welcome-step-number">1</span>
                    <div class="welcome-step-content">
                        <div class="welcome-step-title">Say "היי" or "hello" to your AI</div>
                        <div class="welcome-step-desc">In Cursor or Claude Code - FixOnce will auto-connect</div>
                    </div>
                </div>
                <div class="welcome-step">
                    <span class="welcome-step-number">2</span>
                    <div class="welcome-step-content">
                        <div class="welcome-step-title">Watch FixOnce work</div>
                        <div class="welcome-step-desc">The AI will show your project context and past insights</div>
                    </div>
                </div>
                <div class="welcome-step">
                    <span class="welcome-step-number">3</span>
                    <div class="welcome-step-content">
                        <div class="welcome-step-title">Check your dashboard</div>
                        <div class="welcome-step-desc">See insights, decisions, and memory syncs in real-time</div>
                    </div>
                </div>
            </div>

            <button class="welcome-test-btn" onclick="testConnection()">
                🔗 Test Connection
            </button>

            <div class="test-result" id="test-result"></div>

            <button class="welcome-skip" onclick="completeWelcome()">
                Skip intro - I know what I'm doing
            </button>
        </div>
    </div>

    <!-- INSIGHTS & DECISIONS MODAL -->
    <div class="modal-overlay" id="insights-modal">
        <div class="modal" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-title" id="insights-modal-title">💡 תובנות</div>
            <div id="insights-modal-content" style="flex: 1; overflow-y: auto; padding: 8px 0;">
                <div style="color: #666; text-align: center; padding: 16px;">טוען...</div>
            </div>
            <button class="modal-close" onclick="closeInsightsModal()">Close</button>
        </div>
    </div>

    <!-- CURSOR SETUP MODAL -->
    <div class="modal-overlay" id="cursor-modal">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-title">🔧 Cursor + FixOnce Setup</div>

            <div style="text-align: right; direction: rtl; margin-bottom: 16px;">
                <div style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">
                    <strong>שלב 1:</strong> הגדר MCP ב-Cursor
                </div>
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem; text-align: left; direction: ltr; margin-bottom: 12px;">
                    Cursor → Settings → MCP → Add Server<br>
                    Name: <span style="color: #81b29a;">fixonce</span><br>
                    Command: <span style="color: #f2cc8f;">npx -y fixonce-mcp</span>
                </div>

                <div style="font-size: 0.85rem; color: #888; margin-bottom: 8px;">
                    <strong>שלב 2:</strong> פתח צ'אט והדבק את המשפט הזה
                </div>
            </div>

            <div style="position: relative;">
                <div id="cursor-prompt" style="background: linear-gradient(135deg, rgba(129,178,154,0.15), rgba(94,129,172,0.15)); border: 1px solid rgba(129,178,154,0.3); border-radius: 8px; padding: 14px; font-size: 0.9rem; text-align: right; direction: rtl; cursor: pointer;" onclick="copyCursorPrompt()">
                    Use the FixOnce MCP tools: call auto_init_session with cwd set to the current project path, then show me the project status.
                </div>
                <button onclick="copyCursorPrompt()" style="position: absolute; top: 8px; left: 8px; background: rgba(129,178,154,0.2); border: none; border-radius: 4px; padding: 4px 8px; color: #81b29a; cursor: pointer; font-size: 0.7rem;">📋 Copy</button>
            </div>

            <div style="text-align: center; margin-top: 16px; font-size: 0.75rem; color: #666;">
                💡 Cursor יקרא ל-FixOnce MCP ויטען את הקונטקסט של הפרויקט
            </div>

            <button class="modal-close" onclick="closeCursorModal()">Close</button>
        </div>
    </div>

    <!-- PROJECT EDIT MODAL -->
    <div class="modal-overlay" id="project-modal">
        <div class="modal">
            <div class="modal-title" id="project-title">Edit Project</div>
            <div class="field">
                <label id="name-label">Name</label>
                <input type="text" id="edit-name" placeholder="My Project">
            </div>
            <div class="field">
                <label id="stack-label">Stack</label>
                <input type="text" id="edit-stack" placeholder="React, Node, Python...">
            </div>
            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeProjectEdit()" id="project-cancel-btn">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()" id="project-save-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- PROJECT SWITCHER MODAL -->
    <div class="modal-overlay" id="project-switcher-modal">
        <div class="modal">
            <div class="modal-title" id="switcher-title">Switch Project</div>
            <div id="project-list" class="project-list">
                <div class="no-projects">Loading projects...</div>
            </div>
            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeProjectSwitcher()">Cancel</button>
                <button class="btn btn-primary" onclick="createNewProject()">+ New Project</button>
            </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal detail-modal">
            <div class="detail-header">
                <span class="detail-type" id="detail-type">Error</span>
                <button class="detail-close" onclick="closeDetail()">&times;</button>
            </div>
            <div class="detail-message" id="detail-message"></div>
            <div class="detail-location" id="detail-location"></div>

            <div class="detail-section" id="snippet-section" style="display:none;">
                <div class="detail-section-title" id="snippet-title">Code Context</div>
                <div class="code-block" id="detail-snippet"></div>
            </div>

            <div class="detail-section" id="vars-section" style="display:none;">
                <div class="detail-section-title" id="vars-title">Variables</div>
                <div class="vars-list" id="detail-vars"></div>
            </div>

            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeDetail()" id="detail-close-btn">Close</button>
                <button class="btn btn-primary" onclick="resolveFromDetail()" id="detail-resolve-btn">Mark Resolved</button>
            </div>
        </div>
    </div>

    <!-- RESOLVE MODAL -->
    <div class="modal-overlay" id="resolve-modal">
        <div class="modal">
            <div class="modal-title" id="resolve-title">Mark as Resolved</div>
            <input type="hidden" id="resolve-id">
            <div class="field">
                <label id="resolve-solution-label">Solution</label>
                <textarea id="resolve-solution" placeholder="Describe the fix..."></textarea>
            </div>
            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeResolve()" id="resolve-cancel-btn">Cancel</button>
                <button class="btn btn-primary" onclick="submitResolve()" id="resolve-save-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- ALL ISSUES MODAL -->
    <div class="modal-overlay" id="all-issues-modal">
        <div class="modal detail-modal">
            <div class="detail-header">
                <span class="detail-type" id="all-issues-title">All Active Issues</span>
                <button class="detail-close" onclick="closeAllIssues()">&times;</button>
            </div>
            <div id="all-issues-list" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-title" id="settings-title">AI Editors</div>

            <div class="editor-option">
                <span class="editor-name">Claude Code</span>
                <span class="editor-badge" id="set-claude">-</span>
            </div>
            <div class="editor-option">
                <span class="editor-name">Cursor</span>
                <span class="editor-badge" id="set-cursor">-</span>
            </div>
            <div class="editor-option">
                <span class="editor-name">GitHub Copilot</span>
                <span class="editor-badge" id="set-copilot">-</span>
            </div>
            <div class="editor-option">
                <span class="editor-name">VS Code</span>
                <span class="editor-badge" id="set-vscode">-</span>
            </div>

            <button class="modal-close" onclick="closeSettings()" id="settings-close-btn">Close</button>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal" style="max-width: 320px;">
            <div class="modal-title" id="confirm-title">Confirm</div>
            <div id="confirm-message" style="margin: 16px 0; color: #aaa; font-size: 0.9rem;"></div>
            <div class="btn-row">
                <button class="btn btn-ghost" id="confirm-cancel">Cancel</button>
                <button class="btn btn-primary" id="confirm-ok" style="background: rgba(231, 111, 81, 0.3); border-color: rgba(231, 111, 81, 0.5);">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ADD DECISION MODAL -->
    <div class="modal-overlay" id="add-decision-modal">
        <div class="modal">
            <div class="modal-title" id="add-decision-title">Add Decision</div>
            <div class="field">
                <label id="decision-what-label">What was decided?</label>
                <input type="text" id="decision-what" placeholder="Use Redux over Context">
            </div>
            <div class="field">
                <label id="decision-why-label">Why?</label>
                <input type="text" id="decision-why" placeholder="Need time-travel debugging">
            </div>
            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeAddDecision()" id="decision-cancel-btn">Cancel</button>
                <button class="btn btn-primary" onclick="submitDecision()" id="decision-add-btn">Add</button>
            </div>
        </div>
    </div>

    <!-- ADD AVOID MODAL -->
    <div class="modal-overlay" id="add-avoid-modal">
        <div class="modal">
            <div class="modal-title" id="add-avoid-title">Add Avoid Pattern</div>
            <div class="field">
                <label id="avoid-what-label">What to avoid?</label>
                <input type="text" id="avoid-what" placeholder="Don't use moment.js">
            </div>
            <div class="field">
                <label id="avoid-why-label">Why?</label>
                <input type="text" id="avoid-why" placeholder="Too heavy, use date-fns instead">
            </div>
            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeAddAvoid()" id="avoid-cancel-btn">Cancel</button>
                <button class="btn btn-primary" onclick="submitAvoid()" id="avoid-add-btn">Add</button>
            </div>
        </div>
    </div>

    <!-- DIFF VIEWER MODAL -->
    <div class="modal-overlay" id="diff-modal">
        <div class="modal diff-modal">
            <div class="detail-header">
                <span class="detail-type" id="diff-title">Change Preview</span>
                <button class="detail-close" onclick="closeDiffModal()">&times;</button>
            </div>
            <div class="diff-file" id="diff-file" style="font-size: 0.85rem; color: #f2cc8f; font-family: monospace; margin-bottom: 8px;"></div>
            <div class="diff-desc" id="diff-desc" style="font-size: 0.8rem; color: #888; margin-bottom: 12px;"></div>
            <div class="diff-viewer" id="diff-viewer"></div>
            <input type="hidden" id="diff-change-id">
            <div class="btn-row" style="margin-top: 16px;">
                <button class="btn btn-ghost" onclick="rejectChangeFromModal()" id="diff-reject-btn">Reject</button>
                <button class="btn btn-primary" onclick="approveAndApplyFromModal()" id="diff-approve-btn" style="background: rgba(129, 178, 154, 0.3); border-color: rgba(129, 178, 154, 0.5);">Approve & Apply</button>
            </div>
        </div>
    </div>

    <!-- CHANGE HISTORY MODAL -->
    <div class="modal-overlay" id="change-history-modal">
        <div class="modal detail-modal">
            <div class="detail-header">
                <span class="detail-type" id="change-history-title">Change History</span>
                <button class="detail-close" onclick="closeChangeHistory()">&times;</button>
            </div>
            <div id="change-history-list" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // Auto-detect server port (5000-5005)
        let API = 'http://localhost:5000';
        async function detectServerPort() {
            for (const port of [5000, 5001, 5002, 5003, 5004, 5005]) {
                try {
                    const res = await fetch(`http://localhost:${port}/api/ping`, { method: 'GET', signal: AbortSignal.timeout(500) });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.service === 'fixonce') {
                            API = `http://localhost:${port}`;
                            console.log(`[FixOnce] Connected to port ${port}`);
                            return port;
                        }
                    }
                } catch {}
            }
            console.log('[FixOnce] Server not found, using default port 5000');
            return 5000;
        }
        let issues = [];
        let solutions = [];
        let project = {};
        let currentIssueId = null;
        let lastIssueCount = 0;
        let lastIssueIds = new Set();

        // ===== HERO CARD & COLLAPSIBLE SECTIONS (Phase 1) =====

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('open');
            }
        }

        async function loadHeroCard() {
            try {
                // Get grouped projects data
                const res = await fetch(API + '/api/projects/grouped');
                const data = await res.json();

                const active = data.active;
                if (!active) {
                    renderHeroDisconnected();
                    return;
                }

                // Project name & meta
                document.getElementById('hero-project-name').textContent = active.name || 'Unknown Project';

                const metaParts = [];
                if (active.stack) metaParts.push(active.stack);
                if (active.working_dir) {
                    let path = active.working_dir.replace(/^\/Users\/[^\/]+/, '~');
                    metaParts.push(path);
                }
                document.getElementById('hero-project-meta').innerHTML = metaParts.join(' • ');

                // Goal
                const goalEl = document.getElementById('hero-goal');
                const goalText = document.getElementById('hero-goal-text');
                const goalTime = document.getElementById('hero-goal-time');
                const goalHistory = document.getElementById('hero-goal-history');
                const goalHistoryList = document.getElementById('goal-history-list');

                if (active.current_goal) {
                    goalText.textContent = active.current_goal;
                    goalEl.style.display = 'block';
                    document.getElementById('hero-btn-text').textContent = 'Resume AI Session';

                    // Display goal timestamp
                    if (goalTime && active.intent_updated_at) {
                        goalTime.textContent = formatGoalTime(active.intent_updated_at);
                    }

                    // Display goal history if available
                    if (active.goal_history && active.goal_history.length > 0 && goalHistory && goalHistoryList) {
                        goalHistory.style.display = 'block';
                        goalHistoryList.innerHTML = active.goal_history.slice(0, 3).map(h => `
                            <div class="goal-history-item">
                                <span class="goal-text">${h.goal}</span>
                                <span class="goal-time">${formatGoalTime(h.completed_at)}</span>
                            </div>
                        `).join('');
                    } else if (goalHistory) {
                        goalHistory.style.display = 'none';
                    }
                } else {
                    goalEl.style.display = 'none';
                    document.getElementById('hero-btn-text').textContent = 'Start AI Session';
                }

                // Update LIVE badge with connected editor
                const liveBadge = document.getElementById('live-badge');
                if (liveBadge && active.ai_session && active.ai_session.active) {
                    const editor = active.ai_session.editor || 'AI';
                    const editorName = editor.charAt(0).toUpperCase() + editor.slice(1);
                    liveBadge.textContent = `LIVE • ${editorName}`;
                    liveBadge.title = `Connected: ${editorName}`;
                    liveBadge.classList.remove('disconnected');  // Enable pulsing
                } else if (liveBadge) {
                    liveBadge.textContent = 'LIVE';
                    liveBadge.title = '';
                    liveBadge.classList.remove('disconnected');  // Still active, just no specific editor
                }

                // Stats - use browser errors count from allBrowserErrors
                const browserErrorsCount = allBrowserErrors?.length || 0;
                const insightsCount = active.insights_count || 0;
                const decisionsCount = active.decisions_count || 0;

                document.getElementById('hero-errors').textContent = browserErrorsCount;
                document.getElementById('hero-insights').textContent = insightsCount;
                document.getElementById('hero-decisions').textContent = decisionsCount;

                // Update collapse section counts
                updateCollapseCount('insights-count', insightsCount + decisionsCount, (insightsCount + decisionsCount) > 0 ? 'has-items' : '');

            } catch (e) {
                console.error('Failed to load hero card:', e);
                renderHeroDisconnected();
            }
        }

        function renderHeroDisconnected() {
            document.getElementById('hero-status').classList.add('disconnected');
            document.getElementById('hero-status-text').textContent = 'Connecting...';
            document.getElementById('hero-project-name').textContent = 'No Project';
            document.getElementById('hero-project-meta').innerHTML = 'Open a project folder to get started';
            document.getElementById('hero-goal').style.display = 'none';
            document.getElementById('hero-btn-text').textContent = 'Start AI Session';

            // Reset LIVE badge - stop animation when disconnected
            const liveBadge = document.getElementById('live-badge');
            if (liveBadge) {
                liveBadge.textContent = 'OFFLINE';
                liveBadge.title = 'Not connected';
                liveBadge.classList.add('disconnected');
            }

            // Hide compliance widget
            const compWidget = document.getElementById('compliance-widget');
            if (compWidget) compWidget.style.display = 'none';
        }

        // Protocol Compliance Widget
        async function loadComplianceStatus() {
            try {
                const res = await fetch(API + '/api/system/protocol_compliance');
                if (!res.ok) {
                    hideComplianceWidget();
                    return;
                }
                const data = await res.json();
                renderComplianceWidget(data);
            } catch (e) {
                console.log('Compliance check failed:', e);
                hideComplianceWidget();
            }
        }

        function hideComplianceWidget() {
            const widget = document.getElementById('compliance-widget');
            if (widget) widget.style.display = 'none';
        }

        function renderComplianceWidget(data) {
            const widget = document.getElementById('compliance-widget');
            if (!widget) return;

            // Only show if there's an active AI session
            if (!data.last_session_init && !data.session_initialized) {
                widget.style.display = 'none';
                return;
            }

            widget.style.display = 'block';

            // Update overall status
            const statusEl = document.getElementById('compliance-status');
            let okCount = 0;
            if (data.session_initialized) okCount++;
            if (data.decisions_displayed) okCount++;
            if (data.goal_updated) okCount++;

            if (okCount === 3) {
                statusEl.textContent = '✓ OK';
                statusEl.className = 'compliance-status ok';
            } else if (okCount >= 1) {
                statusEl.textContent = `${okCount}/3`;
                statusEl.className = 'compliance-status warning';
            } else {
                statusEl.textContent = '⚠️ Violations';
                statusEl.className = 'compliance-status error';
            }

            // Update individual items
            updateComplianceItem('comp-session', data.session_initialized);
            updateComplianceItem('comp-decisions', data.decisions_displayed);
            updateComplianceItem('comp-goal', data.goal_updated);
        }

        function updateComplianceItem(id, ok) {
            const el = document.getElementById(id);
            if (!el) return;

            const icon = el.querySelector('.icon');
            if (ok) {
                icon.textContent = '✓';
                el.className = 'compliance-item ok';
            } else {
                icon.textContent = '✗';
                el.className = 'compliance-item error';
            }
        }

        function updateCollapseCount(elementId, count, extraClass = '') {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = count;
                el.className = 'collapse-count' + (extraClass ? ' ' + extraClass : '');
            }
        }

        async function loadActivitySection() {
            // This section was merged into changes-card (renderChanges)
            // Keeping function for backwards compatibility but it's now a no-op
            const contentEl = document.getElementById('activity-content');
            if (!contentEl) return; // Element removed - activity now shows in changes-card

            try {
                const res = await fetch(API + '/api/activity/feed?limit=10');
                const data = await res.json();
                const activities = data.activities || [];

                updateCollapseCount('activity-count', activities.length, activities.length > 0 ? 'has-items' : '');

                if (activities.length === 0) {
                    contentEl.innerHTML = '<div style="color: #666; text-align: center; padding: 16px;">אין פעילות היום</div>';
                    return;
                }

                let html = '<div class="activity-list">';
                for (const act of activities.slice(0, 8)) {
                    const name = act.human_name || (act.file ? act.file.split('/').pop() : act.command?.slice(0, 30) || '');
                    const time = act.timestamp ? new Date(act.timestamp).toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}) : '';
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <span style="color: #ccc; font-size: 0.85rem;">${esc(name)}</span>
                            <span style="color: #666; font-size: 0.75rem;">${time}</span>
                        </div>
                    `;
                }
                html += '</div>';
                contentEl.innerHTML = html;

            } catch (e) {
                console.error('Failed to load activity:', e);
            }
        }

        async function loadInsightsSection() {
            try {
                const res = await fetch(API + '/api/memory');
                const memory = await res.json();

                const insights = memory.live_record?.lessons?.insights || [];
                const decisions = memory.decisions || [];
                const avoids = memory.avoid || [];
                const total = insights.length + decisions.length + avoids.length;

                updateCollapseCount('insights-count', total, total > 0 ? 'has-items' : '');

                const contentEl = document.getElementById('insights-content');
                if (total === 0) {
                    contentEl.innerHTML = '<div style="color: #666; text-align: center; padding: 16px;">אין תובנות עדיין</div>';
                    return;
                }

                let html = '';

                // Recent insights
                for (const insight of insights.slice(-3).reverse()) {
                    html += `<div style="padding: 10px; margin-bottom: 8px; background: rgba(255,217,61,0.1); border-radius: 8px; border-right: 3px solid #ffd93d; direction: rtl;">
                        <span style="color: #ffd93d;">💡</span> ${esc(insight)}
                    </div>`;
                }

                // Recent decisions
                for (const dec of decisions.slice(-2).reverse()) {
                    html += `<div style="padding: 10px; margin-bottom: 8px; background: rgba(107,207,255,0.1); border-radius: 8px; border-right: 3px solid #6bcfff; direction: rtl;">
                        <span style="color: #6bcfff;">📌</span> ${esc(dec.decision)}
                    </div>`;
                }

                contentEl.innerHTML = html || '<div style="color: #666; text-align: center; padding: 16px;">אין תובנות עדיין</div>';

            } catch (e) {
                console.error('Failed to load insights:', e);
            }
        }

        // ===== END HERO CARD =====

        // Toast notification
        function showToast(message, duration = 4000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            // Play sound for new errors
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+dl4N0Z2V0hZOdnZmPhHZpaW59i5aZl5GGe3Fwc3yGkJWUj4Z9dXN2fIWOk5KPiYJ7d3d6gYmPkY+LhYB7eXuAh42PjouHgn57fH+FioyMioeEgX5+gYWJi4uJhoOBf4CCho2Pj42KiYeHiYyQlJaVk5KQj5CSlpmbnJuamZiYmZqdoKKioqGhoaGio6WmqKmqqqqpqaipqqutrq+wsLCwsLCwsLGytLW2t7e3t7e3t7i4ubq7vLy8vLy8vLy8vb2+v8DBwcHBwcHBwcHBwcLDxMXFxcXFxcXFxcXFxcbGx8jIyMjIyMjIyMjIyMjIyMnJycnJycnJycnJycjIyMjIx8fHx8fHx8fGxsbGxcXFxcTExMTDw8PDwsLCwcHBwcDAwMC/v7++vr6+vb29vLy8vLu7u7q6urm5ubm4uLi3t7e2tra2tbW1tLS0s7OzsrKysbGxsLCwsK+vr66urq2tra2srKyrq6uqqqqpqamop6enpqampQ==');
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {}

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Simple copy to clipboard
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied!', 1500);
            } catch (e) {
                console.error('Copy failed:', e);
            }
        }

        // Open file in editor via server (works from app)
        async function openFileInEditor(filePath) {
            try {
                await fetch(API + '/api/activity/open-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file: filePath })
                });
            } catch (e) {
                // Fallback to URL scheme
                window.location.href = 'vscode://file' + filePath;
            }
        }

        // Copy Live Record context for Cursor/Copilot (editors without full MCP)
        async function copyIgnitionPrompt(editor = 'cursor') {
            console.log('[FixOnce] copyIgnitionPrompt called for:', editor);
            try {
                // Get live-record summary
                console.log('[FixOnce] Fetching from:', API + '/api/memory/live-record/summary');
                const res = await fetch(API + '/api/memory/live-record/summary');
                let text = await res.text();

                // Add decisions
                try {
                    const decRes = await fetch(API + '/api/memory/decisions');
                    const decisions = await decRes.json();
                    if (decisions && decisions.length > 0) {
                        text += '\n\n## Key Decisions\n';
                        decisions.slice(-5).forEach(d => {
                            text += `- **${d.decision}**: ${d.reason}\n`;
                        });
                    }
                } catch (e) {}

                // Add avoid patterns
                try {
                    const avoidRes = await fetch(API + '/api/memory/avoid');
                    const avoid = await avoidRes.json();
                    if (avoid && avoid.length > 0) {
                        text += '\n\n## Patterns to Avoid\n';
                        avoid.slice(-5).forEach(a => {
                            text += `- **${a.what}**: ${a.reason}\n`;
                        });
                    }
                } catch (e) {}

                // Add instruction header
                const projectName = project?.name || 'Project';
                const header = `# FixOnce Context for ${projectName}\nPaste this at the start of your conversation so I know where we left off.\n\n`;
                text = header + text;

                console.log('[FixOnce] Text to copy length:', text.length);
                console.log('[FixOnce] Text preview:', text.substring(0, 100));

                // Try clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                    console.log('[FixOnce] Copied via clipboard API');
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    console.log('[FixOnce] Copied via fallback');
                }

                const btn = document.getElementById(`copy-${editor}-prompt`);
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✅ Copied!';
                    btn.classList.add('copied');

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }

                const editorName = editor.charAt(0).toUpperCase() + editor.slice(1);
                showToast(`Context copied! Paste in ${editorName} to share memory.`);
            } catch (err) {
                console.error('Failed to copy context:', err);
                showToast('Failed to copy. Try again.');
            }
        }

        // Custom confirm dialog (replaces native confirm)
        function showConfirm(message, title = null) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const msgEl = document.getElementById('confirm-message');
                const okBtn = document.getElementById('confirm-ok');
                const cancelBtn = document.getElementById('confirm-cancel');

                titleEl.textContent = title || ('Confirm');
                msgEl.textContent = message;
                okBtn.textContent = 'OK';
                cancelBtn.textContent = 'Cancel';

                modal.classList.add('open');

                const cleanup = () => {
                    modal.classList.remove('open');
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                };

                okBtn.onclick = () => { cleanup(); resolve(true); };
                cancelBtn.onclick = () => { cleanup(); resolve(false); };
            });
        }

        // Translations
        const T = {
            en: {
                allClear: "All Clear",
                hasIssues: "Issues",
                critical: "Critical",
                startSession: "Start AI Session",
                activeIssues: "Active Issues",
                noIssues: "No active issues",
                history: "History",
                settings: "Settings",
                solved: "Solved Issues",
                noHistory: "No solved issues yet",
                editProject: "Edit Project",
                name: "Name",
                stack: "Stack",
                save: "Save",
                cancel: "Cancel",
                close: "Close",
                markResolved: "Mark Resolved",
                codeContext: "Code Context",
                variables: "Variables",
                clear: "Clear",
                confirmClear: "Clear all issues?",
                hint: "Ask about errors in your own words",
                allSources: "All Sources",
                newestFirst: "Newest First",
                oldestFirst: "Oldest First",
                criticalFirst: "Critical First",
                mostRecurring: "Most Recurring",
                clearHistory: "Clear All",
                confirmClearHistory: "Clear all solution history?",
                confirmDeleteSolution: "Delete this solution?",
                workingOn: "You're working on:",
                monitoringServer: "Monitoring server errors:",
                connect: "Connect",
                connected: "Connected",
                // AI Memory translations
                aiMemory: "AI Memory",
                memoryReady: "Ready",
                memoryStale: "Needs refresh",
                lastSession: "Last Session",
                noHandover: "No handover from previous session",
                copyForAI: "Copy for AI",
                copiedToClipboard: "Copied to clipboard!",
                decisions: "Decisions",
                avoid: "Avoid",
                addDecision: "Add Decision",
                addPattern: "Add Pattern",
                copyContext: "Copy Context",
                detectStack: "Detect Stack",
                // Live State
                memoryActive: "Memory Active",
                notConnected: "Not Connected",
                continuingFrom: "Continuing from:",
                startingFresh: "Starting fresh",
                lastInsight: "Last insight",
                copyForAI: "Copy for AI",
                connectEditor: "Connect Editor",
                resetMemory: "Start fresh",
                resetConfirmTitle: "Start fresh?",
                resetConfirmMsg: "This will clear the Live Record (not decisions)",
                memoryReset: "Memory reset",
                // Port Detection
                portDetected: "Detected:",
                portConnect: "Connect",
                switchedTo: "Switched to:",
                whatDecided: "What was decided?",
                whyDecided: "Why?",
                whatAvoid: "What to avoid?",
                whyAvoid: "Why?",
                usedByAI: "AI used",
                notUsedYet: "Not used yet",
                confirmDeleteDecision: "Delete this decision?",
                confirmDeleteAvoid: "Delete this avoid pattern?",
                confirmClearHandover: "Clear handover?",
                stackDetected: "Stack detected!",
                noStackFound: "Could not detect stack",
                exportMemory: "Export",
                importMemory: "Import",
                exportSuccess: "Memory exported!",
                importSuccess: "Memory imported!",
                importError: "Import failed",
                clearHandover: "Clear",
                add: "Add",
                noDecisions: "No decisions yet",
                noAvoidPatterns: "No avoid patterns yet",
                memoryHealth: "Memory Health",
                placeholderDecision: "Use Redux over Context",
                placeholderDecisionWhy: "Need time-travel debugging",
                placeholderAvoid: "Don't use moment.js",
                placeholderAvoidWhy: "Too heavy, use date-fns",
                allActiveIssues: "All Active Issues",
                solution: "Solution",
                describeFix: "Describe the fix...",
                confirm: "Confirm",
                ok: "OK",
                roiTitle: "Usage Stats",
                roiSavings: "Real Data",
                roiSolutionsReused: "Solutions reused",
                roiSessionsContext: "Sessions w/ context",
                roiDecisionsUsed: "Decisions used",
                roiErrorsAvoided: "Errors avoided",
                // Human UI
                changesTitle: "What Changed Today",
                noChanges: "No changes yet today",
                showMore: "Show more",
                showing7days: "Showing 7 days",
                filterAll: "All",
                filterProject: "Current Project",
                techDetails: "Technical Details",
                component: "Component",
                action: "Action",
                fullPath: "Full Path",
                command: "Command",
                time: "Time",
                source: "Source",
                openInVSCode: "Open in VS Code",
                renameComponent: "Rename Component",
                sensitive: "Sensitive"
            }
        };

        // English only - simplified
        const lang = 'en';
        const t = k => T.en[k] || k;

        // Safe text setter - prevents null errors
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }
        function setPlaceholder(id, text) {
            const el = document.getElementById(id);
            if (el) el.placeholder = text;
        }

        function applyLang() {
            setText('cta-text', t('startSession'));
            setText('issues-title', t('activeIssues'));
            setText('history-link', t('history'));
            setText('settings-link', t('settings'));
            setText('history-title', t('solved'));
            setText('modal-title', t('startSession'));
            setText('modal-hint', t('hint'));
            setText('project-title', t('editProject'));
            setText('name-label', t('name'));
            setText('stack-label', t('stack'));
            setText('resolve-title', t('markResolved'));
            setText('settings-title', t('settings'));
            setText('snippet-title', t('codeContext'));
            setText('vars-title', t('variables'));
            setText('clear-btn', t('clear'));
            setText('clear-history-btn', t('clearHistory'));

            // Filter/sort translations
            setText('filter-all', t('allSources'));
            setText('sort-newest', t('newestFirst'));
            const sortSelect = document.getElementById('sort-select');
            if (sortSelect && sortSelect.options) {
                if (sortSelect.options[1]) sortSelect.options[1].textContent = t('oldestFirst');
                if (sortSelect.options[2]) sortSelect.options[2].textContent = t('criticalFirst');
                if (sortSelect.options[3]) sortSelect.options[3].textContent = t('mostRecurring');
            }

            // Server connect translations
            const serverLabel = document.getElementById('server-label');
            const connectBtn = document.getElementById('connect-btn');
            if (serverLabel && connectBtn) {
                if (!serverConnected) {
                    serverLabel.textContent = t('workingOn');
                    connectBtn.textContent = t('connect');
                } else {
                    serverLabel.textContent = t('monitoringServer');
                    connectBtn.textContent = t('connected');
                }
            }

            // AI Memory translations
            setText('memory-health-title', t('aiMemory'));
            setText('handover-title', '📋 ' + t('lastSession'));
            setText('copy-context-btn', '📋 ' + t('copyForAI'));
            // Decisions and avoid now unified in insights section
            setText('add-decision-text', t('addDecision'));
            setText('add-avoid-text', t('addPattern'));
            setText('quick-copy-text', t('copyContext'));
            setText('quick-detect-text', t('detectStack'));

            // Live State translations
            setText('copy-ai-text', t('copyForAI'));
            setText('connect-editor-text', t('connectEditor'));
            setText('reset-btn', t('resetMemory'));
            setText('add-decision-title', t('addDecision'));
            setText('decision-what-label', t('whatDecided'));
            setText('decision-why-label', t('whyDecided'));
            setText('add-avoid-title', t('addPattern'));
            setText('avoid-what-label', t('whatAvoid'));
            setText('avoid-why-label', t('whyAvoid'));
            setText('quick-export-text', t('exportMemory'));
            setText('quick-import-text', t('importMemory'));
            setText('clear-handover-btn', t('clearHandover'));

            // Port Detection
            setText('port-detected-label', t('portDetected'));
            setText('port-connect-text', t('portConnect'));

            // Placeholders
            setPlaceholder('decision-what', t('placeholderDecision'));
            setPlaceholder('decision-why', t('placeholderDecisionWhy'));
            setPlaceholder('avoid-what', t('placeholderAvoid'));
            setPlaceholder('avoid-why', t('placeholderAvoidWhy'));

            // Modal buttons
            setText('session-cancel-btn', t('cancel'));
            setText('project-cancel-btn', t('cancel'));
            setText('project-save-btn', t('save'));
            setText('detail-close-btn', t('close'));
            setText('detail-resolve-btn', t('markResolved'));
            setText('resolve-cancel-btn', t('cancel'));
            setText('resolve-save-btn', t('save'));
            setText('settings-close-btn', t('close'));
            setText('decision-cancel-btn', t('cancel'));
            setText('decision-add-btn', t('add'));
            setText('avoid-cancel-btn', t('cancel'));
            setText('avoid-add-btn', t('add'));
            setText('all-issues-title', t('allActiveIssues'));
            setText('confirm-title', t('confirm'));
            setText('confirm-cancel', t('cancel'));
            setText('confirm-ok', t('ok'));

            // Resolve modal
            setText('resolve-solution-label', t('solution'));
            setPlaceholder('resolve-solution', t('describeFix'));

            // ROI card (now showing real stats only)
            setText('roi-title', '📊 ' + t('roiTitle'));
            setText('roi-badge', t('roiSavings'));
            setText('roi-solutions-label', t('roiSolutionsReused'));
            setText('roi-sessions-label', t('roiSessionsContext'));
            setText('roi-decisions-label', t('roiDecisionsUsed'));
            setText('roi-avoided-label', t('roiErrorsAvoided'));

            // Re-render memory sections with new language
            if (typeof renderDecisions === 'function') renderDecisions();
            if (typeof renderAvoid === 'function') renderAvoid();
            if (typeof renderHandover === 'function') renderHandover();
            if (typeof renderROI === 'function') renderROI();
            updateStatus();
        }

        // Connection status tracking
        let connectionStartTime = null;

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            const timeEl = document.getElementById('connection-time');

            if (connected) {
                if (!connectionStartTime) connectionStartTime = Date.now();
                statusEl.classList.add('connected');
                textEl.textContent = 'Connected';

                // Update time display
                const elapsed = Date.now() - connectionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const hours = Math.floor(minutes / 60);
                if (hours > 0) {
                    timeEl.textContent = `${hours}h`;
                } else if (minutes > 0) {
                    timeEl.textContent = `${minutes}m`;
                } else {
                    timeEl.textContent = 'now';
                }
            } else {
                statusEl.classList.remove('connected');
                textEl.textContent = 'Disconnected';
                timeEl.textContent = '';
                connectionStartTime = null;
            }
        }

        // Quick stats
        async function loadQuickStats() {
            try {
                // Get errors count
                const errorsRes = await fetch(API + '/api/live-errors');
                const errorsData = await errorsRes.json();
                const openErrors = (errorsData.errors || []).filter(e => !e.resolved).length;
                document.getElementById('stat-errors').textContent = openErrors;

                // Get solutions count
                const solRes = await fetch(API + '/api/solutions/personal');
                const solData = await solRes.json();
                document.getElementById('stat-solutions').textContent = (solData.solutions || []).length;

                // Get insights from live record
                const lrRes = await fetch(API + '/api/memory/live-record');
                const lrData = await lrRes.json();
                const insights = lrData?.lessons?.insights || [];
                document.getElementById('stat-insights').textContent = insights.length;

                // Fixed count (placeholder - would need to track this)
                document.getElementById('stat-fixed').textContent = insights.length > 0 ? insights.length : '0';

                // Update connection status
                updateConnectionStatus(true);
            } catch (e) {
                console.error('Failed to load quick stats:', e);
                updateConnectionStatus(false);
            }
        }

        // Update connection time every minute
        setInterval(() => {
            if (connectionStartTime) updateConnectionStatus(true);
        }, 60000);

        // Reload all project-specific data (called on project switch)
        async function reloadAllProjectData() {
            showingDays = 1; // Reset to today only
            await Promise.all([
                loadData(),
                loadMemoryData(),
                loadLiveRecord(),
                loadQuickStats(),
                loadBrowserErrors(),
                loadChangesToday()
            ]);
            await loadActivityFeed();
        }

        async function loadData() {
            try {
                const res = await fetch(API + '/api/memory');
                const data = await res.json();
                const newIssues = data.active_issues || [];
                solutions = data.solutions_history || [];
                project = data.project_info || {};

                // Check for new errors
                const newIssueIds = new Set(newIssues.map(i => i.id));
                const addedIssues = newIssues.filter(i => !lastIssueIds.has(i.id));

                if (addedIssues.length > 0 && lastIssueIds.size > 0) {
                    // New error detected!
                    const latest = addedIssues[0];
                    const msg = `New error: ${latest.message.substring(0, 50)}...`;
                    showToast(msg);

                    // Add animation class to status bar
                    document.getElementById('status-bar').classList.add('new-error');
                    setTimeout(() => document.getElementById('status-bar').classList.remove('new-error'), 3000);
                }

                lastIssueIds = newIssueIds;
                lastIssueCount = newIssues.length;
                issues = newIssues;

                // Populate domain filter
                updateDomainFilter();

                const name = project.name || 'My Project';
                const stack = project.stack;
                setText('project-name', stack ? `${name} · ${stack}` : name);
                setText('history-count', solutions.length);

                updateStatus();
                renderIssues();

                // Load ROI data
                loadROI();
            } catch (e) {
                console.error(e);
            }
        }

        let roiData = {};

        async function loadROI() {
            try {
                // Try new usage_stats endpoint first (has more data)
                const statsRes = await fetch(API + '/api/system/usage_stats');
                if (statsRes.ok) {
                    roiData = await statsRes.json();
                } else {
                    // Fallback to old ROI endpoint
                    const res = await fetch(API + '/api/memory/roi');
                    roiData = await res.json();
                }
                renderROI();
            } catch (e) {
                console.error('Failed to load ROI:', e);
            }
        }

        function renderROI() {
            // Real metrics only
            setText('roi-solutions', roiData.solutions_reused || 0);
            setText('roi-sessions', roiData.sessions_with_context || 0);
            setText('roi-decisions', roiData.decisions_referenced || 0);
            setText('roi-avoided', roiData.errors_prevented || 0);

            // Update sync counter (total knowledge syncs)
            const totalSyncs = (roiData.sessions_with_context || 0) +
                               (roiData.solutions_reused || 0) +
                               (roiData.decisions_referenced || 0);
            setText('sync-value', totalSyncs);

            // Update ROI Widget
            setText('roi-syncs', totalSyncs);
            setText('roi-solutions', roiData.solutions_reused || 0);
            setText('roi-time', roiData.time_saved_minutes || 0);
            setText('roi-prevented', roiData.errors_prevented || 0);
        }

        // ============ WELCOME MODAL (First Run) ============

        async function checkFirstRun() {
            try {
                const res = await fetch(API + '/api/system/first_run');
                const data = await res.json();
                if (data.is_first_run) {
                    showWelcomeModal();
                }
            } catch (e) {
                console.log('First run check failed:', e);
            }
        }

        function showWelcomeModal() {
            document.getElementById('welcome-modal').style.display = 'flex';
        }

        function closeWelcomeModal() {
            document.getElementById('welcome-modal').style.display = 'none';
        }

        async function testConnection() {
            const resultEl = document.getElementById('test-result');
            resultEl.className = 'test-result';
            resultEl.textContent = 'Testing...';
            resultEl.style.display = 'block';

            try {
                // Test health endpoint
                const healthRes = await fetch(API + '/api/health');
                const health = await healthRes.json();

                if (health.status === 'healthy' || health.status === 'degraded') {
                    // Test MCP
                    const mcpOk = health.checks?.mcp_server?.status === 'ok';
                    const memoryOk = health.checks?.memory_writable?.status === 'ok';

                    if (mcpOk && memoryOk) {
                        resultEl.className = 'test-result success';
                        resultEl.innerHTML = '✅ All systems go!<br>MCP server ready, memory writable.<br>Go say "היי" to your AI!';
                    } else {
                        resultEl.className = 'test-result success';
                        resultEl.innerHTML = '✅ Server running!<br>Some features may need setup.<br>Check the dashboard for details.';
                    }
                } else {
                    throw new Error('Health check failed');
                }
            } catch (e) {
                resultEl.className = 'test-result error';
                resultEl.innerHTML = '❌ Connection issue<br>Make sure FixOnce server is running.';
            }
        }

        async function completeWelcome() {
            try {
                await fetch(API + '/api/system/first_run/complete', { method: 'POST' });
            } catch (e) {
                console.log('Could not mark first run complete:', e);
            }
            closeWelcomeModal();
        }

        function updateStatus() {
            const bar = document.getElementById('status-bar');
            const text = document.getElementById('status-text');
            const count = document.getElementById('issues-count');
            const clearBtn = document.getElementById('clear-btn');

            if (count) count.textContent = issues.length;
            if (clearBtn) clearBtn.style.display = issues.length > 0 ? 'block' : 'none';

            const critical = issues.filter(i => i.severity === 'critical').length;

            // Note: status-bar is hidden in new UI, but keep updating for backwards compat
            if (issues.length === 0) {
                if (bar) bar.className = 'status-bar clear old-ui-hidden';
                if (text) text.textContent = t('allClear');
            } else if (critical > 0) {
                if (bar) bar.className = 'status-bar error old-ui-hidden';
                if (text) text.textContent = `${t('critical')} (${critical})`;
            } else {
                if (bar) bar.className = 'status-bar warning old-ui-hidden';
                if (text) text.textContent = `${t('hasIssues')} (${issues.length})`;
            }
        }

        function updateDomainFilter() {
            const filter = document.getElementById('domain-filter');
            const currentValue = filter.value;

            // Extract unique domains from all issues
            const domains = new Set();
            issues.forEach(i => {
                const urls = i.urls || [];
                urls.forEach(url => {
                    try {
                        const domain = new URL(url).host;
                        if (domain) domains.add(domain);
                    } catch (e) {}
                });
                // Also check the direct url field
                if (i.url) {
                    try {
                        const domain = new URL(i.url).host;
                        if (domain) domains.add(domain);
                    } catch (e) {}
                }
            });

            // Rebuild options
            filter.innerHTML = `<option value="all">${t('allSources')}</option>`;
            [...domains].sort().forEach(domain => {
                filter.innerHTML += `<option value="${domain}">${domain}</option>`;
            });

            // Restore previous selection if still valid
            if ([...domains].includes(currentValue)) {
                filter.value = currentValue;
            }
        }

        function renderIssues() {
            const list = document.getElementById('issues-list');
            const domainFilter = document.getElementById('domain-filter').value;
            const sortBy = document.getElementById('sort-select').value;

            // Filter by domain
            let filtered = [...issues];
            if (domainFilter !== 'all') {
                filtered = issues.filter(i => {
                    const urls = i.urls || [];
                    const hasUrl = urls.some(url => {
                        try { return new URL(url).host === domainFilter; } catch (e) { return false; }
                    });
                    if (hasUrl) return true;
                    if (i.url) {
                        try { return new URL(i.url).host === domainFilter; } catch (e) { return false; }
                    }
                    return false;
                });
            }

            if (filtered.length === 0) {
                list.innerHTML = `<div class="empty-state">${t('noIssues')}</div>`;
                return;
            }

            // Sort based on selection
            const sorted = filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return new Date(b.last_seen || b.first_seen || 0) - new Date(a.last_seen || a.first_seen || 0);
                    case 'oldest':
                        return new Date(a.first_seen || 0) - new Date(b.first_seen || 0);
                    case 'critical':
                        if (a.severity === 'critical' && b.severity !== 'critical') return -1;
                        if (b.severity === 'critical' && a.severity !== 'critical') return 1;
                        return new Date(b.last_seen || 0) - new Date(a.last_seen || 0);
                    case 'count':
                        return (b.count || 1) - (a.count || 1);
                    default:
                        return new Date(b.last_seen || 0) - new Date(a.last_seen || 0);
                }
            });

            list.innerHTML = sorted.slice(0, 5).map(i => {
                const hasXray = (i.snippet?.length > 0) || (i.locals && Object.keys(i.locals).length > 0);
                const domain = i.urls?.[0] ? (() => { try { return new URL(i.urls[0]).host; } catch(e) { return ''; } })() : '';
                const timeAgo = formatTimeAgo(i.last_seen || i.first_seen);
                return `
                    <div class="issue-card glass" onclick="openDetail('${i.id}')">
                        <div class="issue-dot ${i.severity || 'error'}"></div>
                        <div class="issue-content">
                            <div class="issue-message">${esc(i.message)}</div>
                            <div class="issue-meta">${domain}${timeAgo ? ' · ' + timeAgo : ''}</div>
                        </div>
                        ${(i.count || 1) > 1 ? `<span class="issue-badge count">×${i.count}</span>` : ''}
                        ${hasXray ? '<span class="issue-badge">X-Ray</span>' : ''}
                    </div>
                `;
            }).join('');

            if (sorted.length > 5) {
                list.innerHTML += `<div style="text-align:center;padding:10px;color:#555;font-size:0.8rem;cursor:pointer" onclick="showAllIssues()">+${sorted.length - 5} more</div>`;
            }
        }

        function esc(s) {
            if (s === null || s === undefined) return '';
            const str = String(s); // Convert to string first
            return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);

            if (diff < 60) return 'now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h';
            return Math.floor(diff / 86400) + 'd';
        }

        function formatDateTime(timestamp) {
            const d = new Date(timestamp);
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            const hours = d.getHours().toString().padStart(2, '0');
            const mins = d.getMinutes().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${mins}`;
        }

        function formatTimeFull(timestamp) {
            // Returns both relative and absolute: "5m • 14/02 21:30"
            const relative = formatTimeAgo(timestamp);
            const d = new Date(timestamp);
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const hours = d.getHours().toString().padStart(2, '0');
            const mins = d.getMinutes().toString().padStart(2, '0');
            return `${relative} • ${day}/${month} ${hours}:${mins}`;
        }

        function formatGoalTime(timestamp) {
            // Returns time for goal display: "Updated 5m ago" or "Updated 14:30"
            if (!timestamp) return '';
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);

            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) {
                const hours = then.getHours().toString().padStart(2, '0');
                const mins = then.getMinutes().toString().padStart(2, '0');
                return `today ${hours}:${mins}`;
            }
            // More than a day
            const day = then.getDate().toString().padStart(2, '0');
            const month = (then.getMonth() + 1).toString().padStart(2, '0');
            const hours = then.getHours().toString().padStart(2, '0');
            const mins = then.getMinutes().toString().padStart(2, '0');
            return `${day}/${month} ${hours}:${mins}`;
        }

        // Session Modal
        function openSessionModal() {
            document.getElementById('session-modal').classList.add('open');
            loadEditorStatus();
        }
        function closeSessionModal() {
            document.getElementById('session-modal')?.classList.remove('open');
            const usageTip = document.getElementById('usage-tip');
            if (usageTip) usageTip.style.display = 'none';
        }

        // Insights & Decisions Modal
        async function openInsightsModal(type) {
            const modal = document.getElementById('insights-modal');
            const title = document.getElementById('insights-modal-title');
            const content = document.getElementById('insights-modal-content');

            title.textContent = type === 'insights' ? '💡 תובנות' : '📌 החלטות';
            content.innerHTML = '<div style="color: #666; text-align: center; padding: 16px;">טוען...</div>';
            modal.classList.add('open');

            try {
                const res = await fetch(API + '/api/memory');
                const data = await res.json();

                if (type === 'insights') {
                    const insights = data.live_record?.lessons?.insights || [];
                    if (insights.length === 0) {
                        content.innerHTML = '<div style="color: #666; text-align: center; padding: 24px;">אין תובנות עדיין</div>';
                        return;
                    }
                    content.innerHTML = insights.slice().reverse().map((insight, i) => {
                        const text = typeof insight === 'object' ? insight.text : insight;
                        const time = typeof insight === 'object' && insight.timestamp ? formatTimeFull(insight.timestamp) : '';
                        return `
                            <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); direction: rtl;">
                                <div style="color: #f4a261; font-size: 0.75rem; margin-bottom: 4px;">${time}</div>
                                <div style="color: #ccc; font-size: 0.85rem; line-height: 1.5;">${esc(text)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    const decisions = data.decisions || [];
                    if (decisions.length === 0) {
                        content.innerHTML = '<div style="color: #666; text-align: center; padding: 24px;">אין החלטות עדיין</div>';
                        return;
                    }
                    content.innerHTML = decisions.slice().reverse().map(dec => `
                        <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); direction: rtl;">
                            <div style="color: #81b29a; font-size: 0.75rem; margin-bottom: 4px;">${formatTimeFull(dec.timestamp)}</div>
                            <div style="color: #fff; font-size: 0.9rem; font-weight: 500; margin-bottom: 4px;">${esc(dec.decision)}</div>
                            <div style="color: #888; font-size: 0.8rem;">${esc(dec.reason || '')}</div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                content.innerHTML = '<div style="color: #e76f51; text-align: center; padding: 24px;">שגיאה בטעינה</div>';
            }
        }

        function closeInsightsModal() {
            document.getElementById('insights-modal')?.classList.remove('open');
        }

        // Cursor Setup Modal
        function showCursorSetup() {
            closeSessionModal();
            document.getElementById('cursor-modal').classList.add('open');
        }
        function closeCursorModal() {
            document.getElementById('cursor-modal').classList.remove('open');
        }
        function copyCursorPrompt() {
            const prompt = document.getElementById('cursor-prompt').textContent.trim();
            navigator.clipboard.writeText(prompt).then(() => {
                showToast('Copied! Paste in Cursor chat');
            });
        }

        async function loadEditorStatus() {
            try {
                const res = await fetch(API + '/api/system/mcp_status');
                const data = await res.json();
                setBadge('claude', data.claude);
                setBadge('cursor', data.cursor);
                setBadge('copilot', data.copilot || data.vscode);
                setBadge('vscode', data.continue);
                // Settings modal too
                setStatus('set-claude', data.claude);
                setStatus('set-cursor', data.cursor);
                setStatus('set-copilot', data.copilot || data.vscode);
                setStatus('set-vscode', data.continue);
            } catch (e) {}
        }

        function setBadge(ed, st) {
            const b = document.getElementById('badge-' + ed);
            if (st?.configured) {
                b.textContent = '✓';
                b.className = 'editor-badge ready';
            } else if (st?.installed) {
                b.textContent = 'Ready';
                b.className = 'editor-badge';
            } else {
                b.textContent = '-';
                b.className = 'editor-badge';
            }
        }

        function setStatus(id, st) {
            const b = document.getElementById(id);
            if (st?.configured) {
                b.textContent = 'Connected';
                b.className = 'editor-badge ready';
            } else if (st?.installed) {
                b.textContent = 'Installed';
                b.className = 'editor-badge';
            } else {
                b.textContent = 'Not found';
                b.className = 'editor-badge';
            }
        }

        async function launchCursorOneClick() {
            showToast('Setting up Cursor...');
            try {
                const projectPath = project?.working_dir || project?.root_path || '';
                const res = await fetch(API + '/api/system/cursor_one_click', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_path: projectPath})
                });
                const data = await res.json();

                if (data.status === 'ok') {
                    showToast('Cursor launched with FixOnce!');
                    closeSessionModal();
                } else if (data.status === 'partial') {
                    showToast('Cursor opened (some setup steps failed)');
                    console.warn('Cursor setup partial:', data.results);
                    closeSessionModal();
                } else {
                    showToast(data.message || 'Failed to setup Cursor');
                }
            } catch (e) {
                console.error('Cursor one-click error:', e);
                showToast('Failed: ' + e.message);
            }
        }

        async function launchEditor(ed) {
            // Map copilot to vscode (Copilot is a VS Code extension)
            const editorToLaunch = ed === 'copilot' ? 'vscode' : ed;
            const displayName = ed === 'copilot' ? 'VS Code + Copilot' : ed;

            try {
                await fetch(API + '/api/session/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({editor: editorToLaunch})
                });
                const res = await fetch(API + '/api/session/launch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({editor: editorToLaunch})
                });
                const data = await res.json();
                if (data.status === 'error') {
                    showToast(data.message || 'Failed to launch');
                } else {
                    showToast(`Launching ${displayName}...`);
                    closeSessionModal();
                }
            } catch (e) {
                console.error('Launch error:', e);
                showToast('Failed to launch: ' + e.message);
            }
        }

        // Project Edit
        function openProjectEdit() {
            document.getElementById('edit-name').value = project.name || '';
            document.getElementById('edit-stack').value = project.stack || '';
            document.getElementById('project-modal').classList.add('open');
        }
        function closeProjectEdit() {
            document.getElementById('project-modal').classList.remove('open');
        }
        async function saveProject() {
            const name = document.getElementById('edit-name').value.trim() || 'My Project';
            const stack = document.getElementById('edit-stack').value.trim();
            try {
                await fetch(API + '/api/memory/project', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, stack})
                });
                project.name = name;
                project.stack = stack;
                setText('project-name', stack ? `${name} · ${stack}` : name);
                closeProjectEdit();
            } catch (e) {}
        }

        // ===== PROJECT SWITCHER =====
        let allProjects = [];
        let activeProjectId = null;

        async function openProjectSwitcher() {
            document.getElementById('project-switcher-modal').classList.add('open');
            await loadProjectsList();
        }

        function closeProjectSwitcher() {
            document.getElementById('project-switcher-modal').classList.remove('open');
        }

        async function loadProjectsList() {
            const listEl = document.getElementById('project-list');
            listEl.innerHTML = '<div class="no-projects">Loading...</div>';

            try {
                // Use the new grouped API (Phase 1)
                const res = await fetch(API + '/api/projects/grouped');
                const data = await res.json();

                const { active, recent, stale } = data;
                allProjects = [...(active ? [active] : []), ...recent, ...stale];
                activeProjectId = active?.id;

                if (allProjects.length === 0) {
                    listEl.innerHTML = `
                        <div class="no-projects">
                            ${'No projects yet'}
                            <br><br>
                            ${'Open a site in browser or connect a server'}
                        </div>
                    `;
                    return;
                }

                let html = '';

                // Active project - big card at top
                if (active) {
                    html += `
                        <div class="project-active-card" onclick="switchToProject('${active.id}')">
                            <div class="project-active-badge">🟢 פעיל עכשיו</div>
                            <div class="project-active-name">${esc(active.name)}</div>
                            <div class="project-active-stack">${esc(active.stack || '')}</div>
                            ${active.current_goal ? `<div class="project-active-goal">🎯 ${esc(active.current_goal)}</div>` : ''}
                            <div class="project-active-stats">
                                ${active.open_errors > 0 ? `<span class="stat-errors">⚠️ ${active.open_errors} שגיאות</span>` : ''}
                                ${active.insights_count > 0 ? `<span class="stat-insights">💡 ${active.insights_count} תובנות</span>` : ''}
                                ${active.decisions_count > 0 ? `<span class="stat-decisions">📌 ${active.decisions_count} החלטות</span>` : ''}
                            </div>
                            <button class="project-active-btn">▶️ המשך לעבוד</button>
                        </div>
                    `;
                }

                // Recent projects section
                if (recent.length > 0) {
                    html += `<div class="project-section-title">🕒 עבדת לאחרונה</div>`;
                    for (const proj of recent) {
                        html += `
                            <div class="project-item" onclick="switchToProject('${proj.id}')">
                                <div>
                                    <div class="project-item-name">${esc(proj.name)}</div>
                                    <div class="project-item-stack">${esc(proj.stack || '')}</div>
                                </div>
                                <span class="project-item-time">${esc(proj.last_activity_relative || '')}</span>
                            </div>
                        `;
                    }
                }

                // Stale projects (collapsed)
                if (stale.length > 0) {
                    html += `<div class="project-section-title project-section-stale">📦 ישנים (${stale.length})</div>`;
                    for (const proj of stale) {
                        html += `
                            <div class="project-item project-item-stale" onclick="switchToProject('${proj.id}')">
                                <div>
                                    <div class="project-item-name">${esc(proj.name)}</div>
                                    <div class="project-item-stack">${esc(proj.stack || '')}</div>
                                </div>
                            </div>
                        `;
                    }
                }

                listEl.innerHTML = html;

            } catch (e) {
                console.error('Failed to load projects:', e);
                listEl.innerHTML = '<div class="no-projects">Error loading projects</div>';
            }
        }

        async function switchToProject(projectId) {
            try {
                const res = await fetch(API + '/api/projects/switch/' + projectId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();

                if (data.status === 'ok') {
                    showToast('Switched project');
                    closeProjectSwitcher();
                    // Reload ALL data for new project
                    await reloadAllProjectData();
                } else {
                    showToast(data.message || 'Failed to switch');
                }
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        }

        async function createNewProject() {
            const name = prompt('Project name:');
            if (!name) return;

            try {
                const res = await fetch(API + '/api/projects/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });
                const data = await res.json();

                if (data.status === 'ok') {
                    showToast('Project created');
                    closeProjectSwitcher();
                    // Reload ALL data for new project
                    await reloadAllProjectData();
                }
            } catch (e) {
                showToast('Error: ' + e.message);
            }
        }

        // Detail Modal
        function openDetail(id) {
            const issue = issues.find(i => i.id === id);
            if (!issue) return;
            currentIssueId = id;

            setText('detail-type', issue.type || 'Error');
            setText('detail-message', issue.message || '');

            const file = issue.file || issue.url || '';
            const line = issue.line || '';
            const func = issue.function || '';
            let loc = file;
            if (line) loc += ':' + line;
            if (func) loc += ' in ' + func;
            setText('detail-location', loc);

            const snippetSec = document.getElementById('snippet-section');
            const snippetEl = document.getElementById('detail-snippet');
            if (issue.snippet?.length > 0) {
                snippetEl.innerHTML = issue.snippet.map(l => {
                    const cls = l.startsWith('>>>') ? 'code-line error' : 'code-line';
                    return `<div class="${cls}">${esc(l)}</div>`;
                }).join('');
                snippetSec.style.display = 'block';
            } else {
                snippetSec.style.display = 'none';
            }

            const varsSec = document.getElementById('vars-section');
            const varsEl = document.getElementById('detail-vars');
            if (issue.locals && Object.keys(issue.locals).length > 0) {
                varsEl.innerHTML = Object.entries(issue.locals).map(([n, v]) => `
                    <div class="var-row">
                        <span class="var-name">${esc(n)}</span>
                        <span class="var-value">${esc(String(v))}</span>
                    </div>
                `).join('');
                varsSec.style.display = 'block';
            } else {
                varsSec.style.display = 'none';
            }

            document.getElementById('detail-modal').classList.add('open');
        }
        function closeDetail() {
            document.getElementById('detail-modal').classList.remove('open');
            currentIssueId = null;
        }
        function resolveFromDetail() {
            if (!currentIssueId) return;
            closeDetail();
            openResolve(currentIssueId);
        }

        // Resolve Modal
        function openResolve(id) {
            document.getElementById('resolve-id').value = id;
            document.getElementById('resolve-solution').value = '';
            document.getElementById('resolve-modal').classList.add('open');
        }
        function closeResolve() {
            document.getElementById('resolve-modal').classList.remove('open');
        }
        async function submitResolve() {
            const id = document.getElementById('resolve-id').value;
            const sol = document.getElementById('resolve-solution').value;
            if (!sol.trim()) return;
            try {
                await fetch(API + `/api/memory/issues/${id}/resolve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({solution: sol, worked: true})
                });
                closeResolve();
                loadData();
            } catch (e) {}
        }

        // Clear Issues
        async function clearIssues() {
            if (!await showConfirm(t('confirmClear'))) return;
            try {
                await fetch(API + '/api/memory/clear-issues', {method: 'POST'});
                loadData();
            } catch (e) {}
        }

        // History
        function openHistory() {
            renderHistory();
            document.getElementById('history-panel').classList.add('open');
        }
        function closeHistory() {
            document.getElementById('history-panel').classList.remove('open');
        }
        function renderHistory() {
            const list = document.getElementById('history-list');
            const clearBtn = document.getElementById('clear-history-btn');

            if (solutions.length === 0) {
                list.innerHTML = `<div class="empty-state">${t('noHistory')}</div>`;
                clearBtn.style.display = 'none';
                return;
            }

            clearBtn.style.display = 'block';
            list.innerHTML = solutions.slice(0, 20).map((s, idx) => `
                <div class="solution-card">
                    <button class="solution-delete" onclick="deleteSolution('${s.id}', event)" title="${t('confirmDeleteSolution')}">×</button>
                    <div class="solution-problem">${esc(s.problem?.substring(0, 80) || '')}</div>
                    <div class="solution-fix">${esc(s.solution?.substring(0, 100) || '')}</div>
                </div>
            `).join('');
        }

        async function deleteSolution(solutionId, event) {
            event.stopPropagation();
            if (!await showConfirm(t('confirmDeleteSolution'))) return;

            try {
                await fetch(API + `/api/memory/solutions/${solutionId}`, { method: 'DELETE' });
                await loadData();
                renderHistory();
            } catch (e) {
                console.error('Failed to delete solution:', e);
            }
        }

        async function clearHistory() {
            if (!await showConfirm(t('confirmClearHistory'))) return;

            try {
                await fetch(API + '/api/memory/clear-history', { method: 'POST' });
                await loadData();
                renderHistory();
            } catch (e) {
                console.error('Failed to clear history:', e);
            }
        }

        // All Issues
        function showAllIssues() {
            const list = document.getElementById('all-issues-list');
            setText('all-issues-title', `All Issues (${issues.length})`);

            const sorted = [...issues].sort((a, b) => {
                if (a.severity === 'critical' && b.severity !== 'critical') return -1;
                if (b.severity === 'critical' && a.severity !== 'critical') return 1;
                return (b.count || 1) - (a.count || 1);
            });

            list.innerHTML = sorted.map(i => {
                const hasXray = (i.snippet?.length > 0) || (i.locals && Object.keys(i.locals).length > 0);
                const domain = i.domain || i.url?.split('/')[2] || '';
                const timeAgo = i.timestamp ? formatTimeAgo(i.timestamp) : '';
                return `
                    <div class="issue-card glass" onclick="closeAllIssues(); openDetail('${i.id}')" style="margin-bottom: 8px;">
                        <div class="issue-dot ${i.severity || 'error'}"></div>
                        <div class="issue-content">
                            <div class="issue-message">${esc(i.message)}</div>
                            <div class="issue-meta">${domain}${timeAgo ? ' · ' + timeAgo : ''}</div>
                        </div>
                        ${(i.count || 1) > 1 ? `<span class="issue-badge count">×${i.count}</span>` : ''}
                        ${hasXray ? '<span class="issue-badge">X-Ray</span>' : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('all-issues-modal').classList.add('open');
        }

        function closeAllIssues() {
            document.getElementById('all-issues-modal').classList.remove('open');
        }

        // Settings
        function openSettings() {
            loadEditorStatus();
            document.getElementById('settings-modal').classList.add('open');
        }
        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('open');
        }

        // ===== PORT DETECTION & PROJECT SWITCHING =====
        let serverConnected = false;
        let currentSiteData = null;
        let detectedPortDismissed = null;  // Track dismissed port to not show again

        async function loadCurrentSite() {
            try {
                // Get current site from extension
                const siteRes = await fetch(API + '/api/current-site');
                const siteData = await siteRes.json();

                // Get active project
                const projectRes = await fetch(API + '/api/projects/active');
                const projectData = await projectRes.json();
                activeProjectId = projectData.project_id;

                if (siteData.domain) {
                    currentSiteData = siteData;

                    // Generate project ID from the detected URL
                    const detectedProjectId = generateProjectIdFromUrl(siteData.url || siteData.domain);

                    // If different from active project, show the banner
                    if (detectedProjectId !== activeProjectId && detectedPortDismissed !== detectedProjectId) {
                        showPortDetection(siteData.domain, siteData.url);
                    } else {
                        hidePortDetection();
                    }
                } else {
                    hidePortDetection();
                }
            } catch (e) {
                console.error('Failed to load current site:', e);
                hidePortDetection();
            }
        }

        function generateProjectIdFromUrl(url) {
            try {
                const parsed = new URL(url.startsWith('http') ? url : 'http://' + url);
                let host = parsed.hostname.replace('www.', '');
                const port = parsed.port;
                if (port && port !== '80' && port !== '443') {
                    return (host + '-' + port).toLowerCase();
                }
                return host.toLowerCase();
            } catch (e) {
                return url.toLowerCase().replace(/[^a-z0-9-]/g, '-');
            }
        }

        function showPortDetection(domain, url) {
            const banner = document.getElementById('port-detected');
            const urlEl = document.getElementById('port-detected-url');
            if (banner && urlEl) {
                urlEl.textContent = domain;
                banner.classList.add('show');
                banner.dataset.url = url || domain;
            }
        }

        function hidePortDetection() {
            const banner = document.getElementById('port-detected');
            if (banner) banner.classList.remove('show');
        }

        function dismissPortDetection() {
            const banner = document.getElementById('port-detected');
            if (banner && banner.dataset.url) {
                detectedPortDismissed = generateProjectIdFromUrl(banner.dataset.url);
            }
            hidePortDetection();
        }

        async function connectToDetectedPort() {
            const banner = document.getElementById('port-detected');
            const btn = document.getElementById('port-connect-btn');
            const url = banner?.dataset.url;

            if (!url) return;

            btn.textContent = '...';

            try {
                // Switch project using the detect API
                const res = await fetch(API + '/api/projects/detect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                if (res.ok) {
                    const data = await res.json();
                    showToast('Switched to: ' + data.display_name);

                    // Hide banner and reload all data
                    hidePortDetection();
                    detectedPortDismissed = null;

                    // Reload ALL data for new project
                    await reloadAllProjectData();
                } else {
                    btn.textContent = 'Error';
                    setTimeout(() => btn.textContent = 'Connect', 2000);
                }
            } catch (e) {
                console.error('Failed to connect:', e);
                btn.textContent = 'Error';
                setTimeout(() => btn.textContent = 'Connect', 2000);
            }
        }

        // Legacy - keep for old UI
        async function connectServer() {
            await connectToDetectedPort();
        }

        function setConnected() {
            serverConnected = true;
        }

        // ===== AI MEMORY FUNCTIONS =====
        let memoryHealth = {};
        let handover = {};
        let decisions = [];
        let avoidPatterns = [];
        let lessons = [];
        let liveRecord = {};
        let insightsFilter = 'project'; // 'all' or 'project'
        let allProjectsInsights = null; // Cache for all projects insights

        function setInsightsFilter(filter) {
            insightsFilter = filter;
            document.querySelectorAll('#insights-filter .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            if (filter === 'all') {
                loadAllProjectsInsights();
            } else {
                // Reset to current project's insights
                allProjectsInsights = null;
                renderUnifiedInsights();
            }
        }

        async function loadAllProjectsInsights() {
            try {
                const res = await fetch(API + '/api/projects/all-insights');
                const data = await res.json();
                allProjectsInsights = data;
                renderUnifiedInsights();
            } catch (e) {
                console.error('Failed to load all insights:', e);
            }
        }

        // ===== LIVE RECORD (NEW) =====
        async function loadLiveRecord() {
            try {
                const res = await fetch(API + '/api/memory/live-record');
                if (!res.ok) {
                    console.error('Live Record API error:', res.status);
                    renderLiveStateDisconnected();
                    return;
                }
                const data = await res.json();
                if (data.error || data.status === 'error') {
                    console.error('Live Record error:', data.message || data.error);
                    renderLiveStateDisconnected();
                    return;
                }
                liveRecord = data;
                // Store current project dir for activity filtering
                window.currentProjectDir = data.gps?.working_dir || '';
                // Also store active project name as fallback (from activeProjectId like "localhost-3001" -> look up in projects)
                window.currentProjectName = activeProjectId || '';
                renderLiveState();
            } catch (e) {
                console.error('Failed to load live record:', e);
                renderLiveStateDisconnected();
            }
        }

        function renderLiveState() {
            const statusEl = document.getElementById('live-state-status');
            const statusText = document.getElementById('live-state-status-text');
            const mainEl = document.getElementById('live-state-main');
            const goalEl = document.getElementById('live-state-goal');
            const contextEl = document.getElementById('live-state-context');
            const archEl = document.getElementById('live-state-arch');
            const archText = document.getElementById('live-state-arch-text');

            // Safety check
            if (!statusEl || !statusText) {
                console.warn('Live State elements not found');
                return;
            }

            // Status - connected
            statusEl.className = 'live-state-status connected';
            statusText.textContent = 'Memory Active';

            // GPS Context - simplified: project name + port
            const gps = liveRecord.gps || {};
            let contextParts = [];

            // Show project name prominently
            let projectName = '';
            if (gps.working_dir) {
                const parts = gps.working_dir.split('/');
                projectName = parts[parts.length - 1] || parts[parts.length - 2] || '';
            }
            if (projectName) contextParts.push(projectName);

            // Add port if available
            if (gps.active_ports && gps.active_ports.length > 0) {
                const port = typeof gps.active_ports[0] === 'object' ? gps.active_ports[0].port : gps.active_ports[0];
                contextParts.push('port ' + port);
            }

            if (contextEl) contextEl.textContent = contextParts.join(' · ');

            // Show full path below (shortened with ~)
            const pathEl = document.getElementById('live-state-path');
            if (pathEl && gps.working_dir) {
                let displayPath = gps.working_dir;
                // Clean up path
                displayPath = displayPath.replace(/\/+$/, ''); // Remove trailing slashes
                displayPath = displayPath.replace(/~+$/, ''); // Remove trailing ~
                displayPath = displayPath.replace(/^\/Users\/[^\/]+/, '~'); // Replace /Users/username with ~
                displayPath = displayPath.replace(/\/~$/, ''); // Remove /~ at end if exists
                pathEl.textContent = displayPath;
                pathEl.style.display = 'block';
            } else if (pathEl) {
                pathEl.style.display = 'none';
            }

            // Architecture - stack info (no truncation)
            const arch = liveRecord.architecture || {};
            const stack = arch.stack || '';
            const archDesc = arch.description || arch.summary || '';

            if ((stack || archDesc) && archEl && archText) {
                let display = stack;
                if (archDesc && archDesc !== stack) {
                    display = display ? display + ' • ' + archDesc : archDesc;
                }
                archText.textContent = display;
                archEl.style.display = display ? 'block' : 'none';
            } else if (archEl) {
                archEl.style.display = 'none';
            }

            // Goal - current task (Phase 1: Make it prominent!)
            const intent = liveRecord.intent || {};
            const currentGoal = intent.current_goal || '';
            const liveStateEl = document.getElementById('live-state');
            const startBtn = document.querySelector('.live-start-btn');

            if (mainEl && goalEl) {
                if (currentGoal) {
                    goalEl.textContent = currentGoal;  // CSS adds the 🎯
                    mainEl.style.display = 'block';
                    if (liveStateEl) liveStateEl.classList.add('has-goal');
                    if (startBtn) startBtn.textContent = '▶️ המשך לעבוד';
                } else {
                    mainEl.style.display = 'none';
                    if (liveStateEl) liveStateEl.classList.remove('has-goal');
                    if (startBtn) startBtn.textContent = 'Start Session';
                }
            }
        }

        function renderLiveStateDisconnected() {
            const statusEl = document.getElementById('live-state-status');
            const statusText = document.getElementById('live-state-status-text');
            const mainEl = document.getElementById('live-state-main');
            const contextEl = document.getElementById('live-state-context');
            const insightEl = document.getElementById('live-state-insight');

            if (statusEl) statusEl.className = 'live-state-status disconnected';
            if (statusText) statusText.textContent = 'Not Connected';
            if (contextEl) contextEl.textContent = 'Connecting...';
            if (mainEl) mainEl.style.display = 'none';

            const archEl = document.getElementById('live-state-arch');
            if (archEl) archEl.style.display = 'none';
        }

        // Activity Feed
        let lastActivityId = null;

        async function loadActivityFeed() {
            try {
                const res = await fetch(API + '/api/activity/feed?limit=10');
                const data = await res.json();

                const list = document.getElementById('activity-list');
                const empty = document.getElementById('activity-empty');
                const count = document.getElementById('activity-count');

                if (!list) return;

                const activities = data.activities || [];

                // Check if anything changed
                const newFirstId = activities[0]?.id;
                if (newFirstId === lastActivityId) {
                    // Only update times, not the whole list
                    updateActivityTimes();
                    return;
                }
                lastActivityId = newFirstId;

                if (count) count.textContent = activities.length;

                // Update header based on activity
                const title = document.getElementById('activity-feed-title');
                const feedEl = document.getElementById('activity-feed');
                if (activities.length > 0) {
                    const latestTime = new Date(activities[0].timestamp);
                    const isRecent = (Date.now() - latestTime) < 60000; // Last minute
                    if (title) title.textContent = isRecent ? ('🔴 Claude working') : ('Recent Activity');
                    if (feedEl) feedEl.classList.toggle('live', isRecent);
                }

                if (activities.length === 0) {
                    if (empty) empty.style.display = 'block';
                    return;
                }

                if (empty) empty.style.display = 'none';

                // Get current active project for comparison
                const activeProjectDir = window.currentProjectDir || '';
                const activeProjectId = window.currentProjectName || '';  // e.g. "localhost-3001"

                // Helper to extract project name from path - SIMPLE & RELIABLE
                function getProjectNameFromPath(path) {
                    if (!path) return '';
                    // Look for folder after Desktop (most common)
                    const desktopMatch = path.match(/Desktop\/([^\/]+)/);
                    if (desktopMatch) return desktopMatch[1].toLowerCase();
                    // Try other common patterns
                    const patterns = [/projects\/([^\/]+)/, /repos\/([^\/]+)/, /code\/([^\/]+)/];
                    for (const p of patterns) {
                        const m = path.match(p);
                        if (m) return m[1].toLowerCase();
                    }
                    // Fallback: first folder after root
                    const parts = path.split('/').filter(p => p && p !== 'Users' && p !== 'haimdayan' && p !== 'home');
                    return (parts[0] || '').toLowerCase();
                }

                // Get current project name for filtering
                const activeProjectName = getProjectNameFromPath(activeProjectDir);

                // Check if activity belongs to current project
                function isActivityInCurrentProject(filePath, cwd) {
                    // If we don't know the current project, show all as dimmed (unknown context)
                    if (!activeProjectName) return false;
                    const activityProject = getProjectNameFromPath(filePath) || getProjectNameFromPath(cwd);
                    if (!activityProject) return false;
                    return activityProject === activeProjectName;
                }

                // Get display name for project tag
                function getProjectDisplayName(filePath, cwd) {
                    const path = filePath || cwd || '';
                    const match = path.match(/Desktop\/([^\/]+)/) || path.match(/projects\/([^\/]+)/);
                    return match ? match[1] : '?';
                }

                // Get tool display info
                function getToolInfo(tool) {
                    if (!tool) return { name: '', cssClass: '' };
                    const t = tool.toLowerCase();
                    if (t === 'edit' || t === 'write' || t === 'read') {
                        return { name: 'Claude', cssClass: 'claude' };
                    } else if (t === 'cursor') {
                        return { name: 'Cursor', cssClass: 'cursor' };
                    } else if (t === 'file_watcher' || t === 'watcher') {
                        return { name: 'Watcher', cssClass: 'watcher' };
                    }
                    return { name: tool, cssClass: '' };
                }

                // Filter out empty/invalid activities
                const validActivities = activities.filter(act => {
                    // Keep only activities with meaningful data
                    if (act.type === 'unknown' && !act.file && !act.command && !act.cwd) {
                        return false; // Skip empty entries
                    }
                    return true;
                });

                // Build activity items
                let html = '';
                validActivities.forEach((act, index) => {
                    const iconClass = act.type === 'file_change' ? 'file' : 'command';
                    const humanName = act.human_name || '';
                    const filePath = act.file || '';
                    const techName = filePath ? filePath.split('/').pop() : (act.command || '').substring(0, 40);
                    const time = formatTimeAgo(act.timestamp);
                    const isLatest = index === 0;
                    const toolInfo = getToolInfo(act.tool);

                    // Determine project
                    const projectName = getProjectDisplayName(filePath, act.cwd);
                    const isCurrentProject = isActivityInCurrentProject(filePath, act.cwd);

                    // Build classes
                    let classes = 'activity-item';
                    if (isLatest) classes += ' latest';
                    if (isCurrentProject) classes += ' current-project';
                    else classes += ' dimmed';

                    html += `
                        <div class="${classes}" data-time="${act.timestamp}" data-file="${esc(filePath)}" data-id="${esc(act.id || '')}">
                            <span class="icon-dot ${iconClass}"></span>
                            <span class="activity-item-name">
                                <span class="activity-item-name-main">
                                    ${esc(humanName || techName)}
                                    <span class="activity-item-project">${esc(projectName)}</span>
                                    ${toolInfo.name ? `<span class="activity-item-tool ${toolInfo.cssClass}">${esc(toolInfo.name)}</span>` : ''}
                                    <span class="activity-item-actions">
                                        ${filePath ? `<span class="activity-item-edit" onclick="event.stopPropagation(); openMappingModal('${esc(filePath)}', '${esc(humanName)}')" title="${'Rename'}">✎</span>` : ''}
                                        <span class="activity-item-delete" onclick="event.stopPropagation(); deleteActivity('${esc(act.id || '')}')" title="${'Delete'}">×</span>
                                    </span>
                                </span>
                                ${humanName && techName ? `<span class="activity-item-name-tech">${esc(techName)}</span>` : ''}
                                ${filePath ? `<a class="activity-item-path" href="#" onclick="event.preventDefault(); openFileInEditor('${esc(filePath)}')" title="${'Open in editor'}">${esc(filePath)}</a>` : ''}
                            </span>
                            <span class="activity-item-time">${isLatest ? ('⚡ now') : time}</span>
                        </div>
                    `;
                });

                list.innerHTML = html;

            } catch (e) {
                console.error('Failed to load activity feed:', e);
            }
        }

        function updateActivityTimes() {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => {
                const timestamp = item.dataset.time;
                const timeEl = item.querySelector('.activity-item-time');
                if (timestamp && timeEl) {
                    timeEl.textContent = formatTimeAgo(timestamp);
                }
            });
        }

        // Delete single activity
        async function deleteActivity(activityId) {
            if (!activityId) return;
            try {
                await fetch(API + '/api/activity/' + activityId, { method: 'DELETE' });
                // Remove from DOM immediately
                const item = document.querySelector(`[data-id="${activityId}"]`);
                if (item) {
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(20px)';
                    setTimeout(() => item.remove(), 200);
                }
                // Update count
                const count = document.getElementById('activity-count');
                if (count) count.textContent = Math.max(0, parseInt(count.textContent) - 1);
            } catch (e) {
                console.error('Failed to delete activity:', e);
            }
        }

        // Clear all activities
        async function clearAllActivities() {
            if (!confirm('Clear all activity history?')) return;
            try {
                await fetch(API + '/api/activity/clear', { method: 'DELETE' });
                const list = document.getElementById('activity-list');
                const empty = document.getElementById('activity-empty');
                const count = document.getElementById('activity-count');
                if (list) {
                    list.innerHTML = '';
                    if (empty) { empty.style.display = 'block'; list.appendChild(empty); }
                }
                if (count) count.textContent = '0';
                showToast('Cleared!');
            } catch (e) {
                console.error('Failed to clear activities:', e);
            }
        }

        // ===== Human UI: What Changed Today =====
        let allActivities = [];
        let allBrowserErrors = []; // Browser errors from extension
        let allInsights = []; // Insights from live record
        let allDecisions = []; // Decisions from project memory
        let showingDays = 1; // Start with today only
        let activityFilter = 'project'; // 'all' or 'project' - default to project
        let typeFilter = 'all'; // 'all', 'edit', 'write', 'bash', 'read', 'error', 'insight', 'decision'

        function setActivityFilter(filter) {
            activityFilter = filter;
            // Update button states - only in changes-filter (not all filters!)
            document.querySelectorAll('#changes-filter .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderChanges();
        }

        function setTypeFilter(type) {
            typeFilter = type;
            // Update legend item states
            document.querySelectorAll('#changes-legend .legend-item').forEach(item => {
                item.classList.toggle('active', item.dataset.type === type);
            });
            renderChanges();
        }

        function updateFilterButtonsText() {
            // Update all filter buttons across the dashboard
            document.querySelectorAll('.filter-btn[data-filter="all"]').forEach(btn => {
                btn.textContent = 'All';
            });
            document.querySelectorAll('.filter-btn[data-filter="project"]').forEach(btn => {
                btn.textContent = 'Project';
            });
        }

        async function loadChangesToday() {
            try {
                // Fetch activities, browser errors, and live record in parallel
                const [actRes, errRes, lrRes] = await Promise.all([
                    fetch(API + '/api/activity/feed?limit=50'),
                    fetch(API + '/api/live-errors').catch(() => ({ json: () => ({ errors: [] }) })),
                    fetch(API + '/api/memory/live-record').catch(() => ({ json: () => ({}) }))
                ]);

                const actData = await actRes.json();
                allActivities = actData.activities || [];

                try {
                    const errData = await errRes.json();
                    const rawErrors = errData.errors || [];

                    // Group identical errors by message
                    const errorGroups = new Map();
                    rawErrors.forEach(err => {
                        const key = (err.message || err.error || '').substring(0, 80);
                        if (!errorGroups.has(key)) {
                            errorGroups.set(key, {
                                ...err,
                                _isError: true,
                                _count: 1,
                                timestamp: err.timestamp || new Date().toISOString()
                            });
                        } else {
                            const existing = errorGroups.get(key);
                            existing._count++;
                            // Keep the most recent timestamp
                            if (new Date(err.timestamp) > new Date(existing.timestamp)) {
                                existing.timestamp = err.timestamp;
                            }
                        }
                    });
                    allBrowserErrors = Array.from(errorGroups.values());
                } catch {
                    allBrowserErrors = [];
                }

                // Extract insights and decisions from live record
                try {
                    const lrData = await lrRes.json();
                    const lessons = lrData.live_record?.lessons || lrData.lessons || {};
                    const insights = lessons.insights || [];
                    // Handle both old (string) and new (object with timestamp) formats
                    allInsights = insights.map((insight, i) => {
                        const isObject = typeof insight === 'object' && insight !== null;
                        const text = isObject ? (insight.text || insight.insight || '') : insight;
                        // Use individual timestamp if available, otherwise spread out from updated_at
                        const ts = isObject && insight.timestamp
                            ? insight.timestamp
                            : new Date(new Date(lessons.updated_at || Date.now()).getTime() - (insights.length - i) * 60000).toISOString();
                        return {
                            _isInsight: true,
                            message: text,
                            timestamp: ts,
                            id: `insight_${i}`
                        };
                    });

                    // Extract decisions
                    const decisions = lrData.decisions || [];
                    allDecisions = decisions.map((dec, i) => ({
                        _isDecision: true,
                        message: dec.decision || dec.what || '',
                        reason: dec.reason || '',
                        timestamp: dec.timestamp || new Date().toISOString(),
                        id: `decision_${i}`
                    }));
                } catch {
                    allInsights = [];
                    allDecisions = [];
                }

                renderChanges();
            } catch (e) {
                console.error('Failed to load changes:', e);
            }
        }

        function renderChanges() {
            const list = document.getElementById('changes-list');
            const empty = document.getElementById('changes-empty');
            const count = document.getElementById('changes-count');
            const footer = document.getElementById('changes-footer');

            if (!list) return;

            // Get current project path for filtering
            const currentProjectPath = window.currentProjectDir || '';

            // Filter by date range
            const now = new Date();
            const cutoffDate = new Date(now);
            cutoffDate.setDate(cutoffDate.getDate() - showingDays);
            cutoffDate.setHours(0, 0, 0, 0);

            let filtered = allActivities.filter(act => {
                const actDate = new Date(act.timestamp);
                return actDate >= cutoffDate;
            });

            // Filter browser errors by date
            let filteredErrors = allBrowserErrors.filter(err => {
                const errDate = new Date(err.timestamp);
                return errDate >= cutoffDate;
            });

            // Filter insights (always show all insights for current project)
            let filteredInsights = allInsights || [];

            // Filter by project if needed
            if (activityFilter === 'project' && currentProjectPath) {
                filtered = filtered.filter(act => {
                    const actPath = act.cwd || act.file || '';
                    return actPath.startsWith(currentProjectPath);
                });
                filteredErrors = filteredErrors.filter(err => {
                    const errUrl = err.url || err.source || '';
                    return errUrl.includes(currentProjectPath) || errUrl.includes('localhost');
                });
                // Insights are always project-specific (from live record)
            }

            // Group activities by human name to avoid duplicates
            const grouped = new Map();
            filtered.forEach(act => {
                const key = act.human_name || act.file?.split('/').pop() || act.command?.substring(0, 30) || 'unknown';
                if (!grouped.has(key)) {
                    grouped.set(key, act);
                } else {
                    // Keep the most recent
                    const existing = grouped.get(key);
                    if (new Date(act.timestamp) > new Date(existing.timestamp)) {
                        grouped.set(key, act);
                    }
                }
            });

            // Merge activities, errors, insights, and decisions, sort by timestamp
            let changes = [
                ...Array.from(grouped.values()),
                ...filteredErrors,
                ...filteredInsights,
                ...(allDecisions || [])
            ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Apply type filter
            if (typeFilter !== 'all') {
                changes = changes.filter(item => {
                    if (typeFilter === 'error') return item._isError;
                    if (typeFilter === 'insight') return item._isInsight;
                    if (typeFilter === 'decision') return item._isDecision;
                    if (typeFilter === 'edit') return !item._isError && !item._isInsight && !item._isDecision && item.tool !== 'Write' && item.tool !== 'Bash' && item.tool !== 'Read';
                    if (typeFilter === 'write') return item.tool === 'Write';
                    if (typeFilter === 'bash') return item.tool === 'Bash' || item.type === 'command';
                    if (typeFilter === 'read') return item.tool === 'Read';
                    return true;
                });
            }
            if (count) count.textContent = changes.length;

            if (changes.length === 0) {
                if (empty) {
                    empty.style.display = 'block';
                    list.innerHTML = '';
                    list.appendChild(empty);
                } else {
                    list.innerHTML = '<div style="color: #666; text-align: center; padding: 16px;">אין שינויים</div>';
                }
                if (footer) footer.style.display = 'none';
                return;
            }

            if (empty) empty.style.display = 'none';

            // Check if there are more older activities
            const hasMore = showingDays < 7 && allActivities.some(act => {
                const actDate = new Date(act.timestamp);
                return actDate < cutoffDate;
            });
            if (footer) footer.style.display = hasMore ? 'block' : 'none';

            // Sensitive patterns
            const sensitivePatterns = /auth|login|password|payment|billing|credit|admin|security|secret|database|migration|env|config/i;

            let html = '';
            changes.forEach((act, index) => {
                const actTime = new Date(act.timestamp);
                const isRecent = (now - actTime) < 60000; // 60 seconds
                const time = formatTimeAgo(act.timestamp);

                // Handle browser errors
                if (act._isError) {
                    const errMsg = act.message || act.error || 'Unknown error';
                    const errShort = errMsg.substring(0, 50) + (errMsg.length > 50 ? '...' : '');
                    const errSource = act.source || act.url || '';
                    const sourceShort = errSource.split('/').pop()?.substring(0, 30) || 'Browser';

                    // Safely stringify error for onclick
                    const safeErr = {
                        id: act.id || 'err_' + Date.now(),
                        message: errMsg,
                        source: errSource,
                        timestamp: act.timestamp,
                        _isError: true
                    };
                    const errJson = JSON.stringify(safeErr).replace(/"/g, '&quot;');

                    const countBadge = act._count > 1 ? `<span style="background: rgba(231,111,81,0.2); color: #e76f51; padding: 2px 6px; border-radius: 10px; font-size: 0.65rem; margin-right: 6px;">×${act._count}</span>` : '';

                    html += `
                        <div class="change-item error-item ${isRecent ? 'recent' : ''}" onclick="openDrawer('${esc(safeErr.id)}', ${errJson})">
                            <div class="change-icon error"></div>
                            <div class="change-info">
                                <div class="change-name"><span class="change-action" style="color: #e76f51;">Error</span> ${esc(sourceShort)}${countBadge}</div>
                                <div class="change-time" style="color: #e76f51;">${esc(errShort)}</div>
                            </div>
                            ${isRecent ? '<span class="live-badge" style="background: rgba(231,111,81,0.15); color: #e76f51;">⚡</span>' : ''}
                        </div>
                    `;
                    return;
                }

                // Handle insights
                if (act._isInsight) {
                    const insightMsg = act.message || 'תובנה';
                    const insightShort = insightMsg.length > 60 ? insightMsg.substring(0, 60) + '...' : insightMsg;

                    html += `
                        <div class="change-item insight-item">
                            <div class="change-icon insight"></div>
                            <div class="change-info">
                                <div class="change-name"><span class="change-action" style="color: #ffd93d;">💡 תובנה</span></div>
                                <div class="change-time" style="color: #ccc;">${esc(insightShort)}</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Handle decisions
                if (act._isDecision) {
                    const decMsg = act.message || 'החלטה';
                    const decShort = decMsg.length > 50 ? decMsg.substring(0, 50) + '...' : decMsg;

                    html += `
                        <div class="change-item decision-item" style="background: rgba(107,207,255,0.05); border-right: 3px solid #6bcfff;">
                            <div class="change-icon decision"></div>
                            <div class="change-info">
                                <div class="change-name"><span class="change-action" style="color: #6bcfff;">⚡ החלטה</span></div>
                                <div class="change-time" style="color: #ccc;">${esc(decShort)}</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                const fileName = act.file ? act.file.split('/').pop() : '';
                const fileNameNoExt = fileName.replace(/\.[^.]+$/, '');
                const humanName = act.human_name || fileNameNoExt || '';
                const fileContext = act.file_context || '';
                const diff = act.diff || {};
                const isSensitive = sensitivePatterns.test(act.file || '') || sensitivePatterns.test(humanName);

                // Build diff stats string: "(+12, -3)"
                let diffStr = '';
                if (diff.added || diff.removed) {
                    const parts = [];
                    if (diff.added) parts.push(`+${diff.added}`);
                    if (diff.removed) parts.push(`-${diff.removed}`);
                    diffStr = ` (${parts.join(', ')})`;
                }

                // Icon and action verb based on type + file context
                let iconClass = 'edit';
                let actionVerb = '';

                if (act.type === 'command' || act.tool === 'Bash') {
                    iconClass = 'bash';
                    // For commands, show the command itself
                    const cmdShort = act.command?.substring(0, 35) || '';
                    const cmdDisplay = cmdShort + (act.command?.length > 35 ? '...' : '');
                    actionVerb = `Ran command`;

                    html += `
                        <div class="change-item ${isRecent ? 'recent' : ''}" onclick="openDrawer('${esc(act.id || '')}', ${JSON.stringify(act).replace(/"/g, '&quot;')})">
                            <div class="change-icon ${iconClass}"></div>
                            <div class="change-info">
                                <div class="change-name"><span class="change-action">${actionVerb}</span> ${isRecent ? '<span class="live-badge">⚡</span>' : ''}</div>
                                <div class="change-time">${esc(cmdDisplay)}</div>
                            </div>
                        </div>
                    `;
                    return; // Skip the rest for commands
                } else if (act.tool === 'Write') {
                    iconClass = 'write';
                    actionVerb = fileContext ? `Created ${fileContext}` : 'Created';
                } else if (act.tool === 'Read') {
                    iconClass = 'read';
                    actionVerb = 'Read';
                } else {
                    // Edit
                    actionVerb = fileContext ? `Updated ${fileContext}` : 'Updated';
                }

                html += `
                    <div class="change-item ${isRecent ? 'recent' : ''}" onclick="openDrawer('${esc(act.id || '')}', ${JSON.stringify(act).replace(/"/g, '&quot;')})">
                        <div class="change-icon ${iconClass}"></div>
                        <div class="change-info">
                            <div class="change-name"><span class="change-action">${actionVerb}</span> ${esc(humanName)}${diffStr}</div>
                            <div class="change-time">${isRecent ? '⚡ עכשיו' : time}</div>
                        </div>
                        ${isSensitive ? '<span class="change-badge sensitive">רגיש</span>' : ''}
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        function loadMoreChanges() {
            if (showingDays < 7) {
                showingDays = 7;
                document.getElementById('show-more-btn').textContent = 'Showing 7 days';
                renderChanges();
            }
        }

        // ===== Technical Drawer =====
        let currentDrawerActivity = null;

        function openDrawer(activityId, activityData) {
            currentDrawerActivity = activityData;
            const drawer = document.getElementById('tech-drawer');
            const overlay = document.getElementById('drawer-overlay');
            const content = document.getElementById('drawer-content');

            if (!drawer || !content) return;

            const act = activityData;
            const fileName = act.file ? act.file.split('/').pop() : '';
            const componentName = act.human_name || fileName.replace(/\.[^.]+$/, '') || act.command?.substring(0, 20) || '';
            const fileContext = act.file_context || '';
            const diff = act.diff || {};
            const timeAgo = formatTimeAgo(act.timestamp);

            // Build human-readable action sentence with context
            let actionVerb = 'edited';
            let actionObject = '';
            if (act.tool === 'Write') {
                actionVerb = 'created';
            } else if (act.type === 'command' || act.tool === 'Bash') {
                actionVerb = 'ran a command';
                actionObject = '';
            } else if (act.tool === 'Read') {
                actionVerb = 'read';
            }

            // Add file context to action if available
            let contextStr = fileContext ? ` (${fileContext})` : '';

            // Build diff display
            let diffHtml = '';
            if (diff.added || diff.removed) {
                diffHtml = `
                <div class="drawer-section">
                    <div class="drawer-label">${'Changes'}</div>
                    <div class="drawer-diff">
                        ${diff.added ? `<span class="diff-added">+${diff.added}</span>` : ''}
                        ${diff.removed ? `<span class="diff-removed">-${diff.removed}</span>` : ''}
                        <span class="diff-label">${'lines'}</span>
                    </div>
                </div>
                `;
            }

            // Handle errors, insights, decisions differently
            if (act._isError) {
                content.innerHTML = `
                    <div class="drawer-hero" style="border-right: 3px solid #e76f51;">
                        <div class="drawer-hero-text" style="color: #e76f51;">
                            שגיאה בדפדפן
                        </div>
                    </div>
                    <div class="drawer-divider"></div>
                    <div class="drawer-section">
                        <div class="drawer-label">סוג</div>
                        <div class="drawer-value">${esc(act.type || 'error')}</div>
                    </div>
                    <div class="drawer-section">
                        <div class="drawer-label">הודעה</div>
                        <div class="drawer-value" style="color: #e76f51; white-space: pre-wrap;">${esc(act.message || '')}</div>
                    </div>
                    ${act.source || act.url ? `
                    <div class="drawer-section">
                        <div class="drawer-label">מקור</div>
                        <div class="drawer-value mono">${esc(act.source || act.url || '')}</div>
                    </div>
                    ` : ''}
                    <div class="drawer-section">
                        <div class="drawer-label">זמן</div>
                        <div class="drawer-value">${formatTimeFull(act.timestamp)}</div>
                    </div>
                `;
            } else if (act._isInsight) {
                content.innerHTML = `
                    <div class="drawer-hero" style="border-right: 3px solid #f4a261;">
                        <div class="drawer-hero-text" style="color: #f4a261;">
                            💡 תובנה
                        </div>
                    </div>
                    <div class="drawer-divider"></div>
                    <div class="drawer-section">
                        <div class="drawer-label">תוכן</div>
                        <div class="drawer-value" style="line-height: 1.6; white-space: pre-wrap;">${esc(act.message || '')}</div>
                    </div>
                    <div class="drawer-section">
                        <div class="drawer-label">זמן</div>
                        <div class="drawer-value">${formatTimeFull(act.timestamp)}</div>
                    </div>
                `;
            } else if (act._isDecision) {
                content.innerHTML = `
                    <div class="drawer-hero" style="border-right: 3px solid #81b29a;">
                        <div class="drawer-hero-text" style="color: #81b29a;">
                            📌 החלטה
                        </div>
                    </div>
                    <div class="drawer-divider"></div>
                    <div class="drawer-section">
                        <div class="drawer-label">החלטה</div>
                        <div class="drawer-value" style="font-weight: 500;">${esc(act.decision || act.message || '')}</div>
                    </div>
                    ${act.reason ? `
                    <div class="drawer-section">
                        <div class="drawer-label">סיבה</div>
                        <div class="drawer-value" style="color: #888;">${esc(act.reason)}</div>
                    </div>
                    ` : ''}
                    <div class="drawer-section">
                        <div class="drawer-label">זמן</div>
                        <div class="drawer-value">${formatTimeFull(act.timestamp)}</div>
                    </div>
                `;
            } else {
                // Regular file activity
                content.innerHTML = `
                    <div class="drawer-hero">
                        <div class="drawer-hero-text">
                            AI ${actionVerb} <strong>"${esc(componentName)}"</strong>${contextStr}
                        </div>
                    </div>

                    <div class="drawer-divider"></div>

                    <div class="drawer-section">
                        <div class="drawer-label">קומפוננטה</div>
                        <div class="drawer-value">${esc(act.human_name || fileName.replace(/\.[^.]+$/, ''))}</div>
                    </div>

                    ${act.file ? `
                    <div class="drawer-section">
                        <div class="drawer-label">קובץ</div>
                        <div class="drawer-value mono">${esc(fileName)}</div>
                    </div>

                    <div class="drawer-section">
                        <div class="drawer-label">נתיב מלא</div>
                        <div class="drawer-value mono" style="font-size: 0.7rem; word-break: break-all;">${esc(act.file)}</div>
                    </div>
                    ` : ''}

                    ${diffHtml}

                    ${act.command ? `
                    <div class="drawer-section">
                        <div class="drawer-label">פקודה</div>
                        <div class="drawer-value mono">${esc(act.command)}</div>
                    </div>
                    ` : ''}

                    <div class="drawer-section">
                        <div class="drawer-label">זמן</div>
                        <div class="drawer-value">${formatTimeFull(act.timestamp)}</div>
                    </div>

                    ${act.file ? `
                    <button class="drawer-action-btn" onclick="openFileInEditor('${esc(act.file)}')">
                        פתח ב-VS Code
                    </button>
                    ` : ''}

                    ${act.file ? `
                    <button class="drawer-action-btn secondary" onclick="openMappingModal('${esc(act.file)}', '${esc(act.human_name || '')}'); closeDrawer();">
                        שנה שם קומפוננטה
                    </button>
                    ` : ''}
                `;
            }

            drawer.classList.add('open');
            overlay.classList.add('open');
        }

        function closeDrawer() {
            const drawer = document.getElementById('tech-drawer');
            const overlay = document.getElementById('drawer-overlay');
            if (drawer) drawer.classList.remove('open');
            if (overlay) overlay.classList.remove('open');
            currentDrawerActivity = null;
        }

        // ===== Browser Errors Feed =====
        let errorsFilter = 'all'; // 'all' or 'project'

        function setErrorsFilter(filter) {
            errorsFilter = filter;
            document.querySelectorAll('#errors-filter .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadBrowserErrors();
        }

        async function loadBrowserErrors() {
            try {
                const res = await fetch(API + '/api/live-errors');
                const data = await res.json();
                let errors = data.errors || [];

                // Filter by project if needed
                const currentProjectPath = window.currentProjectDir || '';
                if (errorsFilter === 'project' && currentProjectPath) {
                    errors = errors.filter(err => {
                        const errUrl = err.url || '';
                        const errFile = err.file || '';
                        // Check if error is from current project (by URL port or file path)
                        return errUrl.includes('localhost') || errFile.startsWith(currentProjectPath);
                    });
                }

                const list = document.getElementById('browser-errors-list');
                const empty = document.getElementById('browser-errors-empty');
                const count = document.getElementById('browser-errors-count');

                if (!list) return;

                if (errors.length === 0) {
                    list.innerHTML = '';
                    if (empty) { empty.style.display = 'block'; list.appendChild(empty); }
                    if (count) count.textContent = '0';
                    return;
                }

                if (empty) empty.style.display = 'none';
                if (count) count.textContent = errors.length;

                let html = '';
                errors.slice(0, 10).forEach((err, index) => {
                    const time = formatTimeAgo(err.timestamp);
                    const severity = err.severity || 'error';
                    const severityClass = severity === 'critical' ? 'critical' : (severity === 'warning' ? 'warning' : 'error');
                    const msg = (err.message || '').substring(0, 80);
                    const hasSolution = err.previous_solution || err.matched_solution;

                    // Extract domain from URL
                    let source = '';
                    if (err.url) {
                        try {
                            const url = new URL(err.url);
                            source = url.host;
                        } catch { source = err.url.substring(0, 30); }
                    }

                    html += `
                        <div class="activity-item ${index === 0 ? 'latest' : ''} ${hasSolution ? 'has-solution' : ''}">
                            <span class="icon-dot ${severityClass}"></span>
                            <span class="activity-item-name">
                                <span class="activity-item-name-main">
                                    ${esc(msg)}
                                    ${source ? `<span class="error-source">${esc(source)}</span>` : ''}
                                    ${hasSolution ? '<span class="solution-badge">Has Solution</span>' : ''}
                                </span>
                                <span class="activity-item-name-tech">${esc(err.type || 'error')}${err.file ? ' @ ' + esc(err.file) : ''}</span>
                            </span>
                            <span class="activity-item-time">${time}</span>
                        </div>
                    `;
                });

                list.innerHTML = html;

            } catch (e) {
                console.error('Failed to load browser errors:', e);
            }
        }

        async function clearBrowserErrors() {
            if (!confirm('Clear all errors?')) return;
            try {
                await fetch(API + '/api/clear-logs', { method: 'POST' });
                const list = document.getElementById('browser-errors-list');
                const empty = document.getElementById('browser-errors-empty');
                const count = document.getElementById('browser-errors-count');
                if (list) {
                    list.innerHTML = '';
                    if (empty) { empty.style.display = 'block'; list.appendChild(empty); }
                }
                if (count) count.textContent = '0';
                showToast('Cleared!');
            } catch (e) {
                console.error('Failed to clear browser errors:', e);
            }
        }

        // Component Mapping Modal
        let currentMappingFile = '';

        function openMappingModal(filePath, currentName) {
            currentMappingFile = filePath;
            const modal = document.getElementById('mapping-modal');
            const fileEl = document.getElementById('mapping-file');
            const input = document.getElementById('mapping-input');

            if (fileEl) fileEl.textContent = filePath.split('/').pop();
            if (input) {
                input.value = currentName;
                input.focus();
            }
            if (modal) modal.classList.add('open');
        }

        function closeMappingModal(event) {
            if (event && event.target.id !== 'mapping-modal') return;
            const modal = document.getElementById('mapping-modal');
            if (modal) modal.classList.remove('open');
            currentMappingFile = '';
        }

        async function saveMapping() {
            const input = document.getElementById('mapping-input');
            const newName = input?.value?.trim();

            if (!newName || !currentMappingFile) {
                closeMappingModal();
                return;
            }

            try {
                // Extract pattern from file path
                const fileName = currentMappingFile.split('/').pop();
                const pattern = fileName.replace(/\.(tsx?|jsx?|vue|svelte|py|rb|go|rs|java|kt)$/i, '').toLowerCase();

                await fetch(API + '/api/components/map', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_pattern: pattern,
                        display_name: newName
                    })
                });

                // Refresh activity feed to show new name
                lastActivityId = null; // Force refresh
                loadActivityFeed();

                closeMappingModal();

            } catch (e) {
                console.error('Failed to save mapping:', e);
            }
        }

        // Handle Enter key in mapping input
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('mapping-modal')?.classList.contains('open')) {
                saveMapping();
            }
            if (e.key === 'Escape') {
                closeMappingModal();
            }
        });

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);

            if (diffSec < 60) return 'now';
            if (diffMin < 60) return diffMin + ('m');
            if (diffHour < 24) return diffHour + ('h');
            return then.toLocaleDateString();
        }

        async function confirmReset() {
            const message = 'This will clear the Live Record (not decisions)';
            const title = 'Start fresh?';
            const confirmed = await showConfirm(message, title);

            if (confirmed) {
                try {
                    await fetch(API + '/api/memory/live-record/gps', { method: 'DELETE' });
                    await fetch(API + '/api/memory/live-record/intent', { method: 'DELETE' });
                    await fetch(API + '/api/memory/live-record/lessons', { method: 'DELETE' });
                    await fetch(API + '/api/memory/live-record/architecture', { method: 'DELETE' });
                    showToast('Memory reset');
                    await loadLiveRecord();
                } catch (e) {
                    console.error('Failed to reset:', e);
                    showToast('Error: ' + e.message);
                }
            }
        }

        async function loadMemoryData() {
            try {
                // Load memory health
                const healthRes = await fetch(API + '/api/memory/health');
                memoryHealth = await healthRes.json();
                renderMemoryHealth();

                // Load handover
                const handoverRes = await fetch(API + '/api/memory/handover');
                const handoverData = await handoverRes.json();
                handover = handoverData.handover || {};
                renderHandover();

                // Load decisions
                const decisionsRes = await fetch(API + '/api/memory/decisions');
                const decisionsData = await decisionsRes.json();
                decisions = decisionsData.decisions || [];
                renderDecisions();

                // Load avoid patterns
                const avoidRes = await fetch(API + '/api/memory/avoid');
                const avoidData = await avoidRes.json();
                avoidPatterns = avoidData.avoid || [];
                renderAvoid();

                // Load lessons from live-record
                const liveRecordRes = await fetch(API + '/api/memory/live-record');
                const liveRecordData = await liveRecordRes.json();
                lessons = liveRecordData.lessons?.insights || [];
                renderLessons();

                // Update unified insights count
                updateInsightsCount();
            } catch (e) {
                console.error('Failed to load memory data:', e);
            }
        }

        function renderMemoryHealth() {
            const fill = document.getElementById('memory-health-fill');
            const status = document.getElementById('memory-health-status');
            const percent = memoryHealth.fullness_percent || 0;

            fill.style.width = percent + '%';
            fill.className = 'memory-health-fill ' + (percent < 50 ? 'low' : percent < 80 ? 'medium' : 'high');

            // Build status text
            let statusText = '';
            const h = memoryHealth.handover || {};
            if (h.status === 'fresh') {
                statusText = t('memoryReady');
            } else if (h.status === 'stale') {
                statusText = t('memoryStale');
            } else if (h.exists) {
                statusText = `${h.age_hours}h ago`;
            } else {
                statusText = t('noHandover');
            }
            status.textContent = statusText;
        }

        function renderHandover() {
            const content = document.getElementById('handover-content');
            const time = document.getElementById('handover-time');

            if (handover && handover.summary) {
                content.innerHTML = esc(handover.summary);
                if (handover.created_at) {
                    time.textContent = formatTimeAgo(handover.created_at);
                }
            } else {
                content.innerHTML = `<span class="handover-empty">${t('noHandover')}</span>`;
                time.textContent = '';
            }
        }

        function renderDecisions() { renderUnifiedInsights(); }
        function renderAvoid() { renderUnifiedInsights(); }
        function renderLessons() { renderUnifiedInsights(); }

        function renderUnifiedInsights() {
            const list = document.getElementById('unified-insights-list');
            if (!list) return;

            const items = [];

            // Use all projects data or current project based on filter
            const useAll = insightsFilter === 'all' && allProjectsInsights;
            const lessonsData = useAll ? allProjectsInsights.insights : lessons;
            const decisionsData = useAll ? allProjectsInsights.decisions : decisions;
            const avoidData = useAll ? allProjectsInsights.avoid : avoidPatterns;

            // Add lessons with type indicator
            (lessonsData || []).forEach((lesson, idx) => {
                const text = typeof lesson === 'string' ? lesson : lesson.text || lesson.insight || JSON.stringify(lesson);
                const projectName = lesson.project_name || '';
                items.push({
                    type: 'lesson',
                    html: `
                        <div class="memory-card lesson glass">
                            <span class="insight-type-dot lesson"></span>
                            <div class="memory-card-header">
                                <span class="memory-card-title">${esc(text)}</span>
                                ${useAll && projectName ? `<span class="memory-card-project">${esc(projectName)}</span>` : ''}
                            </div>
                        </div>
                    `
                });
            });

            // Add decisions with type indicator
            (decisionsData || []).forEach(d => {
                const projectName = d.project_name || '';
                const canDelete = !useAll; // Only allow delete in project mode
                items.push({
                    type: 'decision',
                    html: `
                        <div class="memory-card decision glass">
                            <span class="insight-type-dot decision"></span>
                            ${canDelete ? `<button class="memory-card-delete" onclick="deleteDecision('${d.id}', event)">×</button>` : ''}
                            <div class="memory-card-header">
                                <span class="memory-card-title">${esc(d.decision)}</span>
                                <span class="memory-card-badge ${d.used_by_ai ? 'used' : 'unused'}">
                                    ${d.used_by_ai ? '✓' : ''}
                                </span>
                                ${useAll && projectName ? `<span class="memory-card-project">${esc(projectName)}</span>` : ''}
                            </div>
                            <div class="memory-card-reason">${esc(d.reason)}</div>
                        </div>
                    `
                });
            });

            // Add avoid patterns with type indicator
            (avoidData || []).forEach(a => {
                const projectName = a.project_name || '';
                const canDelete = !useAll; // Only allow delete in project mode
                items.push({
                    type: 'avoid',
                    html: `
                        <div class="memory-card avoid glass">
                            <span class="insight-type-dot avoid"></span>
                            ${canDelete ? `<button class="memory-card-delete" onclick="deleteAvoid('${a.id}', event)">×</button>` : ''}
                            <div class="memory-card-header">
                                <span class="memory-card-title">${esc(a.what)}</span>
                                <span class="memory-card-badge ${a.used_by_ai ? 'used' : 'unused'}">
                                    ${a.used_by_ai ? '✓' : ''}
                                </span>
                                ${useAll && projectName ? `<span class="memory-card-project">${esc(projectName)}</span>` : ''}
                            </div>
                            <div class="memory-card-reason">${esc(a.reason)}</div>
                        </div>
                    `
                });
            });

            if (items.length === 0) {
                const emptyMsg = useAll
                    ? ('No insights in any project')
                    : ('No insights yet');
                list.innerHTML = `<div class="insights-empty">${emptyMsg}</div>`;
            } else {
                list.innerHTML = items.map(i => i.html).join('');
            }

            updateInsightsCount();
        }

        function updateInsightsCount() {
            const count = document.getElementById('insights-count');
            if (count) {
                let total;
                if (insightsFilter === 'all' && allProjectsInsights) {
                    total = allProjectsInsights.total || 0;
                } else {
                    total = (lessons?.length || 0) + (decisions?.length || 0) + (avoidPatterns?.length || 0);
                }
                count.textContent = total;
            }
        }

        // Toggle section collapse (legacy - renamed to avoid conflict)
        function toggleSectionLegacy(section) {
            const header = document.querySelector(`#${section}-content`).previousElementSibling;
            const content = document.getElementById(`${section}-content`);
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        // Copy context for AI (non-MCP users like Cursor)
        async function copyContextForAI() {
            try {
                // Use live-record summary for most up-to-date context
                const res = await fetch(API + '/api/memory/live-record/summary');
                let text = await res.text();

                // Also add decisions
                try {
                    const decRes = await fetch(API + '/api/memory/decisions');
                    const decisions = await decRes.json();
                    if (decisions && decisions.length > 0) {
                        text += '\n\n## Key Decisions\n';
                        decisions.slice(-5).forEach(d => {
                            text += `- **${d.decision}**: ${d.reason}\n`;
                        });
                    }
                } catch (e) {}

                await navigator.clipboard.writeText(text);
                showToast(t('copiedToClipboard'));
            } catch (e) {
                console.error('Failed to copy context:', e);
                showToast('Failed to copy');
            }
        }

        // Clear handover
        async function clearHandover() {
            if (!await showConfirm(t('confirmClearHandover'))) return;

            try {
                await fetch(API + '/api/memory/handover', { method: 'DELETE' });
                await loadMemoryData();
            } catch (e) {
                console.error('Failed to clear handover:', e);
            }
        }

        // Decision modal
        function openAddDecision() {
            document.getElementById('decision-what').value = '';
            document.getElementById('decision-why').value = '';
            document.getElementById('add-decision-modal').classList.add('open');
        }

        function closeAddDecision() {
            document.getElementById('add-decision-modal').classList.remove('open');
        }

        async function submitDecision() {
            const what = document.getElementById('decision-what').value.trim();
            const why = document.getElementById('decision-why').value.trim();

            if (!what || !why) return;

            try {
                await fetch(API + '/api/memory/decisions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision: what, reason: why })
                });
                closeAddDecision();
                await loadMemoryData();
            } catch (e) {
                console.error('Failed to add decision:', e);
            }
        }

        async function deleteDecision(id, event) {
            event.stopPropagation();
            if (!await showConfirm(t('confirmDeleteDecision'))) return;

            try {
                await fetch(API + `/api/memory/decisions/${id}`, { method: 'DELETE' });
                await loadMemoryData();
            } catch (e) {
                console.error('Failed to delete decision:', e);
            }
        }

        // Avoid modal
        function openAddAvoid() {
            document.getElementById('avoid-what').value = '';
            document.getElementById('avoid-why').value = '';
            document.getElementById('add-avoid-modal').classList.add('open');
        }

        function closeAddAvoid() {
            document.getElementById('add-avoid-modal').classList.remove('open');
        }

        async function submitAvoid() {
            const what = document.getElementById('avoid-what').value.trim();
            const why = document.getElementById('avoid-why').value.trim();

            if (!what || !why) return;

            try {
                await fetch(API + '/api/memory/avoid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ what: what, reason: why })
                });
                closeAddAvoid();
                await loadMemoryData();
            } catch (e) {
                console.error('Failed to add avoid pattern:', e);
            }
        }

        async function deleteAvoid(id, event) {
            event.stopPropagation();
            if (!await showConfirm(t('confirmDeleteAvoid'))) return;

            try {
                await fetch(API + `/api/memory/avoid/${id}`, { method: 'DELETE' });
                await loadMemoryData();
            } catch (e) {
                console.error('Failed to delete avoid pattern:', e);
            }
        }

        // Auto-detect project
        async function detectProject() {
            try {
                const res = await fetch(API + '/api/memory/detect', { method: 'POST' });
                const data = await res.json();

                if (data.status === 'updated') {
                    showToast(`${t('stackDetected')} ${data.stack.join(', ')}`);
                    await loadData();
                } else {
                    showToast(t('noStackFound'));
                }
            } catch (e) {
                console.error('Failed to detect project:', e);
            }
        }

        // Export memory
        function exportMemory() {
            window.location.href = API + '/api/memory/export';
            showToast(t('exportSuccess'));
        }

        // Import memory
        async function importMemory(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                const res = await fetch(API + '/api/memory/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showToast(t('importSuccess'));
                    await loadData();
                    await loadMemoryData();
                } else {
                    showToast(t('importError'));
                }
            } catch (e) {
                console.error('Import failed:', e);
                showToast(t('importError'));
            }

            // Reset file input
            event.target.value = '';
        }

        // ===== EDITOR SETUP RULES =====
        const EDITOR_RULES = {
            cursor: `# FixOnce - AI Memory Protocol

You have FixOnce MCP tools. On ANY greeting (hi, hello, hey):

1. Silently call these MCP tools:
   - get_project_context_tool()
   - get_last_handover()
   - get_avoid_patterns()

2. Present:
   Hi! FixOnce connected me to project [name].
   Context: [stack] - [focus]
   House rules: [one key decision]
   Where we left off: [handover summary]
   What's next?

3. During work:
   - Before fixing errors: call search_past_solutions() first
   - After fixing: call update_solution_status() with keywords
   - Made a decision: call log_project_decision()

4. On exit (bye, done):
   - Call create_handover() with summary
   - Say brief goodbye: "All saved, see you!"

Core principle: Never debug the same bug twice.`,

            copilot: `# FixOnce - AI Memory Protocol

You have FixOnce MCP tools. On ANY greeting (hi, hello, hey):

1. Silently call these MCP tools:
   - get_project_context_tool()
   - get_last_handover()
   - get_avoid_patterns()

2. Present:
   Hi! FixOnce connected me to project [name].
   Context: [stack] - [focus]
   House rules: [one key decision]
   Where we left off: [handover summary]
   What's next?

3. During work:
   - Before fixing errors: call search_past_solutions() first
   - After fixing: call update_solution_status() with keywords

4. On exit (bye, done):
   - Call create_handover() with summary

Core principle: Never debug the same bug twice.`,

            continue: `{
  "customInstructions": "You have FixOnce MCP. On any greeting: call get_project_context_tool(), get_last_handover(), get_avoid_patterns(). Present with project name, stack, handover. Before fixing: search_past_solutions(). After fixing: update_solution_status(). On exit: create_handover()."
}`
        };

        const EDITOR_INSTRUCTIONS = {
            cursor: 'Cursor → Settings (⌘,) → Rules for AI → Paste',
            copilot: 'VS Code → Copilot Chat → Paste at start',
            continue: 'Add to ~/.continue/config.json'
        };

        async function copyRulesFor(editor) {
            const rules = EDITOR_RULES[editor];
            const instructions = EDITOR_INSTRUCTIONS[editor];

            try {
                await navigator.clipboard.writeText(rules);
                showToast(`Copied! ${instructions}`);
                // Show usage tip for non-Claude editors
                if (editor !== 'claude') {
                    document.getElementById('usage-tip').style.display = 'block';
                }
            } catch (e) {
                // Fallback: show in prompt
                prompt(`Copy manually (${instructions}):`, rules);
            }
        }

        // ===== SAFETY SWITCH =====
        let safetySettings = { enabled: true, auto_backup: true, require_approval: true };
        let pendingChanges = [];

        async function loadSafetyData() {
            try {
                // Load settings
                const settingsRes = await fetch(API + '/api/safety/settings');
                safetySettings = await settingsRes.json();

                // Update toggle
                const toggle = document.getElementById('safety-toggle');
                toggle.classList.toggle('on', safetySettings.enabled);

                const statusText = document.getElementById('safety-status-text');
                if (safetySettings.enabled) {
                    statusText.textContent = 'Preview & approve changes';
                    statusText.classList.remove('off');
                } else {
                    statusText.textContent = 'Off - changes applied directly';
                    statusText.classList.add('off');
                }

                // Load pending changes
                const pendingRes = await fetch(API + '/api/safety/changes/pending');
                const pendingData = await pendingRes.json();
                pendingChanges = pendingData.changes || [];

                // Update count badge
                setText('safety-pending-count', pendingChanges.length);

                // Render pending changes
                renderPendingChanges();
            } catch (e) {
                console.error('Failed to load safety data:', e);
            }
        }

        async function toggleSafety() {
            const newState = !safetySettings.enabled;
            try {
                await fetch(API + '/api/safety/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: newState })
                });
                await loadSafetyData();
                showToast(newState ? ('Safety Switch enabled') : ('Safety Switch disabled'));
            } catch (e) {
                console.error('Failed to toggle safety:', e);
            }
        }

        function renderPendingChanges() {
            const container = document.getElementById('pending-changes-container');
            const noPending = document.getElementById('no-pending-text');

            if (!pendingChanges || pendingChanges.length === 0) {
                container.innerHTML = `<div class="no-pending" id="no-pending-text">${'No pending changes'}</div>`;
                return;
            }

            let html = '';
            pendingChanges.forEach(change => {
                const fileName = change.file_path.split('/').pop();
                const statusClass = change.status === 'approved' ? 'approved' : '';
                const statusText = change.status === 'approved' ? ('Approved') : ('Pending');

                html += `
                    <div class="pending-card">
                        <div class="pending-header">
                            <span class="pending-file">${fileName}</span>
                            <span class="pending-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="pending-desc">${change.description || 'Code change'}</div>
                        <div class="pending-actions">
                            <button class="pending-btn preview" onclick="previewChange('${change.id}')">
                                ${'Preview'}
                            </button>
                            <button class="pending-btn approve" onclick="approveAndApply('${change.id}')">
                                ${'Approve & Apply'}
                            </button>
                            <button class="pending-btn reject" onclick="rejectChange('${change.id}')">
                                ${'Reject'}
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function previewChange(changeId) {
            const change = pendingChanges.find(c => c.id === changeId);
            if (!change) return;

            setText('diff-file', change.file_path);
            setText('diff-desc', change.description || '');
            const changeIdInput = document.getElementById('diff-change-id');
            if (changeIdInput) changeIdInput.value = changeId;

            // Render diff
            const diffViewer = document.getElementById('diff-viewer');
            const diffText = change.diff_preview || change.diff || '';

            let html = '';
            diffText.split('\n').forEach(line => {
                let lineClass = 'context';
                if (line.startsWith('+') && !line.startsWith('+++')) {
                    lineClass = 'add';
                } else if (line.startsWith('-') && !line.startsWith('---')) {
                    lineClass = 'remove';
                } else if (line.startsWith('@@') || line.startsWith('---') || line.startsWith('+++')) {
                    lineClass = 'header';
                }
                html += `<div class="diff-line ${lineClass}">${escapeHtml(line)}</div>`;
            });

            diffViewer.innerHTML = html || '<div class="diff-line context">No diff available</div>';
            document.getElementById('diff-modal').classList.add('open');
        }

        function closeDiffModal() {
            document.getElementById('diff-modal').classList.remove('open');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function approveAndApply(changeId) {
            try {
                // First approve
                await fetch(API + `/api/safety/changes/${changeId}/approve`, { method: 'POST' });
                // Then apply
                const res = await fetch(API + `/api/safety/changes/${changeId}/apply`, { method: 'POST' });
                const result = await res.json();

                if (result.status === 'ok') {
                    showToast('Change applied successfully!');
                } else {
                    showToast(result.message || 'Failed to apply change');
                }

                await loadSafetyData();
            } catch (e) {
                console.error('Failed to approve and apply:', e);
                showToast('Error applying change');
            }
        }

        async function approveAndApplyFromModal() {
            const changeId = document.getElementById('diff-change-id').value;
            closeDiffModal();
            await approveAndApply(changeId);
        }

        async function rejectChange(changeId) {
            if (!await showConfirm('Reject this change?')) return;

            try {
                await fetch(API + `/api/safety/changes/${changeId}/reject`, { method: 'POST' });
                showToast('Change rejected');
                await loadSafetyData();
            } catch (e) {
                console.error('Failed to reject change:', e);
            }
        }

        async function rejectChangeFromModal() {
            const changeId = document.getElementById('diff-change-id').value;
            closeDiffModal();
            await rejectChange(changeId);
        }

        async function openChangeHistory() {
            try {
                const res = await fetch(API + '/api/safety/history?limit=20');
                const data = await res.json();
                const history = data.history || [];

                const container = document.getElementById('change-history-list');

                if (history.length === 0) {
                    container.innerHTML = `<div class="no-pending">${'No change history'}</div>`;
                } else {
                    let html = '';
                    history.forEach(item => {
                        const fileName = item.file_path.split('/').pop();
                        let statusClass = item.status;
                        let statusText = item.status;

                        if (item.status === 'applied') {
                            statusText = 'Applied';
                        } else if (item.status === 'undone') {
                            statusText = 'Undone';
                        } else if (item.status === 'rejected') {
                            statusText = 'Rejected';
                        }

                        const showUndo = item.status === 'applied';

                        html += `
                            <div class="history-item">
                                <div class="history-item-info">
                                    <span class="history-item-file">${fileName}</span>
                                    <span class="history-item-desc">${item.description || ''}</span>
                                </div>
                                <span class="history-item-status ${statusClass}">${statusText}</span>
                                ${showUndo ? `<button class="undo-btn" onclick="undoChange('${item.id}')">${'Undo'}</button>` : ''}
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }

                document.getElementById('change-history-modal').classList.add('open');
            } catch (e) {
                console.error('Failed to load change history:', e);
            }
        }

        function closeChangeHistory() {
            document.getElementById('change-history-modal').classList.remove('open');
        }

        async function undoChange(changeId) {
            if (!await showConfirm('Undo this change?')) return;

            try {
                const res = await fetch(API + `/api/safety/undo/${changeId}`, { method: 'POST' });
                const result = await res.json();

                if (result.status === 'ok') {
                    showToast('Change undone!');
                } else {
                    showToast(result.message || 'Failed to undo');
                }

                await openChangeHistory(); // Refresh the list
                await loadSafetyData();
            } catch (e) {
                console.error('Failed to undo change:', e);
            }
        }

        async function undoLastChange() {
            if (!await showConfirm('Undo the last change?')) return;

            try {
                const res = await fetch(API + '/api/safety/undo-last', { method: 'POST' });
                const result = await res.json();

                if (result.status === 'ok') {
                    showToast('Last change undone!');
                } else {
                    showToast(result.message || 'Failed to undo');
                }

                await loadSafetyData();
            } catch (e) {
                console.error('Failed to undo last change:', e);
            }
        }

        // Init
        applyLang();

        // Manual refresh function
        async function refreshAll() {
            const btn = document.querySelector('.refresh-btn');
            if (btn) {
                btn.classList.add('spinning');
                setTimeout(() => btn.classList.remove('spinning'), 500);
            }

            try {
                await Promise.all([
                    loadData(),
                    loadMemoryData(),
                    loadLiveRecord(),
                    loadSafetyData(),
                    loadCurrentSite(),
                    loadActivityFeed(),
                    loadChangesToday(),
                    loadBrowserErrors(),
                    loadQuickStats(),
                    loadProjectsList()
                ]);
                showToast('Refreshed!');
            } catch (e) {
                console.error('Refresh failed:', e);
            }
        }

        // Make refreshAll globally accessible
        window.refreshAll = refreshAll;

        // Initial load - first detect server port, then load data
        (async function initDashboard() {
            await detectServerPort();
            updateFilterButtonsText(); // Set filter button text based on language

            // Check if first run - show welcome modal
            checkFirstRun();

            // Phase 1: Load Hero Card first (Focus Mode)
            loadHeroCard();
            loadComplianceStatus();
            loadActivitySection();
            loadInsightsSection();

            // Legacy loaders (some may be redundant now)
            loadData();
            loadMemoryData();
            loadLiveRecord();
            loadSafetyData();
            loadCurrentSite();
            loadActivityFeed();
            loadChangesToday();
            loadBrowserErrors();
            // loadQuickStats(); // Hidden in Focus Mode

            // Refresh intervals
            setInterval(loadHeroCard, 10000);  // Hero updates every 10s
            setInterval(loadComplianceStatus, 5000);  // Compliance updates every 5s
            setInterval(loadActivitySection, 10000);
            setInterval(loadInsightsSection, 30000);

            setInterval(loadData, 5000);
            // setInterval(loadQuickStats, 30000);  // Hidden in Focus Mode
            setInterval(loadMemoryData, 10000);
            setInterval(loadLiveRecord, 5000);
            setInterval(loadSafetyData, 5000);
            setInterval(loadCurrentSite, 10000);
            setInterval(loadActivityFeed, 5000);
            setInterval(loadChangesToday, 10000);
        })();

        // Close modals on outside click
        ['session-modal', 'project-modal', 'project-switcher-modal', 'detail-modal', 'resolve-modal', 'settings-modal', 'all-issues-modal', 'add-decision-modal', 'add-avoid-modal', 'diff-modal', 'change-history-modal', 'welcome-modal'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('click', e => {
                    if (e.target.id === id) {
                        document.getElementById(id).classList.remove('open');
                    }
                });
            }
        });

        // ===== WELCOME WIZARD =====
        function checkFirstRun() {
            // No longer needed - Live State handles new project display
            // Keeping function for backwards compatibility
        }
        // Check on load - Live State handles new project display
        checkFirstRun();
    </script>

</body>
</html>
