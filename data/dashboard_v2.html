<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixOnce</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d0d1a;
            --bg-card: rgba(255, 255, 255, 0.07);
            --bg-glass: rgba(255, 255, 255, 0.06);
            --bg-glass-hover: rgba(255, 255, 255, 0.10);
            --bg-overlay: rgba(8, 8, 20, 0.92);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-muted: rgba(255, 255, 255, 0.28);
            --accent-green: #6fcf97;
            --accent-red: #eb5757;
            --accent-yellow: #f2cc8f;
            --accent-blue: #7b9cff;
            --border: rgba(255, 255, 255, 0.12);
            --border-bright: rgba(255, 255, 255, 0.22);
            --glow: 0 8px 32px rgba(90, 100, 255, 0.12);
            --radius: 18px;
            --radius-sm: 12px;
            --blur: blur(18px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            /* Rich gradient background */
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 85, 255, 0.18) 0%, transparent 55%),
                radial-gradient(ellipse at 80% 80%, rgba(56, 182, 255, 0.12) 0%, transparent 55%),
                radial-gradient(ellipse at 60% 10%, rgba(180, 80, 255, 0.10) 0%, transparent 45%),
                #0d0d1a;
        }

        /* ===== MAIN CONTAINER ===== */
        .container {
            width: 100%;
            max-width: 400px;
            position: relative;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .project-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .project-selector:hover {
            background: rgba(255,255,255,0.07);
        }

        .dropdown-arrow {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .live-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: rgba(111, 207, 151, 0.9);
            padding: 4px 12px;
            background: rgba(111, 207, 151, 0.1);
            border: 1px solid rgba(111, 207, 151, 0.2);
            border-radius: 20px;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 6px var(--accent-green);
            animation: pulse 2s infinite;
        }

        /* Project Dropdown */
        .project-dropdown {
            position: absolute;
            top: 60px;
            left: 0;
            width: 280px;
            background: rgba(15, 15, 30, 0.85);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 16px 48px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .project-dropdown.active {
            display: block;
            animation: slideDown 0.15s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .project-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .project-dropdown-item:last-child {
            border-bottom: none;
        }

        .project-dropdown-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .project-dropdown-item.active {
            background: rgba(111, 207, 151, 0.08);
        }

        .project-dropdown-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .project-dropdown-path {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--border-bright);
            color: var(--text-primary);
        }

        /* ===== SESSION TIMER (in header) ===== */
        .session-timer {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 3px 9px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            letter-spacing: 0.3px;
        }

        /* ===== STATS ROW (bottom of main card) ===== */
        .stats-row {
            display: flex;
            gap: 0;
            padding-top: 14px;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .stat-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 0;
        }

        .stat-item + .stat-item {
            border-left: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-value.ok   { color: var(--accent-green); }
        .stat-value.warn { color: var(--accent-red); }

        .stat-label {
            font-size: 0.68rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        /* ===== MAIN CARD ===== */
        .main-card {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-top-color: var(--border-bright);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--glow), inset 0 1px 0 rgba(255,255,255,0.08);
            transition: all 0.3s ease;
        }

        .now-card {
            padding: 16px 18px;
            margin-bottom: 12px;
        }

        .now-primary {
            font-size: 0.98rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.35;
            margin-bottom: 6px;
        }

        .now-secondary {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        .identity-card {
            padding: 16px 18px;
        }

        .identity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 14px;
        }

        .identity-item {
            min-width: 0;
        }

        .identity-item-wide {
            grid-column: 1 / -1;
        }

        .identity-key {
            font-size: 0.66rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .identity-val {
            font-size: 0.84rem;
            color: var(--text-primary);
            line-height: 1.35;
            white-space: normal;
            word-break: break-word;
        }

        .identity-row {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .identity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .identity-tag {
            font-size: 0.72rem;
            color: var(--text-secondary);
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
        }

        .semantic-badge {
            font-size: 0.6rem;
            color: var(--accent-blue);
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(123, 156, 255, 0.15);
            margin-right: 6px;
            font-weight: 500;
        }

        .identity-learnings {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }

        .learning-item {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(123, 156, 255, 0.08);
            border-right: 3px solid var(--accent-blue);
            line-height: 1.4;
        }

        .signature-tags .identity-tag {
            background: rgba(123, 156, 255, 0.12);
            border-color: rgba(123, 156, 255, 0.25);
            color: var(--accent-blue);
            font-weight: 500;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== NEW WIDGETS ===== */

        /* Widget Row (2 widgets side by side) */
        .widget-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .widget-card {
            flex: 1;
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
        }

        .widget-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .widget-title-icon {
            font-size: 0.8rem;
        }

        /* Multi-AI Widget */
        .ai-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .ai-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .ai-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        .ai-dot.inactive {
            background: var(--text-muted);
        }

        .ai-handoffs {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* AI Timeline Widget */
        .ai-timeline-widget {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .ai-timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .ai-timeline-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-timeline-period {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        /* Timeline Track */
        .ai-timeline-track {
            position: relative;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .ai-timeline-segment {
            position: absolute;
            top: 4px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 500;
            color: white;
            min-width: 40px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ai-timeline-segment:hover {
            transform: scaleY(1.1);
            z-index: 10;
        }

        .ai-timeline-segment.claude {
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
        }

        .ai-timeline-segment.cursor {
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
        }

        .ai-timeline-segment.windsurf {
            background: linear-gradient(135deg, #0891b2 0%, #22d3ee 100%);
        }

        .ai-timeline-segment.unknown {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
        }

        /* Handoff Marker */
        .ai-timeline-handoff {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--accent-yellow);
            z-index: 5;
        }

        .ai-timeline-handoff::after {
            content: 'â†”';
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--accent-yellow);
        }

        /* Time Labels */
        .ai-timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .ai-timeline-label {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        /* AI Stats */
        .ai-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .ai-stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .ai-stat-icon.claude { background: linear-gradient(135deg, #d97706, #f59e0b); }
        .ai-stat-icon.cursor { background: linear-gradient(135deg, #7c3aed, #a78bfa); }
        .ai-stat-icon.windsurf { background: linear-gradient(135deg, #0891b2, #22d3ee); }

        .ai-stat-info {
            flex: 1;
            min-width: 0;
        }

        .ai-stat-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .ai-stat-detail {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .ai-stat-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: left;
        }

        /* Current AI indicator */
        .ai-current-badge {
            font-size: 0.55rem;
            background: var(--accent-green);
            color: var(--bg-primary);
            padding: 1px 5px;
            border-radius: 4px;
            margin-right: 4px;
            font-weight: 600;
        }

        /* Cross-Project Insights Widget */
        .cross-project-widget {
            background: linear-gradient(135deg, rgba(180, 130, 255, 0.08) 0%, rgba(123, 156, 255, 0.08) 100%);
            border: 1px solid rgba(180, 130, 255, 0.2);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .cross-project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .cross-project-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cross-project-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 14px;
        }

        .cross-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            min-width: 60px;
        }

        .cross-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .cross-stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .cross-insights-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 14px;
        }

        .cross-insight-item {
            display: flex;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            border-right: 3px solid var(--accent-blue);
        }

        .cross-insight-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .cross-insight-content {
            flex: 1;
            min-width: 0;
        }

        .cross-insight-text {
            font-size: 0.75rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .cross-insight-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .cross-insight-project {
            background: rgba(180, 130, 255, 0.2);
            color: #d4b8ff;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
        }

        .cross-timeline {
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .cross-timeline-title {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .cross-timeline-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .cross-timeline-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .cross-timeline-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .cross-timeline-dot.fixonce { background: #6fcf97; }
        .cross-timeline-dot.tetris { background: #f59e0b; }
        .cross-timeline-dot.test-site { background: #7c3aed; }
        .cross-timeline-dot.default { background: var(--text-muted); }

        .cross-timeline-project {
            font-weight: 500;
            color: var(--text-primary);
            min-width: 60px;
        }

        .cross-timeline-action {
            flex: 1;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cross-timeline-time {
            color: var(--text-muted);
            font-size: 0.65rem;
        }

        /* ROI Widget - Enhanced */
        .roi-widget-full {
            background: linear-gradient(135deg, rgba(111, 207, 151, 0.08) 0%, rgba(123, 156, 255, 0.08) 100%);
            border: 1px solid rgba(111, 207, 151, 0.2);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .roi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .roi-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .roi-period {
            font-size: 0.65rem;
            color: var(--accent-blue);
            background: rgba(123, 156, 255, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .roi-hero {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 14px;
        }

        .roi-hero-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
            line-height: 1;
        }

        .roi-hero-unit {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .roi-hero-change {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 6px;
            margin-right: auto;
        }

        .roi-hero-change.positive {
            color: var(--accent-green);
            background: rgba(111, 207, 151, 0.15);
        }

        .roi-hero-change.negative {
            color: var(--accent-red);
            background: rgba(235, 87, 87, 0.15);
        }

        .roi-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 14px;
        }

        .roi-bar-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .roi-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .roi-bar-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .roi-bar-value {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .roi-bar-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .roi-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .roi-bar-fill.time { background: linear-gradient(90deg, var(--accent-green), #4ade80); }
        .roi-bar-fill.reused { background: linear-gradient(90deg, var(--accent-blue), #60a5fa); }
        .roi-bar-fill.prevented { background: linear-gradient(90deg, var(--accent-yellow), #fbbf24); }

        .roi-money {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(111, 207, 151, 0.1);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }

        .roi-money-icon {
            font-size: 1.2rem;
        }

        .roi-money-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .roi-money-value {
            font-weight: 600;
            color: var(--accent-green);
        }

        .roi-story {
            font-size: 0.72rem;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: rgba(123, 156, 255, 0.08);
            border-radius: var(--radius-sm);
            border-right: 3px solid var(--accent-blue);
            line-height: 1.4;
        }

        .roi-story-highlight {
            color: var(--accent-blue);
            font-weight: 500;
        }

        /* Keep old classes for backward compatibility */
        .roi-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .roi-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .roi-label {
            color: var(--text-muted);
        }

        .roi-value {
            color: var(--accent-green);
            font-weight: 600;
        }

        .roi-value.highlight {
            color: var(--accent-yellow);
        }

        /* Projects Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .project-card {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-card:hover {
            background: var(--bg-glass-hover);
            border-color: var(--border-bright);
        }

        .project-card.active {
            border-color: var(--accent-green);
            background: rgba(111, 207, 151, 0.08);
        }

        .project-card-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-card-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .project-status-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .project-status-dot.active { background: var(--accent-green); }
        .project-status-dot.recent { background: var(--accent-yellow); }
        .project-status-dot.stale { background: var(--text-muted); }

        .project-card-counts {
            display: flex;
            gap: 6px;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .project-semantic-badge {
            font-size: 0.55rem;
            color: var(--accent-blue);
            background: rgba(123, 156, 255, 0.15);
            padding: 1px 4px;
            border-radius: 3px;
            margin-top: 4px;
            display: inline-block;
        }

        /* Knowledge Widget */
        .knowledge-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .knowledge-stat {
            text-align: center;
        }

        .knowledge-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .knowledge-stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .knowledge-learnings {
            border-top: 1px solid var(--border);
            padding-top: 8px;
        }

        .knowledge-learning {
            font-size: 0.7rem;
            color: var(--text-secondary);
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .knowledge-learning:last-child {
            border-bottom: none;
        }

        .learning-icon {
            color: var(--accent-yellow);
            flex-shrink: 0;
        }

        .learning-importance {
            font-size: 0.55rem;
            color: var(--accent-blue);
            margin-right: 4px;
        }

        /* Environment Widget */
        .env-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .env-item {
            font-size: 0.7rem;
        }

        .env-label {
            color: var(--text-muted);
            font-size: 0.6rem;
        }

        .env-value {
            color: var(--text-secondary);
            font-family: monospace;
        }

        .env-ports {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .env-port {
            background: rgba(123, 156, 255, 0.15);
            color: var(--accent-blue);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-family: monospace;
        }

        /* Collapsible sections */
        .widget-section {
            margin-bottom: 12px;
        }

        .widget-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 8px 0;
        }

        .widget-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .widget-section-toggle {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        /* Section labels */
        .section-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        /* Goal */
        .goal {
            font-size: 1.05rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.5;
            font-weight: 500;
        }

        /* Target */
        .target {
            padding: 12px 14px;
            background: rgba(123, 156, 255, 0.08);
            border: 1px solid rgba(123, 156, 255, 0.15);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .target-icon {
            flex-shrink: 0;
        }

        .target-text {
            color: var(--text-primary);
        }

        /* Session info */
        /* ===== ERROR CARD ===== */
        .error-card {
            background: rgba(235, 87, 87, 0.08);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid rgba(235, 87, 87, 0.25);
            border-top-color: rgba(235, 87, 87, 0.4);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            display: none;
            box-shadow: 0 8px 32px rgba(235, 87, 87, 0.1);
        }

        .error-card.active {
            display: block;
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .error-icon {
            font-size: 1.3rem;
        }

        .error-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-red);
            font-weight: 600;
        }

        .error-message {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-sm);
            word-break: break-word;
        }

        .error-solution {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(129, 178, 154, 0.15);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            color: var(--accent-green);
            font-size: 0.9rem;
        }

        .error-actions {
            display: flex;
            gap: 12px;
        }

        .error-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .error-btn.primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .error-btn.primary:hover {
            filter: brightness(1.1);
        }

        .error-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .error-btn.secondary:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        /* ===== ACTIVITY FEED (inline chat-style) ===== */
        .feed {
            margin-bottom: 14px;
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feed-label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-muted);
        }

        .feed-all {
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 0;
        }

        .feed-all:hover {
            color: var(--text-secondary);
        }

        .feed-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 9px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            transition: opacity 0.2s;
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-item.new-entry {
            animation: feedFadeIn 0.4s ease forwards;
        }

        @keyframes feedFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .feed-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .feed-dot.design  { background: rgba(180, 130, 255, 0.15); }
        .feed-dot.code    { background: rgba(123, 156, 255, 0.15); }
        .feed-dot.command { background: rgba(111, 207, 151, 0.15); }
        .feed-dot.git     { background: rgba(242, 204, 143, 0.15); }
        .feed-dot.default { background: rgba(255, 255, 255, 0.07); }

        .feed-body {
            flex: 1;
            min-width: 0;
        }

        .feed-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 2px;
        }

        .feed-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .feed-item.fresh .feed-text {
            color: #fff;
        }

        .feed-item.fresh .feed-time {
            color: var(--accent-green);
        }

        /* ===== AI LAUNCHER BUTTONS ===== */
        .ai-launchers {
            display: none; /* moved out, kept for launchEditor() function */
        }

        .ai-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 14px 8px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-top-color: var(--border-bright);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-btn:hover {
            background: rgba(255,255,255,0.10);
            border-color: var(--border-bright);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        .ai-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            opacity: 0.85;
        }

        .ai-btn:hover .ai-icon {
            opacity: 1;
        }

        /* ===== ACTION BUTTONS ===== */
        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 13px 16px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-top-color: var(--border-bright);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.10);
            border-color: var(--border-bright);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .action-btn.primary-action {
            background: rgba(111, 207, 151, 0.15);
            color: var(--accent-green);
            border-color: rgba(111, 207, 151, 0.3);
        }

        .action-btn.primary-action:hover {
            background: rgba(111, 207, 151, 0.25);
            border-color: rgba(111, 207, 151, 0.5);
            color: var(--accent-green);
            box-shadow: 0 4px 20px rgba(111, 207, 151, 0.15);
        }

        /* More Menu */
        .more-menu-container {
            position: relative;
            flex: 1;
        }

        .more-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            width: 280px;
            margin-bottom: 8px;
            background: rgba(15, 15, 30, 0.88);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            padding: 10px;
            display: none;
            z-index: 100;
            box-shadow: 0 16px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .more-menu.active {
            display: block;
            animation: slideUp 0.15s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            border: 1px solid transparent;
            border-radius: 10px;
            margin-bottom: 4px;
        }

        .more-menu-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .more-menu-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--border);
        }

        .menu-badge {
            margin-right: auto;
            background: rgba(123, 156, 255, 0.18);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #c8d6ff;
            border: 1px solid rgba(123, 156, 255, 0.32);
            display: none;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            line-height: 1.1;
        }

        .menu-badge.visible {
            display: inline-flex;
        }

        .menu-badge.tone-risk {
            background: rgba(235, 87, 87, 0.16);
            color: #ffb8b8;
            border-color: rgba(235, 87, 87, 0.35);
        }

        .menu-badge.tone-good {
            background: rgba(111, 207, 151, 0.16);
            color: #bff2cf;
            border-color: rgba(111, 207, 151, 0.35);
        }

        /* Badge on "More" button */
        .more-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #7b9cff;
            color: #1a1d24;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .more-menu-container {
            position: relative;
        }

        /* "New" badge for recent items */
        .new-badge {
            background: #7b9cff;
            color: #1a1d24;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
        }

        .history-item.new-item {
            border-right: 3px solid #7b9cff;
            background: rgba(123, 156, 255, 0.08);
        }

        .more-menu-headline {
            padding: 4px 8px 10px;
            font-size: 0.78rem;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 8px;
        }

        .more-menu-divider {
            border-top: 1px solid rgba(255,255,255,0.08);
            margin: 8px 2px;
        }

        .more-menu-section-label {
            font-size: 0.66rem;
            text-transform: uppercase;
            letter-spacing: 0.45px;
            color: var(--text-muted);
            padding: 2px 8px 6px;
        }

        .more-menu-icon {
            width: 18px;
            text-align: center;
            opacity: 0.9;
        }

        /* ===== SIDE PANEL (History/Search) ===== */
        .panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 999;
            display: none;
        }

        .panel-backdrop.active {
            display: block;
        }

        .overlay {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: rgba(12, 12, 24, 0.82);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-left: 1px solid var(--border);
            box-shadow: -16px 0 48px rgba(0,0,0,0.5), inset 1px 0 0 rgba(255,255,255,0.06);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.25s ease;
        }

        .overlay.active {
            right: 0;
        }

        /* Full overlay for insight form */
        .overlay.full-overlay {
            right: auto;
            left: 0;
            width: 100%;
            border-left: none;
            background: rgba(10, 10, 22, 0.92);
            display: none;
            transition: none;
        }

        .overlay.full-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .overlay-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .overlay-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .overlay-close:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--border-bright);
            color: var(--text-primary);
        }

        .overlay-content {
            flex: 1;
        }

        /* History items */
        .history-item {
            padding: 16px;
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .history-item-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .history-item-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Story-style history */
        .story-item {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .story-item:last-child {
            border-bottom: none;
        }

        .story-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .story-icon.code { background: rgba(129, 178, 154, 0.15); }
        .story-icon.design { background: rgba(242, 204, 143, 0.15); }
        .story-icon.command { background: rgba(94, 129, 172, 0.15); }
        .story-icon.git { background: rgba(231, 111, 81, 0.15); }

        .story-body {
            flex: 1;
            min-width: 0;
        }

        .story-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .story-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .story-meta-dot {
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .story-day-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 8px 0 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
        }

        /* Search overlay */
        .search-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent-green);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-result {
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-result:hover {
            background: rgba(255,255,255,0.08);
        }

        .search-result-match {
            font-size: 0.8rem;
            color: var(--accent-green);
            margin-bottom: 6px;
        }

        .search-result-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        /* Add insight overlay */
        .insight-textarea {
            width: 100%;
            min-height: 150px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            outline: none;
            margin-bottom: 16px;
        }

        .insight-textarea:focus {
            border-color: var(--accent-green);
        }

        .insight-textarea::placeholder {
            color: var(--text-muted);
        }

        .save-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            filter: brightness(1.1);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== MICRO FEEDBACK ===== */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        @keyframes success-pulse {
            0% { box-shadow: 0 0 0 0 rgba(129, 178, 154, 0.4); }
            100% { box-shadow: 0 0 0 20px rgba(129, 178, 154, 0); }
        }

        .success-pulse {
            animation: success-pulse 0.5s ease;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            z-index: 2000;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            body {
                padding: 20px 16px;
            }

            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="project-selector" onclick="toggleProjectDropdown()">
                    <span id="header-project-name">FixOnce</span>
                    <span class="dropdown-arrow">â–¼</span>
                </div>
                <div class="live-tag" id="live-tag">
                    <span class="live-dot"></span>
                    <span id="live-editor">Cursor</span>
                </div>
                <span class="session-timer" id="session-timer">â€”</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshData()" title="Refresh">â†»</button>
            </div>
        </div>

        <!-- Project Dropdown -->
        <div class="project-dropdown" id="project-dropdown"></div>

        <!-- ===== NEW WIDGETS ===== -->

        <!-- AI Timeline Widget -->
        <div class="ai-timeline-widget" id="widget-ai-timeline">
            <div class="ai-timeline-header">
                <div class="ai-timeline-title">
                    <span>ðŸ¤–</span>
                    <span>AI Timeline</span>
                </div>
                <span class="ai-timeline-period" id="ai-timeline-period">Today</span>
            </div>

            <!-- Visual Timeline Track -->
            <div class="ai-timeline-track" id="ai-timeline-track">
                <!-- Segments filled by JS -->
            </div>

            <!-- Time Labels -->
            <div class="ai-timeline-labels">
                <span class="ai-timeline-label" id="timeline-start">00:00</span>
                <span class="ai-timeline-label" id="timeline-now">Now</span>
            </div>

            <!-- AI Stats Cards -->
            <div class="ai-stats-grid" id="ai-stats-grid">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- ROI Widget - Enhanced Full Width -->
        <div class="roi-widget-full" id="widget-roi">
            <div class="roi-header">
                <div class="roi-title">
                    <span>ðŸ’°</span>
                    <span>Value Created</span>
                </div>
                <span class="roi-period" id="roi-period">Today</span>
            </div>

            <!-- Hero Stat -->
            <div class="roi-hero">
                <span class="roi-hero-value" id="roi-hero-time">0</span>
                <span class="roi-hero-unit">minutes saved</span>
                <span class="roi-hero-change positive" id="roi-change">â€”</span>
            </div>

            <!-- Progress Bars -->
            <div class="roi-bars">
                <div class="roi-bar-item">
                    <div class="roi-bar-header">
                        <span class="roi-bar-label">â± Time Saved</span>
                        <span class="roi-bar-value" id="roi-time-value">0 min</span>
                    </div>
                    <div class="roi-bar-track">
                        <div class="roi-bar-fill time" id="roi-time-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="roi-bar-item">
                    <div class="roi-bar-header">
                        <span class="roi-bar-label">ðŸ”„ Solutions Reused</span>
                        <span class="roi-bar-value" id="roi-reused-value">0</span>
                    </div>
                    <div class="roi-bar-track">
                        <div class="roi-bar-fill reused" id="roi-reused-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="roi-bar-item">
                    <div class="roi-bar-header">
                        <span class="roi-bar-label">ðŸ›¡ï¸ Bugs Prevented</span>
                        <span class="roi-bar-value" id="roi-prevented-value">0</span>
                    </div>
                    <div class="roi-bar-track">
                        <div class="roi-bar-fill prevented" id="roi-prevented-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Money Saved -->
            <div class="roi-money">
                <span class="roi-money-icon">ðŸ’µ</span>
                <span class="roi-money-text">Estimated savings: <span class="roi-money-value" id="roi-money">~$0</span></span>
            </div>

            <!-- Story -->
            <div class="roi-story" id="roi-story">
                <span class="roi-story-highlight">Tip:</span> Use search_past_solutions more to increase savings
            </div>
        </div>

        <!-- Projects Grid Widget -->
        <div class="widget-section" id="widget-projects-section">
            <div class="widget-section-header" onclick="toggleSection('projects')">
                <div class="widget-section-title">
                    <span>ðŸ“</span>
                    <span>Projects</span>
                    <span id="projects-count-badge" style="font-size:0.6rem; color:var(--text-muted);">(0)</span>
                </div>
                <span class="widget-section-toggle" id="projects-toggle">â–¼</span>
            </div>
            <div class="projects-grid" id="projects-grid">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- Knowledge Base Widget -->
        <div class="widget-card" id="widget-knowledge" style="margin-bottom: 12px;">
            <div class="widget-title">
                <span class="widget-title-icon">ðŸ”</span>
                <span>Knowledge Base</span>
                <button onclick="openOverlay('search')" style="margin-right: auto; background: rgba(123,156,255,0.15); border: none; color: var(--accent-blue); padding: 2px 8px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;">Search</button>
            </div>
            <div class="knowledge-stats">
                <div class="knowledge-stat">
                    <div class="knowledge-stat-value" id="knowledge-insights">0</div>
                    <div class="knowledge-stat-label">Insights</div>
                </div>
                <div class="knowledge-stat">
                    <div class="knowledge-stat-value" id="knowledge-decisions">0</div>
                    <div class="knowledge-stat-label">Decisions</div>
                </div>
                <div class="knowledge-stat">
                    <div class="knowledge-stat-value" id="knowledge-avoids">0</div>
                    <div class="knowledge-stat-label">Avoids</div>
                </div>
                <div class="knowledge-stat">
                    <div class="knowledge-stat-value" id="knowledge-indexed">0</div>
                    <div class="knowledge-stat-label">Indexed</div>
                </div>
            </div>
            <div class="knowledge-learnings" id="knowledge-learnings">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- Environment Widget -->
        <div class="widget-card" id="widget-environment" style="margin-bottom: 12px;">
            <div class="widget-title">
                <span class="widget-title-icon">ðŸŒ</span>
                <span>Environment</span>
            </div>
            <div class="env-grid">
                <div class="env-item">
                    <div class="env-label">Stack</div>
                    <div class="env-value" id="env-stack">â€”</div>
                </div>
                <div class="env-item">
                    <div class="env-label">Stage</div>
                    <div class="env-value" id="env-stage">â€”</div>
                </div>
                <div class="env-item">
                    <div class="env-label">Ports</div>
                    <div class="env-ports" id="env-ports">â€”</div>
                </div>
                <div class="env-item">
                    <div class="env-label">Env</div>
                    <div class="env-value" id="env-mode">â€”</div>
                </div>
            </div>
        </div>

        <!-- Cross-Project Insights Widget -->
        <div class="cross-project-widget" id="widget-cross-project">
            <div class="cross-project-header">
                <div class="cross-project-title">
                    <span>ðŸ”—</span>
                    <span>Cross-Project Insights</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="cross-project-stats" id="cross-stats">
                <div class="cross-stat">
                    <span class="cross-stat-value" id="cross-projects">0</span>
                    <span class="cross-stat-label">Projects</span>
                </div>
                <div class="cross-stat">
                    <span class="cross-stat-value" id="cross-insights">0</span>
                    <span class="cross-stat-label">Insights</span>
                </div>
                <div class="cross-stat">
                    <span class="cross-stat-value" id="cross-decisions">0</span>
                    <span class="cross-stat-label">Decisions</span>
                </div>
            </div>

            <!-- Top Insights -->
            <div class="cross-insights-list" id="cross-insights-list">
                <!-- Filled by JS -->
            </div>

            <!-- Recent Activity Timeline -->
            <div class="cross-timeline">
                <div class="cross-timeline-title">Recent Activity Across Projects</div>
                <div class="cross-timeline-items" id="cross-timeline-items">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- ===== END NEW WIDGETS ===== -->

        <!-- Focus Card (Combined goal + status) -->
        <div class="main-card" id="main-card">
            <div class="now-primary" id="now-primary" style="font-size: 0.85rem; margin-bottom: 10px;">Loading...</div>

            <div class="section-label">Current Goal</div>
            <div class="goal" id="goal">Loading...</div>

            <div class="now-secondary" id="now-secondary" style="font-size: 0.78rem; color: var(--text-secondary); margin: 8px 0 12px;">â€”</div>

            <div class="target" id="target" style="display: none;">
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <span class="target-icon">â†’</span>
                    <span class="target-text" id="target-text"></span>
                </div>
            </div>

            <!-- Stats row -->
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-value ok" id="stat-health">âœ“</span>
                    <span class="stat-label">Status</span>
                </div>
                <div class="stat-item clickable" onclick="openOverlay('decisions')" title="Decisions">
                    <span class="stat-value" id="stat-decisions">0</span>
                    <span class="stat-label">Decisions</span>
                </div>
                <div class="stat-item clickable" onclick="openOverlay('debug-sessions')" title="Resolved">
                    <span class="stat-value" id="stat-resolved">0</span>
                    <span class="stat-label">Resolved</span>
                </div>
            </div>
        </div>

        <!-- Error Card (Alert Mode) -->
        <div class="error-card" id="error-card">
            <div class="error-header">
                <span class="error-icon">âš ï¸</span>
                <span class="error-title">Needs Attention</span>
            </div>

            <div class="error-message" id="error-message">-</div>

            <div class="error-solution" id="error-solution" style="display: none;">
                <span>ðŸ’¡</span>
                <span id="error-solution-text">-</span>
            </div>

            <div class="error-actions">
                <button class="error-btn primary" onclick="sendErrorToAI()">ðŸ¤– Send to AI</button>
                <button class="error-btn secondary" onclick="handleError()">âœ“ Handled</button>
                <button class="error-btn secondary" onclick="dismissError()">âœ•</button>
            </div>
        </div>

        <!-- Inline Activity Feed -->
        <div class="main-card feed" id="inline-feed">
            <div class="feed-header">
                <span class="feed-label">Activity Feed</span>
                <button class="feed-all" onclick="openOverlay('history')">All History â†’</button>
            </div>
            <div id="feed-items">
                <div class="feed-item">
                    <div class="feed-dot default">Â·</div>
                    <div class="feed-body">
                        <div class="feed-text" style="color: var(--text-muted)">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
            <div class="more-menu-container">
                <button class="action-btn" onclick="toggleMoreMenu()">
                    <span>ðŸ“‹</span>
                    <span>More</span>
                    <span class="more-badge" id="more-badge" style="display: none;">0</span>
                    <span class="dropdown-arrow">â–¼</span>
                </button>
                <div class="more-menu" id="more-menu">
                    <div class="more-menu-headline" id="more-menu-headline">Choose Action</div>
                    <div class="more-menu-section-label">Quick Actions</div>
                    <div class="more-menu-item" onclick="openOverlay('insight'); closeMoreMenu();">
                        <span class="more-menu-icon">âž•</span>
                        <span>Insight</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('search'); closeMoreMenu();">
                        <span class="more-menu-icon">ðŸ”</span>
                        <span>Search Memory</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('history'); closeMoreMenu();">
                        <span class="more-menu-icon">ðŸ“œ</span>
                        <span>History</span>
                    </div>
                    <div class="more-menu-divider"></div>
                    <div class="more-menu-section-label">Knowledge Management</div>
                    <div class="more-menu-item" onclick="openOverlay('decisions'); closeMoreMenu();">
                        <span class="more-menu-icon">âš–ï¸</span>
                        <span>Active Decisions</span>
                        <span class="menu-badge" id="decisions-badge">0</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('avoid'); closeMoreMenu();">
                        <span class="more-menu-icon">ðŸš«</span>
                        <span>What to Avoid</span>
                        <span class="menu-badge" id="avoid-badge">0</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('debug-sessions'); closeMoreMenu();">
                        <span class="more-menu-icon">ðŸ›</span>
                        <span>Resolved Issues</span>
                        <span class="menu-badge" id="debug-sessions-badge">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Backdrop -->
    <div class="panel-backdrop" id="panel-backdrop" onclick="closeAllPanels()"></div>

    <!-- History Panel (side) -->
    <div class="overlay" id="overlay-history">
        <div class="overlay-header">
            <div class="overlay-title" id="history-title">History</div>
            <button class="overlay-close" onclick="closeOverlay('history')">Ã—</button>
        </div>
        <div class="overlay-content" id="history-content">
            <div class="history-empty">Loading...</div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="overlay" id="overlay-search">
        <div class="overlay-header">
            <div class="overlay-title">Search Solutions</div>
            <button class="overlay-close" onclick="closeOverlay('search')">Ã—</button>
        </div>
        <div class="overlay-content">
            <input type="text" class="search-input" id="search-input"
                   placeholder="Search insights and decisions..."
                   oninput="handleSearch(this.value)">
            <div class="search-results" id="search-results">
                <div class="history-empty">Type to search...</div>
            </div>
        </div>
    </div>

    <!-- Add Insight Overlay (full screen) -->
    <div class="overlay full-overlay" id="overlay-insight">
        <div class="overlay-header">
            <div class="overlay-title">Save Insight</div>
            <button class="overlay-close" onclick="closeOverlay('insight')">Ã—</button>
        </div>
        <div class="overlay-content">
            <textarea class="insight-textarea" id="insight-input"
                      placeholder="What did you learn? What worked? What didn't?"></textarea>
            <button class="save-btn" id="save-insight-btn" onclick="saveInsight()">
                Save Insight
            </button>
        </div>
    </div>

    <!-- Decisions Panel (side) -->
    <div class="overlay" id="overlay-decisions">
        <div class="overlay-header">
            <div class="overlay-title">Active Decisions</div>
            <button class="overlay-close" onclick="closeOverlay('decisions')">Ã—</button>
        </div>
        <div class="overlay-content" id="decisions-content">
            <div class="history-empty">Loading...</div>
        </div>
    </div>

    <!-- Avoid Panel (side) -->
    <div class="overlay" id="overlay-avoid">
        <div class="overlay-header">
            <div class="overlay-title">What to Avoid</div>
            <button class="overlay-close" onclick="closeOverlay('avoid')">Ã—</button>
        </div>
        <div class="overlay-content" id="avoid-content">
            <div class="history-empty">Loading...</div>
        </div>
    </div>

    <!-- Debug Sessions Panel -->
    <div class="overlay" id="overlay-debug-sessions">
        <div class="overlay-header">
            <div class="overlay-title">ðŸ› Resolved Issues</div>
            <button class="overlay-close" onclick="closeOverlay('debug-sessions')">Ã—</button>
        </div>
        <div class="overlay-content" id="debug-sessions-content">
            <div class="history-empty">Loading...</div>
        </div>
    </div>

    <script>
        // ===== CONFIG =====
        let API = 'http://localhost:5000';
        let currentError = null;
        let projectData = null;
        let historyFilter = 'all'; // 'all' | 'today'

        // Auto-detect server port
        async function detectServer() {
            for (const port of [5000, 5001, 5002]) {
                try {
                    const res = await fetch(`http://localhost:${port}/api/ping`, {
                        signal: AbortSignal.timeout(500)
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.service === 'fixonce') {
                            API = `http://localhost:${port}`;
                            return true;
                        }
                    }
                } catch {}
            }
            return false;
        }

        // ===== NEW WIDGETS UPDATE FUNCTIONS =====

        let _lastSnapshot = null;
        let _sectionStates = { projects: true };  // Track collapsed sections

        function toggleSection(section) {
            _sectionStates[section] = !_sectionStates[section];
            const toggle = document.getElementById(section + '-toggle');
            const grid = document.getElementById(section + '-grid');
            if (toggle) toggle.textContent = _sectionStates[section] ? 'â–¼' : 'â–¶';
            if (grid) grid.style.display = _sectionStates[section] ? 'grid' : 'none';
        }

        function updateMultiAIWidget(snapshot) {
            // This function now updates the AI Timeline widget
            updateAITimeline(snapshot);
        }

        function updateAITimeline(snapshot) {
            const track = document.getElementById('ai-timeline-track');
            const statsGrid = document.getElementById('ai-stats-grid');
            const periodEl = document.getElementById('ai-timeline-period');
            const startLabel = document.getElementById('timeline-start');

            if (!track || !statsGrid) return;

            const activeAIs = snapshot.active_ais || [];
            const handoffs = snapshot.ai_handoffs || [];
            const activities = snapshot.activity || [];

            const now = new Date();
            const todayStart = new Date(now);
            todayStart.setHours(0, 0, 0, 0);

            // Build AI session data from activities and active_ais
            const aiSessions = {};
            const aiContributions = {};

            // Process activities to count contributions per AI
            // Skip 'unknown' entries - they don't add value
            activities.forEach(act => {
                let actor = (act.actor || act.editor || '').toLowerCase();
                // Skip unknown/empty actors
                if (!actor || actor === 'unknown' || actor === 'both') return;

                if (!aiContributions[actor]) {
                    aiContributions[actor] = { edits: 0, tools: new Set(), firstSeen: null, lastSeen: null };
                }
                aiContributions[actor].edits++;
                if (act.tool) aiContributions[actor].tools.add(act.tool);

                const ts = new Date(act.timestamp);
                if (!aiContributions[actor].firstSeen || ts < aiContributions[actor].firstSeen) {
                    aiContributions[actor].firstSeen = ts;
                }
                if (!aiContributions[actor].lastSeen || ts > aiContributions[actor].lastSeen) {
                    aiContributions[actor].lastSeen = ts;
                }
            });

            // Process active_ais for current sessions
            activeAIs.forEach(ai => {
                const name = (ai.editor || ai.id || '').toLowerCase();
                if (!name || name === 'unknown') return;

                if (!aiSessions[name]) {
                    aiSessions[name] = [];
                }
                aiSessions[name].push({
                    start: new Date(ai.started_at),
                    end: new Date(ai.last_activity || now),
                    active: (now - new Date(ai.last_activity || 0)) < 5 * 60 * 1000
                });
            });

            // Calculate timeline range (today or last 24h)
            const timelineStart = todayStart;
            const timelineEnd = now;
            const totalMs = timelineEnd - timelineStart;

            // Clear and build track
            track.innerHTML = '';

            // Create segments for each AI
            Object.entries(aiSessions).forEach(([aiName, sessions]) => {
                sessions.forEach(session => {
                    const segStart = Math.max(session.start.getTime(), timelineStart.getTime());
                    const segEnd = Math.min(session.end.getTime(), timelineEnd.getTime());

                    if (segEnd > segStart) {
                        const leftPercent = ((segStart - timelineStart.getTime()) / totalMs) * 100;
                        const widthPercent = ((segEnd - segStart) / totalMs) * 100;

                        const segment = document.createElement('div');
                        segment.className = `ai-timeline-segment ${aiName}`;
                        segment.style.left = `${leftPercent}%`;
                        segment.style.width = `${Math.max(widthPercent, 5)}%`;

                        const displayName = aiName.charAt(0).toUpperCase() + aiName.slice(1);
                        const durationMin = Math.round((segEnd - segStart) / 60000);

                        segment.innerHTML = session.active ?
                            `<span class="ai-current-badge">LIVE</span>${displayName}` :
                            displayName;
                        segment.title = `${displayName}: ${durationMin} min`;

                        track.appendChild(segment);
                    }
                });
            });

            // Add handoff markers
            handoffs.forEach(h => {
                const ts = new Date(h.timestamp).getTime();
                if (ts >= timelineStart.getTime() && ts <= timelineEnd.getTime()) {
                    const leftPercent = ((ts - timelineStart.getTime()) / totalMs) * 100;
                    const marker = document.createElement('div');
                    marker.className = 'ai-timeline-handoff';
                    marker.style.left = `${leftPercent}%`;
                    marker.title = `Handoff: ${h.from} â†’ ${h.to}`;
                    track.appendChild(marker);
                }
            });

            // If no sessions, show placeholder
            if (track.children.length === 0) {
                track.innerHTML = '<div style="color: var(--text-muted); font-size: 0.7rem; display: flex; align-items: center; justify-content: center; height: 100%;">No AI activity today</div>';
            }

            // Update time labels
            if (startLabel) {
                startLabel.textContent = todayStart.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            // Build stats grid - exclude unknown
            const allAIs = new Set([
                ...Object.keys(aiSessions),
                ...Object.keys(aiContributions)
            ]);
            allAIs.delete('unknown');
            allAIs.delete('both');
            allAIs.delete('');

            if (allAIs.size === 0) {
                statsGrid.innerHTML = '<div style="color: var(--text-muted); font-size: 0.7rem;">No AI data available</div>';
                return;
            }

            statsGrid.innerHTML = Array.from(allAIs).map(aiName => {
                const contrib = aiContributions[aiName] || { edits: 0, tools: new Set() };
                const sessions = aiSessions[aiName] || [];

                // Calculate total time
                let totalMinutes = 0;
                sessions.forEach(s => {
                    totalMinutes += Math.round((s.end - s.start) / 60000);
                });

                // Check if currently active
                const isActive = sessions.some(s => s.active);

                const displayName = aiName.charAt(0).toUpperCase() + aiName.slice(1);
                const timeDisplay = totalMinutes > 60 ?
                    `${Math.floor(totalMinutes/60)}h ${totalMinutes%60}m` :
                    `${totalMinutes}m`;

                return `
                    <div class="ai-stat-card">
                        <div class="ai-stat-icon ${aiName}">
                            ${displayName.charAt(0)}
                        </div>
                        <div class="ai-stat-info">
                            <div class="ai-stat-name">
                                ${isActive ? '<span class="ai-current-badge">LIVE</span>' : ''}
                                ${displayName}
                            </div>
                            <div class="ai-stat-detail">
                                ${contrib.edits} edits â€¢ ${contrib.tools.size} tools
                            </div>
                        </div>
                        <div class="ai-stat-time">${timeDisplay}</div>
                    </div>
                `;
            }).join('');
        }

        function updateROIWidget(snapshot) {
            const roi = snapshot.roi || {};
            const knowledge = snapshot.knowledge || {};

            // Values
            const timeSaved = roi.time_saved_minutes || 0;
            const reused = roi.solutions_reused || 0;
            const prevented = roi.errors_prevented || 0;
            const tokensSaved = roi.tokens_saved || 0;
            const decisionsRef = roi.decisions_referenced || 0;

            // Calculate money saved (rough: $0.01 per 1000 tokens, + $5 per hour saved)
            const tokenMoney = tokensSaved * 0.00001;
            const timeMoney = (timeSaved / 60) * 5; // $5 per hour
            const totalMoney = tokenMoney + timeMoney;

            // Calculate percentages for bars (max values for visual reference)
            const maxTime = Math.max(60, timeSaved); // 60 min baseline
            const maxReused = Math.max(10, reused);
            const maxPrevented = Math.max(5, prevented);

            const timePercent = Math.min(100, (timeSaved / maxTime) * 100);
            const reusedPercent = Math.min(100, (reused / maxReused) * 100);
            const preventedPercent = Math.min(100, (prevented / maxPrevented) * 100);

            // Update hero
            const heroTime = document.getElementById('roi-hero-time');
            if (heroTime) heroTime.textContent = timeSaved;

            // Update change badge
            const changeEl = document.getElementById('roi-change');
            if (changeEl) {
                if (timeSaved > 0 || reused > 0) {
                    const totalActions = reused + prevented + decisionsRef;
                    changeEl.textContent = `+${totalActions} actions`;
                    changeEl.className = 'roi-hero-change positive';
                } else {
                    changeEl.textContent = 'Start using';
                    changeEl.className = 'roi-hero-change';
                }
            }

            // Update bars
            const timeValue = document.getElementById('roi-time-value');
            const timeBar = document.getElementById('roi-time-bar');
            if (timeValue) timeValue.textContent = timeSaved > 60 ?
                `${Math.floor(timeSaved/60)}h ${timeSaved%60}m` : `${timeSaved} min`;
            if (timeBar) timeBar.style.width = timePercent + '%';

            const reusedValue = document.getElementById('roi-reused-value');
            const reusedBar = document.getElementById('roi-reused-bar');
            if (reusedValue) reusedValue.textContent = reused;
            if (reusedBar) reusedBar.style.width = reusedPercent + '%';

            const preventedValue = document.getElementById('roi-prevented-value');
            const preventedBar = document.getElementById('roi-prevented-bar');
            if (preventedValue) preventedValue.textContent = prevented;
            if (preventedBar) preventedBar.style.width = preventedPercent + '%';

            // Update money
            const moneyEl = document.getElementById('roi-money');
            if (moneyEl) {
                moneyEl.textContent = totalMoney > 0 ?
                    `~$${totalMoney.toFixed(2)}` : '~$0';
            }

            // Update story
            const storyEl = document.getElementById('roi-story');
            if (storyEl) {
                const totalInsights = knowledge.total_insights || 0;
                const totalDecisions = knowledge.total_decisions || 0;

                if (reused > 0) {
                    storyEl.innerHTML = `<span class="roi-story-highlight">ðŸ’¡ ${reused} solutions</span> found and reused instead of researching again`;
                } else if (prevented > 0) {
                    storyEl.innerHTML = `<span class="roi-story-highlight">ðŸ›¡ï¸ ${prevented} bugs</span> prevented thanks to past insights`;
                } else if (totalInsights > 0) {
                    storyEl.innerHTML = `You have <span class="roi-story-highlight">${totalInsights} insights</span> and <span class="roi-story-highlight">${totalDecisions} decisions</span> ready for reuse`;
                } else {
                    storyEl.innerHTML = `<span class="roi-story-highlight">Tip:</span> Use log_decision and search_past_solutions to build value`;
                }
            }
        }

        function updateProjectsWidget(snapshot) {
            const grid = document.getElementById('projects-grid');
            const badge = document.getElementById('projects-count-badge');
            if (!grid) return;

            const projects = snapshot.projects || [];
            if (badge) badge.textContent = `(${projects.length})`;

            if (projects.length === 0) {
                grid.innerHTML = '<div style="color: var(--text-muted); font-size: 0.7rem;">No projects found</div>';
                return;
            }

            grid.innerHTML = projects.slice(0, 8).map(p => {
                const statusClass = p.status || 'stale';
                const counts = p.counts || {};
                const semantic = p.semantic || {};

                return `<div class="project-card ${statusClass === 'active' ? 'active' : ''}"
                             onclick="filterByProject('${p.project_id}')">
                    <div class="project-card-name" title="${p.name}">${p.name}</div>
                    <div class="project-card-status">
                        <span class="project-status-dot ${statusClass}"></span>
                        ${statusClass === 'active' ? 'Active' : statusClass === 'recent' ? 'Recent' : 'Stale'}
                    </div>
                    <div class="project-card-counts">
                        ðŸ’¡${counts.insights || 0} ðŸ”’${counts.decisions || 0} âš ï¸${counts.avoids || 0}
                    </div>
                    ${semantic.indexed ? `<span class="project-semantic-badge">ðŸ” ${semantic.doc_count || 0} indexed</span>` : ''}
                </div>`;
            }).join('');
        }

        function filterByProject(projectId) {
            // TODO: Filter activity feed by project
            console.log('Filter by project:', projectId);
            // For now, just highlight in URL or trigger project switch
        }

        function updateKnowledgeWidget(snapshot) {
            const knowledge = snapshot.knowledge || {};

            const insightsEl = document.getElementById('knowledge-insights');
            const decisionsEl = document.getElementById('knowledge-decisions');
            const avoidsEl = document.getElementById('knowledge-avoids');
            const indexedEl = document.getElementById('knowledge-indexed');
            const learningsEl = document.getElementById('knowledge-learnings');

            if (insightsEl) insightsEl.textContent = knowledge.total_insights || 0;
            if (decisionsEl) decisionsEl.textContent = knowledge.total_decisions || 0;
            if (avoidsEl) avoidsEl.textContent = knowledge.total_avoids || 0;
            if (indexedEl) indexedEl.textContent = knowledge.indexed_docs || 0;

            if (learningsEl) {
                const learnings = knowledge.top_learnings || [];
                if (learnings.length === 0) {
                    learningsEl.innerHTML = '<div style="color: var(--text-muted); font-size: 0.65rem; padding: 8px 0;">No learnings yet</div>';
                } else {
                    learningsEl.innerHTML = learnings.slice(0, 3).map(l => {
                        const importance = l.importance || 1;
                        const stars = 'â˜…'.repeat(Math.min(importance, 3)) + 'â˜†'.repeat(3 - Math.min(importance, 3));
                        return `<div class="knowledge-learning">
                            <span class="learning-icon">ðŸ’¡</span>
                            <span class="learning-importance">${stars}</span>
                            <span>${(l.text || '').substring(0, 80)}${l.text?.length > 80 ? '...' : ''}</span>
                        </div>`;
                    }).join('');
                }
            }
        }

        function updateEnvironmentWidget(snapshot) {
            const env = snapshot.environment || {};

            const stackEl = document.getElementById('env-stack');
            const stageEl = document.getElementById('env-stage');
            const portsEl = document.getElementById('env-ports');
            const modeEl = document.getElementById('env-mode');

            if (stackEl) stackEl.textContent = env.stack || 'â€”';
            if (stageEl) stageEl.textContent = env.stage || 'â€”';
            if (modeEl) modeEl.textContent = env.env || 'dev';

            if (portsEl) {
                const ports = env.ports || [];
                if (ports.length === 0) {
                    portsEl.textContent = 'â€”';
                } else {
                    portsEl.innerHTML = ports.map(p => `<span class="env-port">${p}</span>`).join('');
                }
            }
        }

        async function updateCrossProjectWidget() {
            const projectsEl = document.getElementById('cross-projects');
            const insightsEl = document.getElementById('cross-insights');
            const decisionsEl = document.getElementById('cross-decisions');
            const insightsList = document.getElementById('cross-insights-list');
            const timelineItems = document.getElementById('cross-timeline-items');

            try {
                const res = await fetch(API + '/api/cross-project/insights');
                if (!res.ok) return;
                const data = await res.json();
                if (data.status !== 'ok') return;

                const stats = data.knowledge_stats || {};
                const insights = data.global_insights || [];
                const activity = data.recent_activity || [];
                const patterns = data.shared_patterns || [];

                // Update stats
                if (projectsEl) projectsEl.textContent = stats.projects_with_knowledge || 0;
                if (insightsEl) insightsEl.textContent = stats.total_insights || 0;
                if (decisionsEl) decisionsEl.textContent = stats.total_decisions || 0;

                // Update insights list
                if (insightsList) {
                    const displayInsights = insights.slice(0, 3);
                    if (displayInsights.length === 0) {
                        insightsList.innerHTML = '<div style="color: var(--text-muted); font-size: 0.7rem;">No insights yet. Use log_decision and update_live_record to build knowledge.</div>';
                    } else {
                        insightsList.innerHTML = displayInsights.map(insight => {
                            const icon = insight.importance === 'high' ? 'â­' : 'ðŸ’¡';
                            return `
                                <div class="cross-insight-item">
                                    <span class="cross-insight-icon">${icon}</span>
                                    <div class="cross-insight-content">
                                        <div class="cross-insight-text">${insight.text}</div>
                                        <div class="cross-insight-meta">
                                            <span class="cross-insight-project">${insight.project}</span>
                                            ${insight.timestamp ? `<span>${formatTimeAgo(insight.timestamp)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Update timeline
                if (timelineItems) {
                    const displayActivity = activity.slice(0, 5);
                    if (displayActivity.length === 0) {
                        timelineItems.innerHTML = '<div style="color: var(--text-muted); font-size: 0.7rem;">No recent activity</div>';
                    } else {
                        timelineItems.innerHTML = displayActivity.map(act => {
                            const projectName = act.project || 'Unknown';
                            const projectClass = projectName.toLowerCase().replace(/[^a-z]/g, '') || 'default';
                            return `
                                <div class="cross-timeline-item">
                                    <span class="cross-timeline-dot ${projectClass}"></span>
                                    <span class="cross-timeline-project">${projectName}</span>
                                    <span class="cross-timeline-action">${act.file || act.tool || 'Activity'}</span>
                                    <span class="cross-timeline-time">${formatTimeAgo(act.timestamp)}</span>
                                </div>
                            `;
                        }).join('');
                    }
                }

            } catch (e) {
                console.log('Failed to load cross-project insights:', e);
            }
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        async function loadSnapshot() {
            try {
                const res = await fetch(API + '/api/dashboard_snapshot');
                if (!res.ok) return null;
                const data = await res.json();
                _lastSnapshot = data.snapshot;

                // Update all widgets
                updateMultiAIWidget(_lastSnapshot);
                updateROIWidget(_lastSnapshot);
                updateProjectsWidget(_lastSnapshot);
                updateKnowledgeWidget(_lastSnapshot);
                updateEnvironmentWidget(_lastSnapshot);
                updateCrossProjectWidget();  // Separate API call

                return _lastSnapshot;
            } catch (e) {
                console.error('Failed to load snapshot:', e);
                return null;
            }
        }

        // ===== DATA LOADING =====
        let allProjects = [];
        let _lastErrors = [];
        let _lastActivities = [];
        let _lastIdentity = null;

        async function loadData() {
            // Load new unified snapshot for widgets
            loadSnapshot();

            // Fetch each source independently â€” failure of one won't block others
            const [projectJson, errorsJson, activityJson, identityJson] = await Promise.all([
                fetch(API + '/api/projects/grouped')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
                fetch(API + '/api/live-errors')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
                fetch(API + '/api/activity/feed?limit=50')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
                fetch(API + '/api/memory/identity')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
            ]);

            const connected = projectJson !== null || activityJson !== null;

            if (!connected) {
                document.getElementById('header-project-name').textContent = 'Not Connected';
                document.getElementById('goal').textContent = 'Check if server is running';
                return;
            }

            // Update project data only if fetch succeeded
            if (projectJson) {
                projectData = projectJson.active;
                allProjects = [
                    ...(projectJson.active ? [projectJson.active] : []),
                    ...(projectJson.recent || []),
                    ...(projectJson.stale || [])
                ];
            }

            const errors = errorsJson?.errors || [];
            const activities = activityJson?.activities || [];
            _lastIdentity = identityJson?.identity || null;
            _lastErrors = errors;
            _lastActivities = activities;

            // Update each UI section independently
            if (projectJson) {
                updateHeader(projectData);

                updateMainCard(projectData);
                updateBadges(projectData);
                buildProjectDropdown();
            }

            if (errorsJson) {
                updateErrors(errors);
            }

            if (activityJson) {
                updateSessionInfo(activities, projectData);
            }

            updateNowCard(projectData, _lastErrors, _lastActivities);
            updateIdentityCard(_lastIdentity, projectData);

        }

        // session start time (set when project data loads)
        let sessionStartTime = null;

        function getActiveEditorNames(data) {
            const activeAis = data?.active_ais || {};
            const now = new Date();
            const ACTIVE_TIMEOUT_MS = 5 * 60 * 1000;

            return Object.entries(activeAis)
                .filter(([, ai]) => ai.last_activity && (now - new Date(ai.last_activity)) < ACTIVE_TIMEOUT_MS)
                .map(([name]) => name.charAt(0).toUpperCase() + name.slice(1));
        }

        function updateHeader(data) {
            // Project name in header
            document.getElementById('header-project-name').textContent = data?.name || 'No Project';

            // Editor tag â€” show all active AIs
            const activeNames = getActiveEditorNames(data);

            const editorEl = document.getElementById('live-editor');
            if (activeNames.length > 0) {
                editorEl.textContent = activeNames.join(' + ');
            } else {
                const editor = data?.ai_session?.editor || 'Claude';
                editorEl.textContent = editor.charAt(0).toUpperCase() + editor.slice(1);
            }
        }

        // Cache for canonical latest
        let _cachedCanonicalLatest = null;

        async function fetchCanonicalLatest() {
            try {
                const res = await fetch(API + '/api/changes/latest');
                const data = await res.json();
                if (data.status === 'ok' && data.canonical_latest) {
                    _cachedCanonicalLatest = data.canonical_latest;
                    return data.canonical_latest;
                }
            } catch (e) {
                console.log('Failed to fetch canonical latest:', e);
            }
            return null;
        }

        function updateNowCard(data, errors, activities) {
            const primaryEl = document.getElementById('now-primary');
            const secondaryEl = document.getElementById('now-secondary');
            if (!primaryEl || !secondaryEl) return;

            const activeNames = getActiveEditorNames(data);
            const sessionEditorRaw = data?.ai_session?.editor || '';
            const sessionEditor = sessionEditorRaw
                ? sessionEditorRaw.charAt(0).toUpperCase() + sessionEditorRaw.slice(1)
                : '';
            const sessionTsRaw = data?.ai_session?.last_activity || data?.ai_session?.started_at || null;
            const sessionTs = sessionTsRaw ? new Date(sessionTsRaw) : null;
            const now = Date.now();
            const sessionIsRecent = sessionTs ? (now - sessionTs.getTime()) < (20 * 60 * 1000) : false;
            const hasRecentActivity = (activities || []).some(a =>
                a?.timestamp && (now - new Date(a.timestamp).getTime()) < (10 * 60 * 1000)
            );

            if ((errors || []).length > 0) {
                const msg = (errors[0]?.message || 'Open error').replace(/\s+/g, ' ').trim();
                primaryEl.textContent = `ðŸ”´ ${errors.length} open error(s) need attention`;
                secondaryEl.textContent = `${msg.length > 90 ? msg.slice(0, 90) + '...' : msg}`;
                return;
            }

            if (activeNames.length > 0) {
                primaryEl.textContent = `ðŸŸ¢ ${activeNames.join(' + ')} working now`;
            } else if (sessionEditor && (sessionIsRecent || hasRecentActivity)) {
                primaryEl.textContent = `ðŸŸ¢ ${sessionEditor} active`;
            } else if (sessionEditor) {
                primaryEl.textContent = `ðŸŸ£ ${sessionEditor} connected`;
            } else {
                primaryEl.textContent = 'ðŸŸ¡ No active work right now';
            }

            // Use canonical latest (unified source of truth)
            fetchCanonicalLatest().then(canonical => {
                if (canonical && canonical.text) {
                    const sourceIcon = canonical.source === 'activity' ? 'ðŸ“' :
                                       canonical.source === 'git' ? 'ðŸ”€' :
                                       canonical.source === 'intent' ? 'ðŸŽ¯' : 'ðŸ“Š';
                    secondaryEl.textContent = `${sourceIcon} ${canonical.text}`;
                } else if (sessionEditor) {
                    secondaryEl.textContent = 'Connected to session, waiting for activity';
                } else {
                    secondaryEl.textContent = 'No recent activity to display';
                }
            });
        }

        function renderIdentityTags(elId, items, emptyText) {
            const el = document.getElementById(elId);
            if (!el) return;
            if (!items || !items.length) {
                el.innerHTML = `<span class="identity-tag">${emptyText}</span>`;
                return;
            }
            el.innerHTML = items.slice(0, 5).map(item =>
                `<span class="identity-tag">${item}</span>`
            ).join('');
        }

        function updateIdentityCard(identity, project) {
            const aboutEl = document.getElementById('identity-about');
            const goalEl = document.getElementById('identity-goal');
            const typeEl = document.getElementById('identity-type');
            const stageEl = document.getElementById('identity-stage');
            const nextEl = document.getElementById('identity-next');
            if (!aboutEl || !goalEl || !typeEl || !stageEl || !nextEl) return;

            const safeIdentity = identity || {};
            const about = safeIdentity.about || project?.summary || (project?.name ? `Project ${project.name}` : 'Active FixOnce Project');
            const goal = safeIdentity.goal || project?.current_goal || project?.summary || 'No goal defined';
            const projectType = safeIdentity.project_type || (project?.stack || 'Not classified');
            const stage = safeIdentity.stage || 'Not classified';
            const next = safeIdentity.next_step || project?.next_step || 'Not defined';

            aboutEl.textContent = about;
            goalEl.textContent = goal;
            typeEl.textContent = projectType;
            stageEl.textContent = stage;
            nextEl.textContent = next;

            const decisionTags = (safeIdentity.critical_decisions || [])
                .map(d => (typeof d === 'string' ? d : d.decision))
                .filter(Boolean);
            const riskTags = safeIdentity.sensitive_points || safeIdentity?.structured_memory?.risks || [];

            renderIdentityTags('identity-decisions', decisionTags, 'No critical decisions');
            renderIdentityTags('identity-risks', riskTags, 'No sensitive points');

            // Semantic identity section
            const semantic = safeIdentity.semantic || {};
            const semanticRow = document.getElementById('identity-semantic-row');
            const signatureRow = document.getElementById('identity-signature-row');
            const learningsEl = document.getElementById('identity-learnings');
            const signatureEl = document.getElementById('identity-signature');

            if (semantic.enabled && (semantic.top_learnings?.length || semantic.signature?.length)) {
                // Show semantic sections
                if (semantic.top_learnings?.length && semanticRow && learningsEl) {
                    semanticRow.style.display = 'block';
                    learningsEl.innerHTML = semantic.top_learnings.slice(0, 3)
                        .map(l => `<div class="learning-item">ðŸ’¡ ${l}</div>`)
                        .join('');
                }

                if (semantic.signature?.length && signatureRow && signatureEl) {
                    signatureRow.style.display = 'block';
                    signatureEl.innerHTML = semantic.signature
                        .map(s => `<span class="identity-tag">${s}</span>`)
                        .join('');
                }
            } else {
                // Hide semantic sections if not available
                if (semanticRow) semanticRow.style.display = 'none';
                if (signatureRow) signatureRow.style.display = 'none';
            }
        }

        async function updateBadges(data) {
            const decisionsCount = data?.decisions_count || 0;
            const avoidCount = data?.avoid_count || 0;
            setMenuBadge('decisions-badge', decisionsCount, 'info');
            setMenuBadge('avoid-badge', avoidCount, 'risk');

            // Decisions stat in main card
            const statDec = document.getElementById('stat-decisions');
            if (statDec) statDec.textContent = decisionsCount;

            // Fetch debug sessions count
            let debugCount = 0;
            try {
                const res = await fetch(API + '/api/memory/debug-sessions');
                const json = await res.json();
                debugCount = json.count || 0;
            } catch (e) {
                debugCount = 0;
            }
            setMenuBadge('debug-sessions-badge', debugCount, 'good');
            const statResolved = document.getElementById('stat-resolved');
            if (statResolved) statResolved.textContent = debugCount;
            updateMoreMenuHeadline(decisionsCount, avoidCount, debugCount);

            // Count new items (added today) for "More" button badge
            await updateMoreButtonBadge();
        }

        // Track last seen timestamp
        function getLastSeenTime() {
            const stored = localStorage.getItem('fixonce_last_seen');
            return stored ? new Date(stored) : new Date(0);
        }

        function markAsSeen() {
            localStorage.setItem('fixonce_last_seen', new Date().toISOString());
            updateMoreButtonBadge(); // Refresh badge
        }

        async function updateMoreButtonBadge() {
            const moreBadge = document.getElementById('more-badge');
            if (!moreBadge) return;

            const lastSeen = getLastSeenTime();
            let newCount = 0;

            // Check decisions
            try {
                const res = await fetch(API + '/api/memory/decisions');
                const data = await res.json();
                const decisions = data.decisions || [];
                newCount += decisions.filter(d =>
                    d.timestamp && new Date(d.timestamp) > lastSeen
                ).length;
            } catch (e) {}

            // Check debug sessions
            try {
                const res = await fetch(API + '/api/memory/debug-sessions');
                const data = await res.json();
                const sessions = data.debug_sessions || [];
                newCount += sessions.filter(s =>
                    (s.timestamp && new Date(s.timestamp) > lastSeen) ||
                    (s.resolved_at && new Date(s.resolved_at) > lastSeen)
                ).length;
            } catch (e) {}

            // Check avoid
            try {
                const res = await fetch(API + '/api/memory/avoid');
                const data = await res.json();
                const avoids = data.avoids || [];
                newCount += avoids.filter(a =>
                    a.timestamp && new Date(a.timestamp) > lastSeen
                ).length;
            } catch (e) {}

            // Show/hide badge
            if (newCount > 0) {
                moreBadge.textContent = String(newCount);
                moreBadge.style.display = 'flex';
            } else {
                moreBadge.style.display = 'none';
            }
        }

        function setMenuBadge(id, count, tone) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = String(count || 0);
            el.classList.remove('visible', 'tone-risk', 'tone-good');
            if (count > 0) {
                el.classList.add('visible');
                if (tone === 'risk') el.classList.add('tone-risk');
                if (tone === 'good') el.classList.add('tone-good');
            }
        }

        function updateMoreMenuHeadline(decisionsCount, avoidCount, debugCount) {
            const headline = document.getElementById('more-menu-headline');
            if (!headline) return;
            if (avoidCount > 0) {
                headline.textContent = `${avoidCount} "Avoid" items to review`;
                return;
            }
            if (debugCount > 0) {
                headline.textContent = `${debugCount} Resolved Issues to recycle`;
                return;
            }
            if (decisionsCount > 0) {
                headline.textContent = `${decisionsCount} Active Decisions for this project`;
                return;
            }
            headline.textContent = 'Choose Action';
        }

        function buildProjectDropdown() {
            const dropdown = document.getElementById('project-dropdown');
            dropdown.innerHTML = allProjects.map(p => `
                <div class="project-dropdown-item ${p.id === projectData?.id ? 'active' : ''}"
                     onclick="switchProject('${p.id}')">
                    <div class="project-dropdown-name">${p.name || 'Unknown'}</div>
                    <div class="project-dropdown-path">${p.working_dir || ''}</div>
                </div>
            `).join('');
        }

        function updateMainCard(data) {
            if (!data) {
                document.getElementById('goal').textContent = '-';
                return;
            }

            const goal = data.current_goal || data.summary || '-';
            document.getElementById('goal').textContent = goal;

            // Next step â€” only show if different from goal
            const targetEl = document.getElementById('target');
            const targetText = document.getElementById('target-text');
            const nextStep = data.next_step;
            if (nextStep && nextStep !== goal) {
                targetText.textContent = nextStep;
                targetEl.style.display = 'flex';
            } else {
                targetEl.style.display = 'none';
            }

            // Session timer start â€” from ai_session.started_at
            if (data.ai_session?.started_at && !sessionStartTime) {
                sessionStartTime = new Date(data.ai_session.started_at);
            }
        }

        function updateErrors(errors) {
            const mainCard = document.getElementById('main-card');
            const errorCard = document.getElementById('error-card');
            const healthEl = document.getElementById('stat-health');

            if (errors.length > 0) {
                currentError = errors[0];
                document.getElementById('error-message').textContent =
                    currentError.message || 'Unknown error';

                const solutionEl = document.getElementById('error-solution');
                const solutionText = document.getElementById('error-solution-text');
                if (currentError.solution) {
                    solutionText.textContent = currentError.solution.text || 'Found existing solution';
                    solutionEl.style.display = 'flex';
                } else {
                    findSolution(currentError.message);
                }

                mainCard.style.display = 'none';
                errorCard.classList.add('active');
                errorCard.classList.add('shake');
                setTimeout(() => errorCard.classList.remove('shake'), 300);

                if (healthEl) {
                    healthEl.textContent = errors.length;
                    healthEl.className = 'stat-value warn';
                }
            } else {
                mainCard.style.display = 'block';
                errorCard.classList.remove('active');
                if (healthEl) {
                    healthEl.textContent = 'âœ“';
                    healthEl.className = 'stat-value ok';
                }
            }
        }

        async function findSolution(errorMsg) {
            try {
                const keywords = errorMsg.split(/[\s:,]+/).filter(w => w.length > 3).slice(0, 4).join(' ');
                const res = await fetch(API + '/api/memory/search?q=' + encodeURIComponent(keywords));
                const data = await res.json();

                if (data.results && data.results.length > 0 && data.results[0].similarity > 40) {
                    const solutionEl = document.getElementById('error-solution');
                    const solutionText = document.getElementById('error-solution-text');
                    solutionText.textContent = data.results[0].text.substring(0, 100);
                    solutionEl.style.display = 'flex';
                }
            } catch {}
        }

        function updateSessionInfo(activities, data) {
            renderInlineFeed(activities);
        }

        let _feedFingerprint = null;

        function renderInlineFeed(activities) {
            const container = document.getElementById('feed-items');
            if (!container || !activities.length) return;

            const groups = groupActivities(activities).slice(0, 5);
            if (!groups.length) return;

            // Only re-render if the latest activity changed
            const fingerprint = groups[0].firstTs + '|' + groups.length;
            const isFirstRender = _feedFingerprint === null;
            if (fingerprint === _feedFingerprint) {
                // Data unchanged â€” just update time labels silently
                updateFeedTimes();
                return;
            }
            const prevFingerprint = _feedFingerprint;
            _feedFingerprint = fingerprint;

            const now = new Date();

            const html = groups.map((g, i) => {
                const icon = storyIcon(g);
                const text = feedNarrative(g);
                const ts = new Date(g.firstTs);
                const diffMins = Math.round((now - ts) / 60000);

                let timeLabel;
                if (diffMins < 1)       timeLabel = 'now';
                else if (diffMins < 60) timeLabel = `${diffMins}m ago`;
                else                    timeLabel = `${Math.floor(diffMins/60)}h ago`;

                const isFresh = diffMins < 3;
                // Animate only the top item when it's genuinely new (not first render)
                const isNew = i === 0 && !isFirstRender && prevFingerprint !== null;

                return `
                    <div class="feed-item ${isFresh ? 'fresh' : ''} ${isNew ? 'new-entry' : ''}" data-ts="${g.firstTs}">
                        <div class="feed-dot ${icon.cls || 'default'}">${icon.emoji}</div>
                        <div class="feed-body">
                            <div class="feed-text">${text}</div>
                            <div class="feed-time feed-time-rel">${timeLabel}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="feed-item"><div class="feed-dot default">Â·</div><div class="feed-body"><div class="feed-text" style="color:var(--text-muted)">No activity yet</div></div></div>';
        }

        function updateFeedTimes() {
            const now = new Date();
            document.querySelectorAll('.feed-item[data-ts]').forEach(el => {
                const ts = parseInt(el.dataset.ts);
                const diffMins = Math.round((now - ts) / 60000);
                let label;
                if (diffMins < 1)       label = 'now';
                else if (diffMins < 60) label = `${diffMins}m ago`;
                else                    label = `${Math.floor(diffMins/60)}h ago`;
                const timeEl = el.querySelector('.feed-time-rel');
                if (timeEl) timeEl.textContent = label;
            });
        }

        // Human-readable work story (progress-oriented, not technical counters)
        function feedNarrative(group) {
            const name = group.humanName;
            const ctx = group.fileContext;

            // Commands
            if (group.tool === null && group.command) {
                if (group.command.startsWith('git commit')) return 'Saved a new work version';
                if (group.command.startsWith('git')) return 'Git operation completed';
                return 'Executed maintenance command';
            }

            if (group.tool === 'Write') {
                if (ctx === 'ui') return `Built new screen: ${name}`;
                if (ctx === 'code') return `Added new component: ${name}`;
                return `Created new file: ${name}`;
            }

            if (ctx === 'code') {
                return group.items.length > 1
                    ? `Multiple improvements to ${name}`
                    : `Updated ${name}`;
            }

            if (ctx === 'ui') {
                return group.items.length > 1
                    ? `Improved UX in ${name}`
                    : `Updated interface: ${name}`;
            }

            return `Made progress on ${name}`;
        }

        function storyNarrative(group) {
            return feedNarrative(group);
        }

        // ===== ERROR HANDLING =====
        async function sendErrorToAI() {
            if (!currentError) {
                showToast('No error to send');
                return;
            }

            // Show AI picker modal
            showAIPicker();
        }

        function showAIPicker() {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'ai-picker-modal';
            modal.innerHTML = `
                <div class="ai-picker-overlay" onclick="closeAIPicker()"></div>
                <div class="ai-picker-content">
                    <div class="ai-picker-title">Send Error to AI</div>
                    <div class="ai-picker-buttons">
                        <button class="ai-picker-btn" onclick="sendToAI('claude')">
                            <span class="ai-picker-icon">ðŸ¤–</span>
                            <span>Claude Code</span>
                        </button>
                        <button class="ai-picker-btn" onclick="sendToAI('cursor')">
                            <span class="ai-picker-icon">âš¡</span>
                            <span>Cursor</span>
                        </button>
                        <button class="ai-picker-btn secondary" onclick="copyErrorPrompt()">
                            <span class="ai-picker-icon">ðŸ“‹</span>
                            <span>Copy only</span>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add styles if not exists
            if (!document.getElementById('ai-picker-styles')) {
                const styles = document.createElement('style');
                styles.id = 'ai-picker-styles';
                styles.textContent = `
                    #ai-picker-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .ai-picker-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.7);
                    }
                    .ai-picker-content {
                        position: relative;
                        background: var(--bg-primary);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 24px;
                        min-width: 280px;
                    }
                    .ai-picker-title {
                        text-align: center;
                        font-weight: 600;
                        margin-bottom: 20px;
                        font-size: 1.1rem;
                    }
                    .ai-picker-buttons {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }
                    .ai-picker-btn {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 14px 18px;
                        background: var(--bg-card);
                        border: 1px solid var(--border);
                        border-radius: var(--radius-sm);
                        color: var(--text-primary);
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .ai-picker-btn:hover {
                        background: rgba(129, 178, 154, 0.2);
                        border-color: var(--accent-green);
                    }
                    .ai-picker-btn.secondary {
                        background: transparent;
                        border-color: var(--text-muted);
                    }
                    .ai-picker-btn.secondary:hover {
                        background: var(--bg-card);
                    }
                    .ai-picker-icon {
                        font-size: 1.3rem;
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function closeAIPicker() {
            const modal = document.getElementById('ai-picker-modal');
            if (modal) modal.remove();
        }

        async function sendToAI(aiType) {
            closeAIPicker();

            if (!currentError) return;

            // Build error context
            const errorMsg = currentError.message || 'Unknown error';
            const source = currentError.source || '';
            const line = currentError.line || '';

            // Queue error for AI via FixOnce API
            try {
                await fetch(API + '/api/memory/queue-for-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'error',
                        message: errorMsg,
                        source: source,
                        line: line,
                        priority: 'high'
                    })
                });
            } catch (e) {
                console.log('Queue API not available, using direct launch');
            }

            // Launch AI
            if (aiType === 'claude') {
                // Open terminal with claude command
                showToast('ðŸš€ Opening Claude Code...');
                window.open('fixonce://launch/claude?error=' + encodeURIComponent(errorMsg), '_blank');
                // Fallback: copy to clipboard
                await copyErrorPrompt(true);
            } else if (aiType === 'cursor') {
                // Open Cursor with file - need full path
                showToast('ðŸš€ Opening Cursor...');
                const rootPath = projectData?.root_path || projectData?.working_dir || '/Users/haimdayan/Desktop/FixOnce';
                if (source) {
                    const fullPath = source.startsWith('/') ? source : rootPath + '/' + source;
                    window.location.href = 'cursor://file' + fullPath + (line ? ':' + line : '');
                } else {
                    // Just open project folder
                    window.location.href = 'cursor://file' + rootPath;
                }
                await copyErrorPrompt(true);
            }

            // Mark as being handled
            handleError();
        }

        async function copyErrorPrompt(silent = false) {
            if (!silent) closeAIPicker();

            if (!currentError) return;

            const errorMsg = currentError.message || 'Unknown error';
            const source = currentError.source || '';
            const line = currentError.line || '';

            // Search for existing solutions
            let solutionText = '';
            try {
                const res = await fetch(API + '/api/memory/search?q=' + encodeURIComponent(errorMsg.substring(0, 50)));
                const data = await res.json();
                if (data.results && data.results.length > 0) {
                    solutionText = data.results[0].text || data.results[0].decision || '';
                }
            } catch (e) {}

            // Build prompt
            let prompt = `ðŸ”§ **Error to fix:**\n\`${errorMsg}\`\n\n`;
            if (source) {
                prompt += `ðŸ“ **Location:** ${source}`;
                if (line) prompt += `:${line}`;
                prompt += `\n\n`;
            }
            if (solutionText) {
                prompt += `ðŸ’¡ **Existing solution:**\n"${solutionText}"\n\n`;
            }
            prompt += `Fix this error.`;

            // Copy
            try {
                await navigator.clipboard.writeText(prompt);
                if (!silent) showToast('ðŸ“‹ Copied!');
            } catch (e) {
                const ta = document.createElement('textarea');
                ta.value = prompt;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                if (!silent) showToast('ðŸ“‹ Copied!');
            }
        }

        function handleError() {
            // Mark as handled and refresh
            currentError = null;
            showToast('Marked as Handled âœ“');
            loadData();
        }

        function dismissError() {
            // Just hide for now
            document.getElementById('main-card').style.display = 'block';
            document.getElementById('error-card').classList.remove('active');
            currentError = null;
        }

        // ===== PANELS & OVERLAYS =====
        function openOverlay(type, opts = {}) {
            const overlay = document.getElementById('overlay-' + type);
            if (!overlay) return;
            overlay.classList.add('active');

            // Show backdrop for side panels
            if (['history', 'search', 'decisions', 'avoid', 'debug-sessions'].includes(type)) {
                document.getElementById('panel-backdrop').classList.add('active');
            }

            if (type === 'history') {
                historyFilter = opts.filter || 'all';
                const titleEl = document.getElementById('history-title');
                if (titleEl) {
                    titleEl.textContent = historyFilter === 'today' ? 'History (Today)' : 'History';
                }
                loadHistory();
            }
            if (type === 'search') document.getElementById('search-input').focus();
            if (type === 'insight') document.getElementById('insight-input').focus();
            if (type === 'decisions') { loadDecisions(); markAsSeen(); }
            if (type === 'avoid') { loadAvoid(); markAsSeen(); }
            if (type === 'debug-sessions') { loadDebugSessions(); markAsSeen(); }
        }

        function closeOverlay(type) {
            const overlay = document.getElementById('overlay-' + type);
            if (overlay) overlay.classList.remove('active');

            // Hide backdrop if no side panels open
            const sidePanels = ['history', 'search', 'decisions', 'avoid', 'debug-sessions'];
            if (sidePanels.includes(type)) {
                const anyOpen = sidePanels.some(p =>
                    document.getElementById('overlay-' + p)?.classList.contains('active')
                );
                if (!anyOpen) {
                    document.getElementById('panel-backdrop').classList.remove('active');
                }
            }
        }

        function closeAllPanels() {
            document.querySelectorAll('.overlay.active').forEach(o => {
                o.classList.remove('active');
            });
            document.getElementById('panel-backdrop').classList.remove('active');
            document.getElementById('project-dropdown').classList.remove('active');
            document.getElementById('more-menu').classList.remove('active');
        }

        // ===== PROJECT DROPDOWN =====
        function toggleProjectDropdown() {
            const dropdown = document.getElementById('project-dropdown');
            dropdown.classList.toggle('active');
            // Close more menu if open
            document.getElementById('more-menu').classList.remove('active');
        }

        async function switchProject(projectId) {
            document.getElementById('project-dropdown').classList.remove('active');
            try {
                const res = await fetch(API + '/api/projects/switch/' + projectId, {
                    method: 'POST'
                });
                if (res.ok) {
                    showToast('Switched to project');
                    loadData();
                } else {
                    showToast('Error switching');
                }
            } catch (e) {
                showToast('Error switching project');
            }
        }

        // ===== MORE MENU =====
        function toggleMoreMenu() {
            const menu = document.getElementById('more-menu');
            menu.classList.toggle('active');
            // Close project dropdown if open
            document.getElementById('project-dropdown').classList.remove('active');
        }

        function closeMoreMenu() {
            document.getElementById('more-menu').classList.remove('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.project-selector') && !e.target.closest('.project-dropdown')) {
                document.getElementById('project-dropdown').classList.remove('active');
            }
            if (!e.target.closest('.more-menu-container')) {
                document.getElementById('more-menu').classList.remove('active');
            }
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAllPanels();
            }
        });

        // ===== HISTORY (Story Mode) =====
        function groupActivities(activities) {
            if (!activities.length) return [];

            const groups = [];
            let current = null;

            for (const a of activities) {
                const key = a.human_name || a.file?.split('/').pop() || a.command || 'unknown';
                const ts = new Date(a.timestamp).getTime();

                if (current && current.key === key && (current.lastTs - ts) < 5 * 60 * 1000) {
                    current.items.push(a);
                    current.lastTs = ts;
                } else {
                    if (current) groups.push(current);
                    current = {
                        key,
                        items: [a],
                        firstTs: ts,
                        lastTs: ts,
                        humanName: a.human_name || '',
                        fileContext: a.file_context || '',
                        tool: a.tool,
                        command: a.command
                    };
                }
            }
            if (current) groups.push(current);
            return groups;
        }

        function narrativeText(group) {
            const count = group.items.length;
            const name = group.humanName;
            const ctx = group.fileContext;
            const durationMs = group.firstTs - group.lastTs;
            const durationMins = Math.round(durationMs / 60000);
            const durationStr = durationMins > 1 ? ` for ${durationMins}m` : '';

            // Calculate total lines added/removed
            let totalAdded = 0, totalRemoved = 0;
            group.items.forEach(a => {
                if (a.diff) {
                    totalAdded += a.diff.added || 0;
                    totalRemoved += a.diff.removed || 0;
                }
            });

            // Commands
            if (group.tool === null && group.command) {
                const cmd = group.command.length > 40
                    ? group.command.substring(0, 40) + '...'
                    : group.command;
                if (group.command.startsWith('git')) {
                    return `Git: ${cmd}`;
                }
                return `Ran: ${cmd}`;
            }

            // Code files
            if (ctx === 'code') {
                if (totalAdded > 50) {
                    return count === 1
                        ? `Expanded ${name} â€” ${totalAdded} new lines`
                        : `Worked on ${name} â€” ${count} changes, +${totalAdded} lines${durationStr}`;
                }
                return count === 1
                    ? `Edited ${name}`
                    : `Worked on ${name} â€” ${count} changes${durationStr}`;
            }

            // View/design files
            if (ctx === 'ui') {
                if (count === 1) return `Updated ${name}`;
                if (count <= 3) return `Improved ${name} â€” ${count} updates${durationStr}`;
                return `Styled ${name} â€” ${count} updates${durationStr}`;
            }

            // Write (new file)
            if (group.tool === 'Write') {
                return `Created ${name}`;
            }

            // Fallback
            if (count === 1) return `${getActivityType(group.items[0])} ${name}`;
            return `${name} â€” ${count} actions${durationStr}`;
        }

        function storyIcon(group) {
            const ctx = group.fileContext;
            if (group.command?.startsWith('git')) return { emoji: 'ðŸ”€', cls: 'git' };
            if (group.tool === null && group.command) return { emoji: 'âš¡', cls: 'command' };
            if (ctx === 'code') return { emoji: 'ðŸ› ', cls: 'code' };
            if (ctx === 'ui') return { emoji: 'ðŸŽ¨', cls: 'design' };
            if (group.tool === 'Write') return { emoji: 'âœ¨', cls: 'code' };
            return { emoji: 'ðŸ“', cls: '' };
        }

        function dayLabel(ts) {
            const d = new Date(ts);
            const now = new Date();
            const today = now.toDateString();
            const yesterday = new Date(now - 86400000).toDateString();

            if (d.toDateString() === today) return 'Today';
            if (d.toDateString() === yesterday) return 'Yesterday';
            return d.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'short' });
        }

        async function loadHistory() {
            const container = document.getElementById('history-content');

            try {
                const res = await fetch(API + '/api/activity/feed?limit=50');
                const data = await res.json();
                const activities = data.activities || [];

                const localDateKey = (d) => d.toLocaleDateString('sv-SE'); // YYYY-MM-DD (local)
                const todayKey = localDateKey(new Date());
                const filteredActivities = historyFilter === 'today'
                    ? activities.filter(a => localDateKey(new Date(a.timestamp)) === todayKey)
                    : activities;

                if (filteredActivities.length === 0) {
                    container.innerHTML = historyFilter === 'today'
                        ? '<div class="history-empty">No activity today</div>'
                        : '<div class="history-empty">No history yet</div>';
                    return;
                }

                const groups = groupActivities(filteredActivities);
                let html = '';
                let lastDay = '';

                // Keep title simple and non-technical
                const titleEl = document.getElementById('history-title');
                if (titleEl) {
                    if (historyFilter === 'today') {
                        titleEl.textContent = 'History (Today)';
                    } else {
                        titleEl.textContent = 'History';
                    }
                }

                for (const g of groups) {
                    const day = dayLabel(g.firstTs);
                    if (day !== lastDay) {
                        html += `<div class="story-day-label">${day}</div>`;
                        lastDay = day;
                    }

                    const icon = storyIcon(g);
                    const text = storyNarrative(g);
                    const rel = formatTime(new Date(g.firstTs).toISOString());
                    const timeLabel = rel;

                    html += `
                        <div class="story-item">
                            <div class="story-icon ${icon.cls}">${icon.emoji}</div>
                            <div class="story-body">
                                <div class="story-text">${text}</div>
                                <div class="story-meta">
                                    <span>${timeLabel}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = '<div class="history-empty">Error loading</div>';
            }
        }

        // ===== DECISIONS =====
        async function loadDecisions() {
            const container = document.getElementById('decisions-content');
            try {
                const res = await fetch(API + '/api/memory/decisions');
                const data = await res.json();
                const decisions = data.decisions || [];

                if (decisions.length === 0) {
                    container.innerHTML = '<div class="history-empty">No Active Decisions</div>';
                    return;
                }

                // Reverse to show newest first
                const reversed = [...decisions].reverse();

                // Check if decision is new (after last seen)
                const lastSeen = getLastSeenTime();
                const isNew = (timestamp) => {
                    if (!timestamp) return false;
                    return new Date(timestamp) > lastSeen;
                };

                container.innerHTML = reversed.map(d => `
                    <div class="history-item${isNew(d.timestamp) ? ' new-item' : ''}">
                        <div class="history-item-header">
                            <span class="history-item-type">Decision${isNew(d.timestamp) ? ' <span class="new-badge">new</span>' : ''}</span>
                            <span class="history-item-time">${formatTime(d.timestamp)}</span>
                        </div>
                        <div class="history-item-text"><strong>${d.decision}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                            ${d.reason}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="history-empty">Error loading</div>';
            }
        }

        // ===== AVOID =====
        async function loadAvoid() {
            const container = document.getElementById('avoid-content');
            try {
                const res = await fetch(API + '/api/memory/avoid');
                const data = await res.json();
                const avoids = data.avoids || [];

                if (avoids.length === 0) {
                    container.innerHTML = '<div class="history-empty">No Avoid items</div>';
                    return;
                }

                // Reverse to show newest first
                const reversed = [...avoids].reverse();
                const lastSeen = getLastSeenTime();
                const isNew = (timestamp) => timestamp && new Date(timestamp) > lastSeen;

                container.innerHTML = reversed.map(a => `
                    <div class="history-item${isNew(a.timestamp) ? ' new-item' : ''}" style="border-right: 3px solid var(--accent-red);">
                        <div class="history-item-header">
                            <span class="history-item-type">ðŸš« Avoid${isNew(a.timestamp) ? ' <span class="new-badge">new</span>' : ''}</span>
                            <span class="history-item-time">${formatTime(a.timestamp)}</span>
                        </div>
                        <div class="history-item-text"><strong>${a.what}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                            ${a.reason}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="history-empty">Error loading</div>';
            }
        }

        // ===== DEBUG SESSIONS =====
        async function loadDebugSessions() {
            const container = document.getElementById('debug-sessions-content');
            try {
                const res = await fetch(API + '/api/memory/debug-sessions');
                const data = await res.json();
                const sessions = data.debug_sessions || [];

                // Update badge
                const badge = document.getElementById('debug-sessions-badge');
                if (badge) badge.textContent = sessions.length;

                if (sessions.length === 0) {
                    container.innerHTML = '<div class="history-empty">No Resolved Issues yet</div>';
                    return;
                }

                // Sort by resolved_at (most recent first)
                sessions.sort((a, b) => new Date(b.resolved_at) - new Date(a.resolved_at));

                const lastSeen = getLastSeenTime();
                const isNew = (timestamp) => timestamp && new Date(timestamp) > lastSeen;

                container.innerHTML = sessions.map(s => `
                    <div class="history-item debug-session-item${isNew(s.resolved_at || s.timestamp) ? ' new-item' : ''}" style="border-right: 3px solid var(--accent-green);">
                        <div class="history-item-header">
                            <span class="history-item-type">ðŸ› Issue${isNew(s.resolved_at || s.timestamp) ? ' <span class="new-badge">new</span>' : ''}</span>
                            <span class="history-item-time">${formatTime(s.resolved_at)}</span>
                        </div>
                        <div class="history-item-text"><strong>${s.problem}</strong></div>

                        <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                                <span style="color: var(--accent-yellow);">ðŸŽ¯ Root cause:</span> ${s.root_cause}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--accent-green);">
                                <span>âœ… Solution:</span> ${s.solution}
                            </div>
                            ${s.files_changed && s.files_changed.length > 0 ? `
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                                    ðŸ“ ${s.files_changed.join(', ')}
                                </div>
                            ` : ''}
                            ${s.symptoms && s.symptoms.length > 0 ? `
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                                    ðŸ” Symptoms: ${s.symptoms.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="history-empty">Error loading</div>';
            }
        }

        function getActivityType(a) {
            if (a.tool === 'Edit') return 'Edit';
            if (a.tool === 'Write') return 'Create';
            if (a.tool === 'Bash') return 'Command';
            if (a.tool === 'Read') return 'Read';
            if (a._isInsight) return 'Insight';
            if (a._isDecision) return 'Decision';
            if (a._isError) return 'Error';
            return a.tool || 'Action';
        }

        function getActivityText(a) {
            if (a._isInsight || a._isDecision) return a.message || '-';
            if (a.human_name) return a.human_name;
            if (a.file) return a.file.split('/').pop();
            if (a.command) return a.command.substring(0, 50);
            return a.description || '-';
        }

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            const now = new Date();
            const diffMs = now - d;
            const diffMins = Math.round(diffMs / 60000);

            if (diffMins < 1) return 'now';
            if (diffMins < 60) return diffMins + 'm ago';

            const diffHours = Math.round(diffMins / 60);
            if (diffHours < 24) return diffHours + 'h ago';

            return d.toLocaleDateString('en-US');
        }

        // ===== SEARCH =====
        let searchTimeout;

        async function handleSearch(query) {
            clearTimeout(searchTimeout);

            const container = document.getElementById('search-results');

            if (!query || query.length < 2) {
                container.innerHTML = '<div class="history-empty">Type to search...</div>';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(API + '/api/memory/search?q=' + encodeURIComponent(query));
                    const data = await res.json();

                    if (!data.results || data.results.length === 0) {
                        container.innerHTML = '<div class="history-empty">No results found</div>';
                        return;
                    }

                    container.innerHTML = data.results.map(r => `
                        <div class="search-result" onclick="useResult('${escapeHtml(r.text)}')">
                            <div class="search-result-match">${r.similarity}% match</div>
                            <div class="search-result-text">${escapeHtml(r.text)}</div>
                        </div>
                    `).join('');

                } catch (e) {
                    container.innerHTML = '<div class="history-empty">Search error</div>';
                }
            }, 300);
        }

        function useResult(text) {
            // Copy to clipboard
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard');
            closeOverlay('search');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== SAVE INSIGHT =====
        async function saveInsight() {
            const input = document.getElementById('insight-input');
            const text = input.value.trim();

            if (!text) return;

            const btn = document.getElementById('save-insight-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const res = await fetch(API + '/api/memory/live-record/lessons', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ insight: text })
                });

                if (res.ok) {
                    input.value = '';
                    closeOverlay('insight');
                    showToast('Insight saved');

                    // Pulse the main card
                    document.getElementById('main-card').classList.add('success-pulse');
                    setTimeout(() => {
                        document.getElementById('main-card').classList.remove('success-pulse');
                    }, 500);
                } else {
                    showToast('Error saving');
                }
            } catch (e) {
                showToast('Error saving');
            }

            btn.disabled = false;
            btn.textContent = 'Save Insight';
        }

        // ===== UTILITIES =====
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 2500);
        }

        function refreshData() {
            loadData();
            showToast('Refreshing...');
        }

        // ===== AI LAUNCHERS =====
        async function launchEditor(editor) {
            const names = {
                'claude': 'Claude Code',
                'cursor': 'Cursor',
                'copilot': 'VS Code + Copilot'
            };
            const editorToLaunch = editor === 'copilot' ? 'vscode' : editor;

            showToast(`Launching ${names[editor]}...`);

            try {
                const res = await fetch(API + '/api/session/launch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ editor: editorToLaunch })
                });

                if (res.ok) {
                    showToast(`${names[editor]} launched!`);
                    loadData();
                } else {
                    const data = await res.json();
                    showToast(data.message || 'Error launching');
                }
            } catch (e) {
                showToast('Server connection error');
            }
        }

        // ===== CLOCK + SESSION TIMER =====
        function updateClock() {
            const now = new Date();

            // Session timer in header
            const timerEl = document.getElementById('session-timer');
            if (timerEl && sessionStartTime) {
                const mins = Math.floor((now - sessionStartTime) / 60000);
                if (mins < 60) {
                    timerEl.textContent = `${mins}m`;
                } else {
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    timerEl.textContent = `${h}h ${m > 0 ? m + 'm' : ''}`;
                }
            }

            // Update feed relative times without re-render
            updateFeedTimes();
        }

        // ===== INIT =====
        async function init() {
            await detectServer();
            await loadData();

            updateClock();
            setInterval(updateClock, 1000);
            setInterval(loadData, 10000);
        }

        init();
    </script>
</body>
</html>
