<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixOnce</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d0d1a;
            --bg-card: rgba(255, 255, 255, 0.07);
            --bg-glass: rgba(255, 255, 255, 0.06);
            --bg-glass-hover: rgba(255, 255, 255, 0.10);
            --bg-overlay: rgba(8, 8, 20, 0.92);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.55);
            --text-muted: rgba(255, 255, 255, 0.28);
            --accent-green: #6fcf97;
            --accent-red: #eb5757;
            --accent-yellow: #f2cc8f;
            --accent-blue: #7b9cff;
            --border: rgba(255, 255, 255, 0.12);
            --border-bright: rgba(255, 255, 255, 0.22);
            --glow: 0 8px 32px rgba(90, 100, 255, 0.12);
            --radius: 18px;
            --radius-sm: 12px;
            --blur: blur(18px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            /* Rich gradient background */
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 85, 255, 0.18) 0%, transparent 55%),
                radial-gradient(ellipse at 80% 80%, rgba(56, 182, 255, 0.12) 0%, transparent 55%),
                radial-gradient(ellipse at 60% 10%, rgba(180, 80, 255, 0.10) 0%, transparent 45%),
                #0d0d1a;
        }

        /* ===== MAIN CONTAINER ===== */
        .container {
            width: 100%;
            max-width: 400px;
            position: relative;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .project-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .project-selector:hover {
            background: rgba(255,255,255,0.07);
        }

        .dropdown-arrow {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .live-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: rgba(111, 207, 151, 0.9);
            padding: 4px 12px;
            background: rgba(111, 207, 151, 0.1);
            border: 1px solid rgba(111, 207, 151, 0.2);
            border-radius: 20px;
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            box-shadow: 0 0 6px var(--accent-green);
            animation: pulse 2s infinite;
        }

        /* Project Dropdown */
        .project-dropdown {
            position: absolute;
            top: 60px;
            left: 0;
            width: 280px;
            background: rgba(15, 15, 30, 0.85);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 16px 48px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .project-dropdown.active {
            display: block;
            animation: slideDown 0.15s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .project-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .project-dropdown-item:last-child {
            border-bottom: none;
        }

        .project-dropdown-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .project-dropdown-item.active {
            background: rgba(111, 207, 151, 0.08);
        }

        .project-dropdown-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .project-dropdown-path {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--border-bright);
            color: var(--text-primary);
        }

        /* ===== SESSION TIMER (in header) ===== */
        .session-timer {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 3px 9px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            letter-spacing: 0.3px;
        }

        /* ===== STATS ROW (bottom of main card) ===== */
        .stats-row {
            display: flex;
            gap: 0;
            padding-top: 14px;
            border-top: 1px solid var(--border);
            margin-top: 16px;
        }

        .stat-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 0;
        }

        .stat-item + .stat-item {
            border-left: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-value.ok   { color: var(--accent-green); }
        .stat-value.warn { color: var(--accent-red); }

        .stat-label {
            font-size: 0.68rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        /* ===== MAIN CARD ===== */
        .main-card {
            background: var(--bg-glass);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-top-color: var(--border-bright);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--glow), inset 0 1px 0 rgba(255,255,255,0.08);
            transition: all 0.3s ease;
        }

        .now-card {
            padding: 16px 18px;
            margin-bottom: 12px;
        }

        .now-primary {
            font-size: 0.98rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.35;
            margin-bottom: 6px;
        }

        .now-secondary {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.45;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Section labels */
        .section-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        /* Goal */
        .goal {
            font-size: 1.05rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.5;
            font-weight: 500;
        }

        /* Target */
        .target {
            padding: 12px 14px;
            background: rgba(123, 156, 255, 0.08);
            border: 1px solid rgba(123, 156, 255, 0.15);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .target-icon {
            flex-shrink: 0;
        }

        .target-text {
            color: var(--text-primary);
        }

        /* Session info */
        /* ===== ERROR CARD ===== */
        .error-card {
            background: rgba(235, 87, 87, 0.08);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid rgba(235, 87, 87, 0.25);
            border-top-color: rgba(235, 87, 87, 0.4);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 16px;
            display: none;
            box-shadow: 0 8px 32px rgba(235, 87, 87, 0.1);
        }

        .error-card.active {
            display: block;
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .error-icon {
            font-size: 1.3rem;
        }

        .error-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-red);
            font-weight: 600;
        }

        .error-message {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-sm);
            word-break: break-word;
        }

        .error-solution {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(129, 178, 154, 0.15);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            color: var(--accent-green);
            font-size: 0.9rem;
        }

        .error-actions {
            display: flex;
            gap: 12px;
        }

        .error-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .error-btn.primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .error-btn.primary:hover {
            filter: brightness(1.1);
        }

        .error-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .error-btn.secondary:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        /* ===== ACTIVITY FEED (inline chat-style) ===== */
        .feed {
            margin-bottom: 14px;
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feed-label {
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-muted);
        }

        .feed-all {
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 0;
        }

        .feed-all:hover {
            color: var(--text-secondary);
        }

        .feed-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 9px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            transition: opacity 0.2s;
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-item.new-entry {
            animation: feedFadeIn 0.4s ease forwards;
        }

        @keyframes feedFadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .feed-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .feed-dot.design  { background: rgba(180, 130, 255, 0.15); }
        .feed-dot.code    { background: rgba(123, 156, 255, 0.15); }
        .feed-dot.command { background: rgba(111, 207, 151, 0.15); }
        .feed-dot.git     { background: rgba(242, 204, 143, 0.15); }
        .feed-dot.default { background: rgba(255, 255, 255, 0.07); }

        .feed-body {
            flex: 1;
            min-width: 0;
        }

        .feed-text {
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 2px;
        }

        .feed-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .feed-item.fresh .feed-text {
            color: #fff;
        }

        .feed-item.fresh .feed-time {
            color: var(--accent-green);
        }

        /* ===== AI LAUNCHER BUTTONS ===== */
        .ai-launchers {
            display: none; /* moved out, kept for launchEditor() function */
        }

        .ai-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 14px 8px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-top-color: var(--border-bright);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-btn:hover {
            background: rgba(255,255,255,0.10);
            border-color: var(--border-bright);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }

        .ai-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            opacity: 0.85;
        }

        .ai-btn:hover .ai-icon {
            opacity: 1;
        }

        /* ===== ACTION BUTTONS ===== */
        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 13px 16px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-top-color: var(--border-bright);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.10);
            border-color: var(--border-bright);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .action-btn.primary-action {
            background: rgba(111, 207, 151, 0.15);
            color: var(--accent-green);
            border-color: rgba(111, 207, 151, 0.3);
        }

        .action-btn.primary-action:hover {
            background: rgba(111, 207, 151, 0.25);
            border-color: rgba(111, 207, 151, 0.5);
            color: var(--accent-green);
            box-shadow: 0 4px 20px rgba(111, 207, 151, 0.15);
        }

        /* More Menu */
        .more-menu-container {
            position: relative;
            flex: 1;
        }

        .more-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            width: 280px;
            margin-bottom: 8px;
            background: rgba(15, 15, 30, 0.88);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            padding: 10px;
            display: none;
            z-index: 100;
            box-shadow: 0 16px 40px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.08);
        }

        .more-menu.active {
            display: block;
            animation: slideUp 0.15s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .more-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            border: 1px solid transparent;
            border-radius: 10px;
            margin-bottom: 4px;
        }

        .more-menu-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .more-menu-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--border);
        }

        .menu-badge {
            margin-right: auto;
            background: rgba(123, 156, 255, 0.18);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #c8d6ff;
            border: 1px solid rgba(123, 156, 255, 0.32);
            display: none;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            line-height: 1.1;
        }

        .menu-badge.visible {
            display: inline-flex;
        }

        .menu-badge.tone-risk {
            background: rgba(235, 87, 87, 0.16);
            color: #ffb8b8;
            border-color: rgba(235, 87, 87, 0.35);
        }

        .menu-badge.tone-good {
            background: rgba(111, 207, 151, 0.16);
            color: #bff2cf;
            border-color: rgba(111, 207, 151, 0.35);
        }

        /* Badge on "More" button */
        .more-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #7b9cff;
            color: #1a1d24;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .more-menu-container {
            position: relative;
        }

        /* "New" badge for recent items */
        .new-badge {
            background: #7b9cff;
            color: #1a1d24;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
        }

        .history-item.new-item {
            border-right: 3px solid #7b9cff;
            background: rgba(123, 156, 255, 0.08);
        }

        .more-menu-headline {
            padding: 4px 8px 10px;
            font-size: 0.78rem;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 8px;
        }

        .more-menu-divider {
            border-top: 1px solid rgba(255,255,255,0.08);
            margin: 8px 2px;
        }

        .more-menu-section-label {
            font-size: 0.66rem;
            text-transform: uppercase;
            letter-spacing: 0.45px;
            color: var(--text-muted);
            padding: 2px 8px 6px;
        }

        .more-menu-icon {
            width: 18px;
            text-align: center;
            opacity: 0.9;
        }

        /* ===== SIDE PANEL (History/Search) ===== */
        .panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 999;
            display: none;
        }

        .panel-backdrop.active {
            display: block;
        }

        .overlay {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: rgba(12, 12, 24, 0.82);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-left: 1px solid var(--border);
            box-shadow: -16px 0 48px rgba(0,0,0,0.5), inset 1px 0 0 rgba(255,255,255,0.06);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            transition: right 0.25s ease;
        }

        .overlay.active {
            right: 0;
        }

        /* Full overlay for insight form */
        .overlay.full-overlay {
            right: auto;
            left: 0;
            width: 100%;
            border-left: none;
            background: rgba(10, 10, 22, 0.92);
            display: none;
            transition: none;
        }

        .overlay.full-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .overlay-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .overlay-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .overlay-close:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--border-bright);
            color: var(--text-primary);
        }

        .overlay-content {
            flex: 1;
        }

        /* History items */
        .history-item {
            padding: 16px;
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-type {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .history-item-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .history-item-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Story-style history */
        .story-item {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .story-item:last-child {
            border-bottom: none;
        }

        .story-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .story-icon.code { background: rgba(129, 178, 154, 0.15); }
        .story-icon.design { background: rgba(242, 204, 143, 0.15); }
        .story-icon.command { background: rgba(94, 129, 172, 0.15); }
        .story-icon.git { background: rgba(231, 111, 81, 0.15); }

        .story-body {
            flex: 1;
            min-width: 0;
        }

        .story-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .story-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .story-meta-dot {
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .story-day-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 8px 0 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
        }

        /* Search overlay */
        .search-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--accent-green);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-result {
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-result:hover {
            background: rgba(255,255,255,0.08);
        }

        .search-result-match {
            font-size: 0.8rem;
            color: var(--accent-green);
            margin-bottom: 6px;
        }

        .search-result-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        /* Add insight overlay */
        .insight-textarea {
            width: 100%;
            min-height: 150px;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            outline: none;
            margin-bottom: 16px;
        }

        .insight-textarea:focus {
            border-color: var(--accent-green);
        }

        .insight-textarea::placeholder {
            color: var(--text-muted);
        }

        .save-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-btn:hover {
            filter: brightness(1.1);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== MICRO FEEDBACK ===== */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        @keyframes success-pulse {
            0% { box-shadow: 0 0 0 0 rgba(129, 178, 154, 0.4); }
            100% { box-shadow: 0 0 0 20px rgba(129, 178, 154, 0); }
        }

        .success-pulse {
            animation: success-pulse 0.5s ease;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            z-index: 2000;
            animation: toastIn 0.3s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            body {
                padding: 20px 16px;
            }

            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="project-selector" onclick="toggleProjectDropdown()">
                    <span id="header-project-name">FixOnce</span>
                    <span class="dropdown-arrow">â–¼</span>
                </div>
                <div class="live-tag" id="live-tag">
                    <span class="live-dot"></span>
                    <span id="live-editor">Cursor</span>
                </div>
                <span class="session-timer" id="session-timer">â€”</span>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshData()" title="×¨×¢× ×Ÿ">â†»</button>
            </div>
        </div>

        <!-- Project Dropdown -->
        <div class="project-dropdown" id="project-dropdown"></div>

        <!-- Now Card (Immediate project state) -->
        <div class="main-card now-card" id="now-card">
            <div class="section-label">×¢×›×©×™×•</div>
            <div class="now-primary" id="now-primary">×˜×•×¢×Ÿ ××¦×‘ × ×•×›×—×™...</div>
            <div class="now-secondary" id="now-secondary">â€”</div>
        </div>

        <!-- Main Card (Focus Mode) -->
        <div class="main-card" id="main-card">
            <div class="section-label">××˜×¨×” × ×•×›×—×™×ª</div>
            <div class="goal" id="goal">×˜×•×¢×Ÿ...</div>

            <div class="target" id="target" style="display: none;">
                <div class="section-label">×¦×¢×“ ×”×‘×</div>
                <div style="display: flex; align-items: flex-start; gap: 8px;">
                    <span class="target-icon">â†’</span>
                    <span class="target-text" id="target-text"></span>
                </div>
            </div>

            <!-- Stats row -->
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-value ok" id="stat-health">âœ“</span>
                    <span class="stat-label">××¦×‘</span>
                </div>
                <div class="stat-item clickable" onclick="openOverlay('decisions')" title="×”×—×œ×˜×•×ª">
                    <span class="stat-value" id="stat-decisions">0</span>
                    <span class="stat-label">×”×—×œ×˜×•×ª</span>
                </div>
                <div class="stat-item clickable" onclick="openOverlay('debug-sessions')" title="×‘×¢×™×•×ª ×©× ×¤×ª×¨×•">
                    <span class="stat-value" id="stat-resolved">0</span>
                    <span class="stat-label">× ×¤×ª×¨×•</span>
                </div>
            </div>
        </div>

        <!-- Error Card (Alert Mode) -->
        <div class="error-card" id="error-card">
            <div class="error-header">
                <span class="error-icon">âš ï¸</span>
                <span class="error-title">×“×•×¨×© ×˜×™×¤×•×œ</span>
            </div>

            <div class="error-message" id="error-message">-</div>

            <div class="error-solution" id="error-solution" style="display: none;">
                <span>ğŸ’¡</span>
                <span id="error-solution-text">-</span>
            </div>

            <div class="error-actions">
                <button class="error-btn primary" onclick="sendErrorToAI()">ğŸ¤– ×©×œ×— ×œ×‘×™× ×”</button>
                <button class="error-btn secondary" onclick="handleError()">âœ“ ×˜×•×¤×œ</button>
                <button class="error-btn secondary" onclick="dismissError()">âœ•</button>
            </div>
        </div>

        <!-- Inline Activity Feed -->
        <div class="main-card feed" id="inline-feed">
            <div class="feed-header">
                <span class="feed-label">×¡×™×¤×•×¨ ×¢×‘×•×“×”</span>
                <button class="feed-all" onclick="openOverlay('history')">×›×œ ×”×”×™×¡×˜×•×¨×™×” â†’</button>
            </div>
            <div id="feed-items">
                <div class="feed-item">
                    <div class="feed-dot default">Â·</div>
                    <div class="feed-body">
                        <div class="feed-text" style="color: var(--text-muted)">×˜×•×¢×Ÿ...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
            <div class="more-menu-container">
                <button class="action-btn" onclick="toggleMoreMenu()">
                    <span>ğŸ“‹</span>
                    <span>×¢×•×“</span>
                    <span class="more-badge" id="more-badge" style="display: none;">0</span>
                    <span class="dropdown-arrow">â–¼</span>
                </button>
                <div class="more-menu" id="more-menu">
                    <div class="more-menu-headline" id="more-menu-headline">×‘×—×¨ ×¤×¢×•×œ×”</div>
                    <div class="more-menu-section-label">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</div>
                    <div class="more-menu-item" onclick="openOverlay('insight'); closeMoreMenu();">
                        <span class="more-menu-icon">â•</span>
                        <span>×ª×•×‘× ×”</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('search'); closeMoreMenu();">
                        <span class="more-menu-icon">ğŸ”</span>
                        <span>×—×¤×© ×‘×–×™×›×¨×•×Ÿ</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('history'); closeMoreMenu();">
                        <span class="more-menu-icon">ğŸ“œ</span>
                        <span>×”×™×¡×˜×•×¨×™×”</span>
                    </div>
                    <div class="more-menu-divider"></div>
                    <div class="more-menu-section-label">× ×™×”×•×œ ×™×“×¢</div>
                    <div class="more-menu-item" onclick="openOverlay('decisions'); closeMoreMenu();">
                        <span class="more-menu-icon">âš–ï¸</span>
                        <span>×”×—×œ×˜×•×ª ×¤×¢×™×œ×•×ª</span>
                        <span class="menu-badge" id="decisions-badge">0</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('avoid'); closeMoreMenu();">
                        <span class="more-menu-icon">ğŸš«</span>
                        <span>××” ×œ×”×™×× ×¢</span>
                        <span class="menu-badge" id="avoid-badge">0</span>
                    </div>
                    <div class="more-menu-item" onclick="openOverlay('debug-sessions'); closeMoreMenu();">
                        <span class="more-menu-icon">ğŸ›</span>
                        <span>×‘×¢×™×•×ª ×©× ×¤×ª×¨×•</span>
                        <span class="menu-badge" id="debug-sessions-badge">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel Backdrop -->
    <div class="panel-backdrop" id="panel-backdrop" onclick="closeAllPanels()"></div>

    <!-- History Panel (side) -->
    <div class="overlay" id="overlay-history">
        <div class="overlay-header">
            <div class="overlay-title" id="history-title">×”×™×¡×˜×•×¨×™×”</div>
            <button class="overlay-close" onclick="closeOverlay('history')">Ã—</button>
        </div>
        <div class="overlay-content" id="history-content">
            <div class="history-empty">×˜×•×¢×Ÿ...</div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div class="overlay" id="overlay-search">
        <div class="overlay-header">
            <div class="overlay-title">×—×™×¤×•×© ×¤×ª×¨×•× ×•×ª</div>
            <button class="overlay-close" onclick="closeOverlay('search')">Ã—</button>
        </div>
        <div class="overlay-content">
            <input type="text" class="search-input" id="search-input"
                   placeholder="×—×¤×© ×‘×ª×•×‘× ×•×ª ×•×”×—×œ×˜×•×ª..."
                   oninput="handleSearch(this.value)">
            <div class="search-results" id="search-results">
                <div class="history-empty">×”×§×œ×“ ×œ×—×™×¤×•×©...</div>
            </div>
        </div>
    </div>

    <!-- Add Insight Overlay (full screen) -->
    <div class="overlay full-overlay" id="overlay-insight">
        <div class="overlay-header">
            <div class="overlay-title">×©××•×¨ ×ª×•×‘× ×”</div>
            <button class="overlay-close" onclick="closeOverlay('insight')">Ã—</button>
        </div>
        <div class="overlay-content">
            <textarea class="insight-textarea" id="insight-input"
                      placeholder="××” ×œ××“×ª? ××” ×¢×‘×“? ××” ×œ× ×¢×‘×“?"></textarea>
            <button class="save-btn" id="save-insight-btn" onclick="saveInsight()">
                ×©××•×¨ ×ª×•×‘× ×”
            </button>
        </div>
    </div>

    <!-- Decisions Panel (side) -->
    <div class="overlay" id="overlay-decisions">
        <div class="overlay-header">
            <div class="overlay-title">×”×—×œ×˜×•×ª ×¤×¢×™×œ×•×ª</div>
            <button class="overlay-close" onclick="closeOverlay('decisions')">Ã—</button>
        </div>
        <div class="overlay-content" id="decisions-content">
            <div class="history-empty">×˜×•×¢×Ÿ...</div>
        </div>
    </div>

    <!-- Avoid Panel (side) -->
    <div class="overlay" id="overlay-avoid">
        <div class="overlay-header">
            <div class="overlay-title">××” ×œ×”×™×× ×¢</div>
            <button class="overlay-close" onclick="closeOverlay('avoid')">Ã—</button>
        </div>
        <div class="overlay-content" id="avoid-content">
            <div class="history-empty">×˜×•×¢×Ÿ...</div>
        </div>
    </div>

    <!-- Debug Sessions Panel -->
    <div class="overlay" id="overlay-debug-sessions">
        <div class="overlay-header">
            <div class="overlay-title">ğŸ› ×‘×¢×™×•×ª ×©× ×¤×ª×¨×•</div>
            <button class="overlay-close" onclick="closeOverlay('debug-sessions')">Ã—</button>
        </div>
        <div class="overlay-content" id="debug-sessions-content">
            <div class="history-empty">×˜×•×¢×Ÿ...</div>
        </div>
    </div>

    <script>
        // ===== CONFIG =====
        let API = 'http://localhost:5000';
        let currentError = null;
        let projectData = null;
        let historyFilter = 'all'; // 'all' | 'today'

        // Auto-detect server port
        async function detectServer() {
            for (const port of [5000, 5001, 5002]) {
                try {
                    const res = await fetch(`http://localhost:${port}/api/ping`, {
                        signal: AbortSignal.timeout(500)
                    });
                    if (res.ok) {
                        const data = await res.json();
                        if (data.service === 'fixonce') {
                            API = `http://localhost:${port}`;
                            return true;
                        }
                    }
                } catch {}
            }
            return false;
        }

        // ===== DATA LOADING =====
        let allProjects = [];
        let _lastErrors = [];
        let _lastActivities = [];

        async function loadData() {
            // Fetch each source independently â€” failure of one won't block others
            const [projectJson, errorsJson, activityJson] = await Promise.all([
                fetch(API + '/api/projects/grouped')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
                fetch(API + '/api/live-errors')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
                fetch(API + '/api/activity/feed?limit=50')
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null),
            ]);

            const connected = projectJson !== null || activityJson !== null;

            if (!connected) {
                document.getElementById('header-project-name').textContent = '×œ× ××—×•×‘×¨';
                document.getElementById('goal').textContent = '×‘×“×•×§ ×©×”×©×¨×ª ×¤×•×¢×œ';
                return;
            }

            // Update project data only if fetch succeeded
            if (projectJson) {
                projectData = projectJson.active;
                allProjects = [
                    ...(projectJson.active ? [projectJson.active] : []),
                    ...(projectJson.recent || []),
                    ...(projectJson.stale || [])
                ];
            }

            const errors = errorsJson?.errors || [];
            const activities = activityJson?.activities || [];
            _lastErrors = errors;
            _lastActivities = activities;

            // Update each UI section independently
            if (projectJson) {
                updateHeader(projectData);

                updateMainCard(projectData);
                updateBadges(projectData);
                buildProjectDropdown();
            }

            if (errorsJson) {
                updateErrors(errors);
            }

            if (activityJson) {
                updateSessionInfo(activities, projectData);
            }

            updateNowCard(projectData, _lastErrors, _lastActivities);

        }

        // session start time (set when project data loads)
        let sessionStartTime = null;

        function getActiveEditorNames(data) {
            const activeAis = data?.active_ais || {};
            const now = new Date();
            const ACTIVE_TIMEOUT_MS = 5 * 60 * 1000;

            return Object.entries(activeAis)
                .filter(([, ai]) => ai.last_activity && (now - new Date(ai.last_activity)) < ACTIVE_TIMEOUT_MS)
                .map(([name]) => name.charAt(0).toUpperCase() + name.slice(1));
        }

        function updateHeader(data) {
            // Project name in header
            document.getElementById('header-project-name').textContent = data?.name || '××™×Ÿ ×¤×¨×•×™×§×˜';

            // Editor tag â€” show all active AIs
            const activeNames = getActiveEditorNames(data);

            const editorEl = document.getElementById('live-editor');
            if (activeNames.length > 0) {
                editorEl.textContent = activeNames.join(' + ');
            } else {
                const editor = data?.ai_session?.editor || 'Claude';
                editorEl.textContent = editor.charAt(0).toUpperCase() + editor.slice(1);
            }
        }

        function updateNowCard(data, errors, activities) {
            const primaryEl = document.getElementById('now-primary');
            const secondaryEl = document.getElementById('now-secondary');
            if (!primaryEl || !secondaryEl) return;

            const activeNames = getActiveEditorNames(data);
            const sessionEditorRaw = data?.ai_session?.editor || '';
            const sessionEditor = sessionEditorRaw
                ? sessionEditorRaw.charAt(0).toUpperCase() + sessionEditorRaw.slice(1)
                : '';
            const sessionTsRaw = data?.ai_session?.last_activity || data?.ai_session?.started_at || null;
            const sessionTs = sessionTsRaw ? new Date(sessionTsRaw) : null;
            const now = Date.now();
            const sessionIsRecent = sessionTs ? (now - sessionTs.getTime()) < (20 * 60 * 1000) : false;
            const hasRecentActivity = (activities || []).some(a =>
                a?.timestamp && (now - new Date(a.timestamp).getTime()) < (10 * 60 * 1000)
            );
            const latestGroup = groupActivities(activities || []).slice(0, 1)[0];

            if ((errors || []).length > 0) {
                const msg = (errors[0]?.message || '×©×’×™××” ×¤×ª×•×—×”').replace(/\s+/g, ' ').trim();
                primaryEl.textContent = `ğŸ”´ ×™×© ${errors.length} ×©×’×™××” ×¤×ª×•×—×” ×©×“×•×¨×©×ª ×˜×™×¤×•×œ`;
                secondaryEl.textContent = `${msg.length > 90 ? msg.slice(0, 90) + '...' : msg}`;
                return;
            }

            if (activeNames.length > 0) {
                primaryEl.textContent = `ğŸŸ¢ ${activeNames.join(' + ')} ×¢×•×‘×“ ×¢×›×©×™×•`;
            } else if (sessionEditor && (sessionIsRecent || hasRecentActivity)) {
                // Fallback when active_ais heartbeat is stale but session/activity is clearly alive
                primaryEl.textContent = `ğŸŸ¢ ${sessionEditor} ×¤×¢×™×œ ×›×¨×’×¢`;
            } else if (sessionEditor) {
                primaryEl.textContent = `ğŸŸ£ ${sessionEditor} ××—×•×‘×¨`;
            } else {
                primaryEl.textContent = 'ğŸŸ¡ ××™×Ÿ ×¢×‘×•×“×” ×¤×¢×™×œ×” ×›×¨×’×¢';
            }

            if (latestGroup) {
                secondaryEl.textContent = `×”×ª×§×“××•×ª ××—×¨×•× ×”: ${storyNarrative(latestGroup)}`;
            } else if (sessionEditor) {
                secondaryEl.textContent = '××—×•×‘×¨ ×œ×¡×©×Ÿ, ×××ª×™×Ÿ ×œ×¤×¢×™×œ×•×ª ×—×“×©×”';
            } else {
                secondaryEl.textContent = '××™×Ÿ ×¤×¢×™×œ×•×ª ××—×¨×•× ×” ×œ×”×¦×’×”';
            }
        }

        async function updateBadges(data) {
            const decisionsCount = data?.decisions_count || 0;
            const avoidCount = data?.avoid_count || 0;
            setMenuBadge('decisions-badge', decisionsCount, 'info');
            setMenuBadge('avoid-badge', avoidCount, 'risk');

            // Decisions stat in main card
            const statDec = document.getElementById('stat-decisions');
            if (statDec) statDec.textContent = decisionsCount;

            // Fetch debug sessions count
            let debugCount = 0;
            try {
                const res = await fetch(API + '/api/memory/debug-sessions');
                const json = await res.json();
                debugCount = json.count || 0;
            } catch (e) {
                debugCount = 0;
            }
            setMenuBadge('debug-sessions-badge', debugCount, 'good');
            const statResolved = document.getElementById('stat-resolved');
            if (statResolved) statResolved.textContent = debugCount;
            updateMoreMenuHeadline(decisionsCount, avoidCount, debugCount);

            // Count new items (added today) for "More" button badge
            await updateMoreButtonBadge();
        }

        // Track last seen timestamp
        function getLastSeenTime() {
            const stored = localStorage.getItem('fixonce_last_seen');
            return stored ? new Date(stored) : new Date(0);
        }

        function markAsSeen() {
            localStorage.setItem('fixonce_last_seen', new Date().toISOString());
            updateMoreButtonBadge(); // Refresh badge
        }

        async function updateMoreButtonBadge() {
            const moreBadge = document.getElementById('more-badge');
            if (!moreBadge) return;

            const lastSeen = getLastSeenTime();
            let newCount = 0;

            // Check decisions
            try {
                const res = await fetch(API + '/api/memory/decisions');
                const data = await res.json();
                const decisions = data.decisions || [];
                newCount += decisions.filter(d =>
                    d.timestamp && new Date(d.timestamp) > lastSeen
                ).length;
            } catch (e) {}

            // Check debug sessions
            try {
                const res = await fetch(API + '/api/memory/debug-sessions');
                const data = await res.json();
                const sessions = data.debug_sessions || [];
                newCount += sessions.filter(s =>
                    (s.timestamp && new Date(s.timestamp) > lastSeen) ||
                    (s.resolved_at && new Date(s.resolved_at) > lastSeen)
                ).length;
            } catch (e) {}

            // Check avoid
            try {
                const res = await fetch(API + '/api/memory/avoid');
                const data = await res.json();
                const avoids = data.avoids || [];
                newCount += avoids.filter(a =>
                    a.timestamp && new Date(a.timestamp) > lastSeen
                ).length;
            } catch (e) {}

            // Show/hide badge
            if (newCount > 0) {
                moreBadge.textContent = String(newCount);
                moreBadge.style.display = 'flex';
            } else {
                moreBadge.style.display = 'none';
            }
        }

        function setMenuBadge(id, count, tone) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = String(count || 0);
            el.classList.remove('visible', 'tone-risk', 'tone-good');
            if (count > 0) {
                el.classList.add('visible');
                if (tone === 'risk') el.classList.add('tone-risk');
                if (tone === 'good') el.classList.add('tone-good');
            }
        }

        function updateMoreMenuHeadline(decisionsCount, avoidCount, debugCount) {
            const headline = document.getElementById('more-menu-headline');
            if (!headline) return;
            if (avoidCount > 0) {
                headline.textContent = `×™×© ${avoidCount} ×¤×¨×™×˜×™ "×œ×”×™×× ×¢" ×©×›×“××™ ×œ×‘×“×•×§`;
                return;
            }
            if (debugCount > 0) {
                headline.textContent = `×™×© ${debugCount} ×‘×¢×™×•×ª ×©× ×¤×ª×¨×• ×©××¤×©×¨ ×œ××—×–×¨`;
                return;
            }
            if (decisionsCount > 0) {
                headline.textContent = `×™×© ${decisionsCount} ×”×—×œ×˜×•×ª ×¤×¢×™×œ×•×ª ×œ×¤×¨×•×™×§×˜`;
                return;
            }
            headline.textContent = '×‘×—×¨ ×¤×¢×•×œ×”';
        }

        function buildProjectDropdown() {
            const dropdown = document.getElementById('project-dropdown');
            dropdown.innerHTML = allProjects.map(p => `
                <div class="project-dropdown-item ${p.id === projectData?.id ? 'active' : ''}"
                     onclick="switchProject('${p.id}')">
                    <div class="project-dropdown-name">${p.name || 'Unknown'}</div>
                    <div class="project-dropdown-path">${p.working_dir || ''}</div>
                </div>
            `).join('');
        }

        function updateMainCard(data) {
            if (!data) {
                document.getElementById('goal').textContent = '-';
                return;
            }

            const goal = data.current_goal || data.summary || '-';
            document.getElementById('goal').textContent = goal;

            // Next step â€” only show if different from goal
            const targetEl = document.getElementById('target');
            const targetText = document.getElementById('target-text');
            const nextStep = data.next_step;
            if (nextStep && nextStep !== goal) {
                targetText.textContent = nextStep;
                targetEl.style.display = 'flex';
            } else {
                targetEl.style.display = 'none';
            }

            // Session timer start â€” from ai_session.started_at
            if (data.ai_session?.started_at && !sessionStartTime) {
                sessionStartTime = new Date(data.ai_session.started_at);
            }
        }

        function updateErrors(errors) {
            const mainCard = document.getElementById('main-card');
            const errorCard = document.getElementById('error-card');
            const healthEl = document.getElementById('stat-health');

            if (errors.length > 0) {
                currentError = errors[0];
                document.getElementById('error-message').textContent =
                    currentError.message || 'Unknown error';

                const solutionEl = document.getElementById('error-solution');
                const solutionText = document.getElementById('error-solution-text');
                if (currentError.solution) {
                    solutionText.textContent = currentError.solution.text || '× ××¦× ×¤×ª×¨×•×Ÿ ×§×™×™×';
                    solutionEl.style.display = 'flex';
                } else {
                    findSolution(currentError.message);
                }

                mainCard.style.display = 'none';
                errorCard.classList.add('active');
                errorCard.classList.add('shake');
                setTimeout(() => errorCard.classList.remove('shake'), 300);

                if (healthEl) {
                    healthEl.textContent = errors.length;
                    healthEl.className = 'stat-value warn';
                }
            } else {
                mainCard.style.display = 'block';
                errorCard.classList.remove('active');
                if (healthEl) {
                    healthEl.textContent = 'âœ“';
                    healthEl.className = 'stat-value ok';
                }
            }
        }

        async function findSolution(errorMsg) {
            try {
                const keywords = errorMsg.split(/[\s:,]+/).filter(w => w.length > 3).slice(0, 4).join(' ');
                const res = await fetch(API + '/api/memory/search?q=' + encodeURIComponent(keywords));
                const data = await res.json();

                if (data.results && data.results.length > 0 && data.results[0].similarity > 40) {
                    const solutionEl = document.getElementById('error-solution');
                    const solutionText = document.getElementById('error-solution-text');
                    solutionText.textContent = data.results[0].text.substring(0, 100);
                    solutionEl.style.display = 'flex';
                }
            } catch {}
        }

        function updateSessionInfo(activities, data) {
            renderInlineFeed(activities);
        }

        let _feedFingerprint = null;

        function renderInlineFeed(activities) {
            const container = document.getElementById('feed-items');
            if (!container || !activities.length) return;

            const groups = groupActivities(activities).slice(0, 5);
            if (!groups.length) return;

            // Only re-render if the latest activity changed
            const fingerprint = groups[0].firstTs + '|' + groups.length;
            const isFirstRender = _feedFingerprint === null;
            if (fingerprint === _feedFingerprint) {
                // Data unchanged â€” just update time labels silently
                updateFeedTimes();
                return;
            }
            const prevFingerprint = _feedFingerprint;
            _feedFingerprint = fingerprint;

            const now = new Date();

            const html = groups.map((g, i) => {
                const icon = storyIcon(g);
                const text = feedNarrative(g);
                const ts = new Date(g.firstTs);
                const diffMins = Math.round((now - ts) / 60000);

                let timeLabel;
                if (diffMins < 1)       timeLabel = '×¢×›×©×™×•';
                else if (diffMins < 60) timeLabel = `×œ×¤× ×™ ${diffMins} ×“×§×³`;
                else                    timeLabel = `×œ×¤× ×™ ${Math.floor(diffMins/60)} ×©×¢×³`;

                const isFresh = diffMins < 3;
                // Animate only the top item when it's genuinely new (not first render)
                const isNew = i === 0 && !isFirstRender && prevFingerprint !== null;

                return `
                    <div class="feed-item ${isFresh ? 'fresh' : ''} ${isNew ? 'new-entry' : ''}" data-ts="${g.firstTs}">
                        <div class="feed-dot ${icon.cls || 'default'}">${icon.emoji}</div>
                        <div class="feed-body">
                            <div class="feed-text">${text}</div>
                            <div class="feed-time feed-time-rel">${timeLabel}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="feed-item"><div class="feed-dot default">Â·</div><div class="feed-body"><div class="feed-text" style="color:var(--text-muted)">××™×Ÿ ×¤×¢×•×œ×•×ª ×¢×“×™×™×Ÿ</div></div></div>';
        }

        function updateFeedTimes() {
            const now = new Date();
            document.querySelectorAll('.feed-item[data-ts]').forEach(el => {
                const ts = parseInt(el.dataset.ts);
                const diffMins = Math.round((now - ts) / 60000);
                let label;
                if (diffMins < 1)       label = '×¢×›×©×™×•';
                else if (diffMins < 60) label = `×œ×¤× ×™ ${diffMins} ×“×§×³`;
                else                    label = `×œ×¤× ×™ ${Math.floor(diffMins/60)} ×©×¢×³`;
                const timeEl = el.querySelector('.feed-time-rel');
                if (timeEl) timeEl.textContent = label;
            });
        }

        // Human-readable work story (progress-oriented, not technical counters)
        function feedNarrative(group) {
            const name = group.humanName;
            const ctx = group.fileContext;

            // Commands
            if (group.tool === null && group.command) {
                if (group.command.startsWith('git commit')) return '× ×©××¨×” ×’×¨×¡×ª ×¢×‘×•×“×” ×—×“×©×”';
                if (group.command.startsWith('git')) return '×‘×•×¦×¢×” ×¤×¢×•×œ×ª × ×™×”×•×œ ×’×¨×¡×”';
                return '×”×•×¨×¦×” ×¤×§×•×“×” ×œ×ª×—×–×•×§×ª ×¡×‘×™×‘×ª ×”×¢×‘×•×“×”';
            }

            if (group.tool === 'Write') {
                if (ctx === '×ª×¦×•×’×”') return `× ×‘× ×” ××¡×š ×—×“×©: ${name}`;
                if (ctx === '×§×•×“') return `× ×•×¡×£ ×¨×›×™×‘ ×—×“×©: ${name}`;
                return `× ×•×¦×¨ ×§×•×‘×¥ ×—×“×©: ${name}`;
            }

            if (ctx === '×§×•×“') {
                return group.items.length > 1
                    ? `×‘×•×¦×¢ ×¨×¦×£ ×©×™×¤×•×¨×™× ×‘-${name}`
                    : `×¢×•×“×›×Ÿ ${name}`;
            }

            if (ctx === '×ª×¦×•×’×”') {
                return group.items.length > 1
                    ? `×©×•×¤×¨×” ×—×•×•×™×™×ª ×”××©×ª××© ×‘-${name}`
                    : `×¢×•×“×›×Ÿ ×”×××©×§: ${name}`;
            }

            return `×‘×•×¦×¢×” ×”×ª×§×“××•×ª ×‘-${name}`;
        }

        function storyNarrative(group) {
            return feedNarrative(group);
        }

        // ===== ERROR HANDLING =====
        async function sendErrorToAI() {
            if (!currentError) {
                showToast('××™×Ÿ ×©×’×™××” ×œ×©×œ×•×—');
                return;
            }

            // Show AI picker modal
            showAIPicker();
        }

        function showAIPicker() {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'ai-picker-modal';
            modal.innerHTML = `
                <div class="ai-picker-overlay" onclick="closeAIPicker()"></div>
                <div class="ai-picker-content">
                    <div class="ai-picker-title">×©×œ×— ×©×’×™××” ×œ×‘×™× ×”</div>
                    <div class="ai-picker-buttons">
                        <button class="ai-picker-btn" onclick="sendToAI('claude')">
                            <span class="ai-picker-icon">ğŸ¤–</span>
                            <span>Claude Code</span>
                        </button>
                        <button class="ai-picker-btn" onclick="sendToAI('cursor')">
                            <span class="ai-picker-icon">âš¡</span>
                            <span>Cursor</span>
                        </button>
                        <button class="ai-picker-btn secondary" onclick="copyErrorPrompt()">
                            <span class="ai-picker-icon">ğŸ“‹</span>
                            <span>×”×¢×ª×§ ×‘×œ×‘×“</span>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add styles if not exists
            if (!document.getElementById('ai-picker-styles')) {
                const styles = document.createElement('style');
                styles.id = 'ai-picker-styles';
                styles.textContent = `
                    #ai-picker-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        z-index: 1000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .ai-picker-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.7);
                    }
                    .ai-picker-content {
                        position: relative;
                        background: var(--bg-primary);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        padding: 24px;
                        min-width: 280px;
                    }
                    .ai-picker-title {
                        text-align: center;
                        font-weight: 600;
                        margin-bottom: 20px;
                        font-size: 1.1rem;
                    }
                    .ai-picker-buttons {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }
                    .ai-picker-btn {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 14px 18px;
                        background: var(--bg-card);
                        border: 1px solid var(--border);
                        border-radius: var(--radius-sm);
                        color: var(--text-primary);
                        font-size: 1rem;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .ai-picker-btn:hover {
                        background: rgba(129, 178, 154, 0.2);
                        border-color: var(--accent-green);
                    }
                    .ai-picker-btn.secondary {
                        background: transparent;
                        border-color: var(--text-muted);
                    }
                    .ai-picker-btn.secondary:hover {
                        background: var(--bg-card);
                    }
                    .ai-picker-icon {
                        font-size: 1.3rem;
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function closeAIPicker() {
            const modal = document.getElementById('ai-picker-modal');
            if (modal) modal.remove();
        }

        async function sendToAI(aiType) {
            closeAIPicker();

            if (!currentError) return;

            // Build error context
            const errorMsg = currentError.message || 'Unknown error';
            const source = currentError.source || '';
            const line = currentError.line || '';

            // Queue error for AI via FixOnce API
            try {
                await fetch(API + '/api/memory/queue-for-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'error',
                        message: errorMsg,
                        source: source,
                        line: line,
                        priority: 'high'
                    })
                });
            } catch (e) {
                console.log('Queue API not available, using direct launch');
            }

            // Launch AI
            if (aiType === 'claude') {
                // Open terminal with claude command
                showToast('ğŸš€ ×¤×•×ª×— Claude Code...');
                window.open('fixonce://launch/claude?error=' + encodeURIComponent(errorMsg), '_blank');
                // Fallback: copy to clipboard
                await copyErrorPrompt(true);
            } else if (aiType === 'cursor') {
                // Open Cursor with file - need full path
                showToast('ğŸš€ ×¤×•×ª×— Cursor...');
                const rootPath = projectData?.root_path || projectData?.working_dir || '/Users/haimdayan/Desktop/FixOnce';
                if (source) {
                    const fullPath = source.startsWith('/') ? source : rootPath + '/' + source;
                    window.location.href = 'cursor://file' + fullPath + (line ? ':' + line : '');
                } else {
                    // Just open project folder
                    window.location.href = 'cursor://file' + rootPath;
                }
                await copyErrorPrompt(true);
            }

            // Mark as being handled
            handleError();
        }

        async function copyErrorPrompt(silent = false) {
            if (!silent) closeAIPicker();

            if (!currentError) return;

            const errorMsg = currentError.message || 'Unknown error';
            const source = currentError.source || '';
            const line = currentError.line || '';

            // Search for existing solutions
            let solutionText = '';
            try {
                const res = await fetch(API + '/api/memory/search?q=' + encodeURIComponent(errorMsg.substring(0, 50)));
                const data = await res.json();
                if (data.results && data.results.length > 0) {
                    solutionText = data.results[0].text || data.results[0].decision || '';
                }
            } catch (e) {}

            // Build prompt
            let prompt = `ğŸ”§ **×©×’×™××” ×œ×˜×™×¤×•×œ:**\n\`${errorMsg}\`\n\n`;
            if (source) {
                prompt += `ğŸ“ **××™×§×•×:** ${source}`;
                if (line) prompt += `:${line}`;
                prompt += `\n\n`;
            }
            if (solutionText) {
                prompt += `ğŸ’¡ **×¤×ª×¨×•×Ÿ ×§×™×™×:**\n"${solutionText}"\n\n`;
            }
            prompt += `×ª×§×Ÿ ××ª ×”×©×’×™××”.`;

            // Copy
            try {
                await navigator.clipboard.writeText(prompt);
                if (!silent) showToast('ğŸ“‹ ×”×•×¢×ª×§!');
            } catch (e) {
                const ta = document.createElement('textarea');
                ta.value = prompt;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                if (!silent) showToast('ğŸ“‹ ×”×•×¢×ª×§!');
            }
        }

        function handleError() {
            // Mark as handled and refresh
            currentError = null;
            showToast('×¡×•××Ÿ ×›×˜×•×¤×œ âœ“');
            loadData();
        }

        function dismissError() {
            // Just hide for now
            document.getElementById('main-card').style.display = 'block';
            document.getElementById('error-card').classList.remove('active');
            currentError = null;
        }

        // ===== PANELS & OVERLAYS =====
        function openOverlay(type, opts = {}) {
            const overlay = document.getElementById('overlay-' + type);
            if (!overlay) return;
            overlay.classList.add('active');

            // Show backdrop for side panels
            if (['history', 'search', 'decisions', 'avoid', 'debug-sessions'].includes(type)) {
                document.getElementById('panel-backdrop').classList.add('active');
            }

            if (type === 'history') {
                historyFilter = opts.filter || 'all';
                const titleEl = document.getElementById('history-title');
                if (titleEl) {
                    titleEl.textContent = historyFilter === 'today' ? '×”×™×¡×˜×•×¨×™×” (×”×™×•×)' : '×”×™×¡×˜×•×¨×™×”';
                }
                loadHistory();
            }
            if (type === 'search') document.getElementById('search-input').focus();
            if (type === 'insight') document.getElementById('insight-input').focus();
            if (type === 'decisions') { loadDecisions(); markAsSeen(); }
            if (type === 'avoid') { loadAvoid(); markAsSeen(); }
            if (type === 'debug-sessions') { loadDebugSessions(); markAsSeen(); }
        }

        function closeOverlay(type) {
            const overlay = document.getElementById('overlay-' + type);
            if (overlay) overlay.classList.remove('active');

            // Hide backdrop if no side panels open
            const sidePanels = ['history', 'search', 'decisions', 'avoid', 'debug-sessions'];
            if (sidePanels.includes(type)) {
                const anyOpen = sidePanels.some(p =>
                    document.getElementById('overlay-' + p)?.classList.contains('active')
                );
                if (!anyOpen) {
                    document.getElementById('panel-backdrop').classList.remove('active');
                }
            }
        }

        function closeAllPanels() {
            document.querySelectorAll('.overlay.active').forEach(o => {
                o.classList.remove('active');
            });
            document.getElementById('panel-backdrop').classList.remove('active');
            document.getElementById('project-dropdown').classList.remove('active');
            document.getElementById('more-menu').classList.remove('active');
        }

        // ===== PROJECT DROPDOWN =====
        function toggleProjectDropdown() {
            const dropdown = document.getElementById('project-dropdown');
            dropdown.classList.toggle('active');
            // Close more menu if open
            document.getElementById('more-menu').classList.remove('active');
        }

        async function switchProject(projectId) {
            document.getElementById('project-dropdown').classList.remove('active');
            try {
                const res = await fetch(API + '/api/projects/switch/' + projectId, {
                    method: 'POST'
                });
                if (res.ok) {
                    showToast('×¢×‘×¨×ª×™ ×œ×¤×¨×•×™×§×˜');
                    loadData();
                } else {
                    showToast('×©×’×™××” ×‘××¢×‘×¨');
                }
            } catch (e) {
                showToast('×©×’×™××” ×‘××¢×‘×¨ ×¤×¨×•×™×§×˜');
            }
        }

        // ===== MORE MENU =====
        function toggleMoreMenu() {
            const menu = document.getElementById('more-menu');
            menu.classList.toggle('active');
            // Close project dropdown if open
            document.getElementById('project-dropdown').classList.remove('active');
        }

        function closeMoreMenu() {
            document.getElementById('more-menu').classList.remove('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.project-selector') && !e.target.closest('.project-dropdown')) {
                document.getElementById('project-dropdown').classList.remove('active');
            }
            if (!e.target.closest('.more-menu-container')) {
                document.getElementById('more-menu').classList.remove('active');
            }
        });

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAllPanels();
            }
        });

        // ===== HISTORY (Story Mode) =====
        function groupActivities(activities) {
            if (!activities.length) return [];

            const groups = [];
            let current = null;

            for (const a of activities) {
                const key = a.human_name || a.file?.split('/').pop() || a.command || 'unknown';
                const ts = new Date(a.timestamp).getTime();

                if (current && current.key === key && (current.lastTs - ts) < 5 * 60 * 1000) {
                    current.items.push(a);
                    current.lastTs = ts;
                } else {
                    if (current) groups.push(current);
                    current = {
                        key,
                        items: [a],
                        firstTs: ts,
                        lastTs: ts,
                        humanName: a.human_name || '',
                        fileContext: a.file_context || '',
                        tool: a.tool,
                        command: a.command
                    };
                }
            }
            if (current) groups.push(current);
            return groups;
        }

        function narrativeText(group) {
            const count = group.items.length;
            const name = group.humanName;
            const ctx = group.fileContext;
            const durationMs = group.firstTs - group.lastTs;
            const durationMins = Math.round(durationMs / 60000);
            const durationStr = durationMins > 1 ? ` ×‘××©×š ${durationMins} ×“×§×³` : '';

            // Calculate total lines added/removed
            let totalAdded = 0, totalRemoved = 0;
            group.items.forEach(a => {
                if (a.diff) {
                    totalAdded += a.diff.added || 0;
                    totalRemoved += a.diff.removed || 0;
                }
            });

            // Commands
            if (group.tool === null && group.command) {
                const cmd = group.command.length > 40 
                    ? group.command.substring(0, 40) + '...' 
                    : group.command;
                if (group.command.startsWith('git')) {
                    return `× ×™×”×œ×ª ×’×™×˜: ${cmd}`;
                }
                return `×”×¨×¦×ª: ${cmd}`;
            }

            // Code files
            if (ctx === '×§×•×“') {
                if (totalAdded > 50) {
                    return count === 1
                        ? `×”×¨×—×‘×ª ××ª ${name} â€” ${totalAdded} ×©×•×¨×•×ª ×—×“×©×•×ª`
                        : `×¢×‘×“×ª ×¢×œ ${name} â€” ${count} ×©×™× ×•×™×™×, +${totalAdded} ×©×•×¨×•×ª${durationStr}`;
                }
                return count === 1
                    ? `×¢×¨×›×ª ××ª ${name}`
                    : `×¢×‘×“×ª ×¢×œ ${name} â€” ${count} ×©×™× ×•×™×™×${durationStr}`;
            }

            // View/design files
            if (ctx === '×ª×¦×•×’×”') {
                if (count === 1) return `×¢×“×›× ×ª ××ª ×”${name}`;
                if (count <= 3) return `×©×™×¤×¨×ª ××ª ×”${name} â€” ${count} ×¢×“×›×•× ×™×${durationStr}`;
                return `×¢×™×¦×‘×ª ××ª ×”${name} â€” ${count} ×¢×“×›×•× ×™×${durationStr}`;
            }

            // Write (new file)
            if (group.tool === 'Write') {
                return `×™×¦×¨×ª ××ª ${name}`;
            }

            // Fallback
            if (count === 1) return `${getActivityType(group.items[0])} ${name}`;
            return `${name} â€” ${count} ×¤×¢×•×œ×•×ª${durationStr}`;
        }

        function storyIcon(group) {
            const ctx = group.fileContext;
            if (group.command?.startsWith('git')) return { emoji: 'ğŸ”€', cls: 'git' };
            if (group.tool === null && group.command) return { emoji: 'âš¡', cls: 'command' };
            if (ctx === '×§×•×“') return { emoji: 'ğŸ› ', cls: 'code' };
            if (ctx === '×ª×¦×•×’×”') return { emoji: 'ğŸ¨', cls: 'design' };
            if (group.tool === 'Write') return { emoji: 'âœ¨', cls: 'code' };
            return { emoji: 'ğŸ“', cls: '' };
        }

        function dayLabel(ts) {
            const d = new Date(ts);
            const now = new Date();
            const today = now.toDateString();
            const yesterday = new Date(now - 86400000).toDateString();

            if (d.toDateString() === today) return '×”×™×•×';
            if (d.toDateString() === yesterday) return '××ª××•×œ';
            return d.toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'short' });
        }

        async function loadHistory() {
            const container = document.getElementById('history-content');

            try {
                const res = await fetch(API + '/api/activity/feed?limit=50');
                const data = await res.json();
                const activities = data.activities || [];

                const localDateKey = (d) => d.toLocaleDateString('sv-SE'); // YYYY-MM-DD (local)
                const todayKey = localDateKey(new Date());
                const filteredActivities = historyFilter === 'today'
                    ? activities.filter(a => localDateKey(new Date(a.timestamp)) === todayKey)
                    : activities;

                if (filteredActivities.length === 0) {
                    container.innerHTML = historyFilter === 'today'
                        ? '<div class="history-empty">××™×Ÿ ×¤×¢×•×œ×•×ª ×”×™×•×</div>'
                        : '<div class="history-empty">××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ</div>';
                    return;
                }

                const groups = groupActivities(filteredActivities);
                let html = '';
                let lastDay = '';

                // Keep title simple and non-technical
                const titleEl = document.getElementById('history-title');
                if (titleEl) {
                    if (historyFilter === 'today') {
                        titleEl.textContent = '×”×™×¡×˜×•×¨×™×” (×”×™×•×)';
                    } else {
                        titleEl.textContent = '×”×™×¡×˜×•×¨×™×”';
                    }
                }

                for (const g of groups) {
                    const day = dayLabel(g.firstTs);
                    if (day !== lastDay) {
                        html += `<div class="story-day-label">${day}</div>`;
                        lastDay = day;
                    }

                    const icon = storyIcon(g);
                    const text = storyNarrative(g);
                    const rel = formatTime(new Date(g.firstTs).toISOString());
                    const timeLabel = rel === '×¢×›×©×™×•'
                        ? '×¢×›×©×™×•'
                        : (rel.endsWith('×“×§×•×ª') || rel.endsWith('×©×¢×•×ª') ? `×œ×¤× ×™ ${rel}` : rel);

                    html += `
                        <div class="story-item">
                            <div class="story-icon ${icon.cls}">${icon.emoji}</div>
                            <div class="story-body">
                                <div class="story-text">${text}</div>
                                <div class="story-meta">
                                    <span>${timeLabel}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = '<div class="history-empty">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
            }
        }

        // ===== DECISIONS =====
        async function loadDecisions() {
            const container = document.getElementById('decisions-content');
            try {
                const res = await fetch(API + '/api/memory/decisions');
                const data = await res.json();
                const decisions = data.decisions || [];

                if (decisions.length === 0) {
                    container.innerHTML = '<div class="history-empty">××™×Ÿ ×”×—×œ×˜×•×ª ×¤×¢×™×œ×•×ª</div>';
                    return;
                }

                // Reverse to show newest first
                const reversed = [...decisions].reverse();

                // Check if decision is new (after last seen)
                const lastSeen = getLastSeenTime();
                const isNew = (timestamp) => {
                    if (!timestamp) return false;
                    return new Date(timestamp) > lastSeen;
                };

                container.innerHTML = reversed.map(d => `
                    <div class="history-item${isNew(d.timestamp) ? ' new-item' : ''}">
                        <div class="history-item-header">
                            <span class="history-item-type">×”×—×œ×˜×”${isNew(d.timestamp) ? ' <span class="new-badge">×—×“×©</span>' : ''}</span>
                            <span class="history-item-time">${formatTime(d.timestamp)}</span>
                        </div>
                        <div class="history-item-text"><strong>${d.decision}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                            ${d.reason}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="history-empty">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
            }
        }

        // ===== AVOID =====
        async function loadAvoid() {
            const container = document.getElementById('avoid-content');
            try {
                const res = await fetch(API + '/api/memory/avoid');
                const data = await res.json();
                const avoids = data.avoids || [];

                if (avoids.length === 0) {
                    container.innerHTML = '<div class="history-empty">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×™×× ×¢×•×ª</div>';
                    return;
                }

                // Reverse to show newest first
                const reversed = [...avoids].reverse();
                const lastSeen = getLastSeenTime();
                const isNew = (timestamp) => timestamp && new Date(timestamp) > lastSeen;

                container.innerHTML = reversed.map(a => `
                    <div class="history-item${isNew(a.timestamp) ? ' new-item' : ''}" style="border-right: 3px solid var(--accent-red);">
                        <div class="history-item-header">
                            <span class="history-item-type">ğŸš« ×œ×”×™×× ×¢${isNew(a.timestamp) ? ' <span class="new-badge">×—×“×©</span>' : ''}</span>
                            <span class="history-item-time">${formatTime(a.timestamp)}</span>
                        </div>
                        <div class="history-item-text"><strong>${a.what}</strong></div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">
                            ${a.reason}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="history-empty">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
            }
        }

        // ===== DEBUG SESSIONS =====
        async function loadDebugSessions() {
            const container = document.getElementById('debug-sessions-content');
            try {
                const res = await fetch(API + '/api/memory/debug-sessions');
                const data = await res.json();
                const sessions = data.debug_sessions || [];

                // Update badge
                const badge = document.getElementById('debug-sessions-badge');
                if (badge) badge.textContent = sessions.length;

                if (sessions.length === 0) {
                    container.innerHTML = '<div class="history-empty">××™×Ÿ ×‘×¢×™×•×ª ×©× ×¤×ª×¨×• ×¢×“×™×™×Ÿ</div>';
                    return;
                }

                // Sort by resolved_at (most recent first)
                sessions.sort((a, b) => new Date(b.resolved_at) - new Date(a.resolved_at));

                const lastSeen = getLastSeenTime();
                const isNew = (timestamp) => timestamp && new Date(timestamp) > lastSeen;

                container.innerHTML = sessions.map(s => `
                    <div class="history-item debug-session-item${isNew(s.resolved_at || s.timestamp) ? ' new-item' : ''}" style="border-right: 3px solid var(--accent-green);">
                        <div class="history-item-header">
                            <span class="history-item-type">ğŸ› ×‘×¢×™×”${isNew(s.resolved_at || s.timestamp) ? ' <span class="new-badge">×—×“×©</span>' : ''}</span>
                            <span class="history-item-time">${formatTime(s.resolved_at)}</span>
                        </div>
                        <div class="history-item-text"><strong>${s.problem}</strong></div>

                        <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                                <span style="color: var(--accent-yellow);">ğŸ¯ ×©×•×¨×©:</span> ${s.root_cause}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--accent-green);">
                                <span>âœ… ×¤×ª×¨×•×Ÿ:</span> ${s.solution}
                            </div>
                            ${s.files_changed && s.files_changed.length > 0 ? `
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                                    ğŸ“ ${s.files_changed.join(', ')}
                                </div>
                            ` : ''}
                            ${s.symptoms && s.symptoms.length > 0 ? `
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                                    ğŸ” ×¡×™××¤×˜×•××™×: ${s.symptoms.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<div class="history-empty">×©×’×™××” ×‘×˜×¢×™× ×”</div>';
            }
        }

        function getActivityType(a) {
            if (a.tool === 'Edit') return '×¢×¨×™×›×”';
            if (a.tool === 'Write') return '×™×¦×™×¨×”';
            if (a.tool === 'Bash') return '×¤×§×•×“×”';
            if (a.tool === 'Read') return '×§×¨×™××”';
            if (a._isInsight) return '×ª×•×‘× ×”';
            if (a._isDecision) return '×”×—×œ×˜×”';
            if (a._isError) return '×©×’×™××”';
            return a.tool || '×¤×¢×•×œ×”';
        }

        function getActivityText(a) {
            if (a._isInsight || a._isDecision) return a.message || '-';
            if (a.human_name) return a.human_name;
            if (a.file) return a.file.split('/').pop();
            if (a.command) return a.command.substring(0, 50);
            return a.description || '-';
        }

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            const now = new Date();
            const diffMs = now - d;
            const diffMins = Math.round(diffMs / 60000);

            if (diffMins < 1) return '×¢×›×©×™×•';
            if (diffMins < 60) return diffMins + ' ×“×§×•×ª';

            const diffHours = Math.round(diffMins / 60);
            if (diffHours < 24) return diffHours + ' ×©×¢×•×ª';

            return d.toLocaleDateString('he-IL');
        }

        // ===== SEARCH =====
        let searchTimeout;

        async function handleSearch(query) {
            clearTimeout(searchTimeout);

            const container = document.getElementById('search-results');

            if (!query || query.length < 2) {
                container.innerHTML = '<div class="history-empty">×”×§×œ×“ ×œ×—×™×¤×•×©...</div>';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(API + '/api/memory/search?q=' + encodeURIComponent(query));
                    const data = await res.json();

                    if (!data.results || data.results.length === 0) {
                        container.innerHTML = '<div class="history-empty">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
                        return;
                    }

                    container.innerHTML = data.results.map(r => `
                        <div class="search-result" onclick="useResult('${escapeHtml(r.text)}')">
                            <div class="search-result-match">${r.similarity}% ×”×ª×××”</div>
                            <div class="search-result-text">${escapeHtml(r.text)}</div>
                        </div>
                    `).join('');

                } catch (e) {
                    container.innerHTML = '<div class="history-empty">×©×’×™××” ×‘×—×™×¤×•×©</div>';
                }
            }, 300);
        }

        function useResult(text) {
            // Copy to clipboard
            navigator.clipboard.writeText(text);
            showToast('×”×•×¢×ª×§ ×œ×œ×•×—');
            closeOverlay('search');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== SAVE INSIGHT =====
        async function saveInsight() {
            const input = document.getElementById('insight-input');
            const text = input.value.trim();

            if (!text) return;

            const btn = document.getElementById('save-insight-btn');
            btn.disabled = true;
            btn.textContent = '×©×•××¨...';

            try {
                const res = await fetch(API + '/api/memory/live-record/lessons', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ insight: text })
                });

                if (res.ok) {
                    input.value = '';
                    closeOverlay('insight');
                    showToast('×ª×•×‘× ×” × ×©××¨×”');

                    // Pulse the main card
                    document.getElementById('main-card').classList.add('success-pulse');
                    setTimeout(() => {
                        document.getElementById('main-card').classList.remove('success-pulse');
                    }, 500);
                } else {
                    showToast('×©×’×™××” ×‘×©××™×¨×”');
                }
            } catch (e) {
                showToast('×©×’×™××” ×‘×©××™×¨×”');
            }

            btn.disabled = false;
            btn.textContent = '×©××•×¨ ×ª×•×‘× ×”';
        }

        // ===== UTILITIES =====
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 2500);
        }

        function refreshData() {
            loadData();
            showToast('××¨×¢× ×Ÿ...');
        }

        // ===== AI LAUNCHERS =====
        async function launchEditor(editor) {
            const names = {
                'claude': 'Claude Code',
                'cursor': 'Cursor',
                'copilot': 'VS Code + Copilot'
            };
            const editorToLaunch = editor === 'copilot' ? 'vscode' : editor;

            showToast(`××¤×¢×™×œ ${names[editor]}...`);

            try {
                const res = await fetch(API + '/api/session/launch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ editor: editorToLaunch })
                });

                if (res.ok) {
                    showToast(`${names[editor]} × ×¤×ª×—!`);
                    loadData();
                } else {
                    const data = await res.json();
                    showToast(data.message || '×©×’×™××” ×‘×”×¤×¢×œ×”');
                }
            } catch (e) {
                showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª');
            }
        }

        // ===== CLOCK + SESSION TIMER =====
        function updateClock() {
            const now = new Date();

            // Session timer in header
            const timerEl = document.getElementById('session-timer');
            if (timerEl && sessionStartTime) {
                const mins = Math.floor((now - sessionStartTime) / 60000);
                if (mins < 60) {
                    timerEl.textContent = `${mins} ×“×§'`;
                } else {
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    timerEl.textContent = `${h}×©' ${m > 0 ? m + '×“' : ''}`;
                }
            }

            // Update feed relative times without re-render
            updateFeedTimes();
        }

        // ===== INIT =====
        async function init() {
            await detectServer();
            await loadData();

            updateClock();
            setInterval(updateClock, 1000);
            setInterval(loadData, 10000);
        }

        init();
    </script>
</body>
</html>
