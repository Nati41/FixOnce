<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixOnce</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0b;
            --card-bg: #141417;
            --card-border: #1e1e24;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --text-muted: #5a5a6e;
            --accent: #3b82f6;
            --accent-green: #22c55e;
            --accent-orange: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.4;
            font-size: 14px;
        }

        /* ========== HEADER ========== */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--card-border);
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon-svg {
            width: 24px;
            height: 24px;
        }

        .logo-text {
            font-size: 15px;
            font-weight: 600;
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========== MAIN ========== */
        main {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ========== SECTIONS ========== */
        .section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 14px;
        }

        /* Project Identity */
        .project-section {
            text-align: center;
            padding: 20px 14px;
        }

        .project-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .project-goal {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        .goal-focus {
            color: var(--text-primary);
            font-weight: 500;
        }

        .updated-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 10px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .updated-badge.recent {
            color: var(--accent);
        }

        /* Stats Row */
        .stats-section {
            display: flex;
            justify-content: space-around;
            padding: 12px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Decision */
        .decision-section {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .decision-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .decision-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Active AI */
        .ai-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        .ai-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .ai-time {
            color: var(--text-muted);
            font-size: 12px;
            margin-left: auto;
        }

        /* What Changed */
        .changes-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .change-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .change-icon {
            font-size: 14px;
        }

        /* Deep Dive Button */
        .deep-dive-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.1));
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--accent);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .deep-dive-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.2));
            border-color: var(--accent);
        }

        /* Section Labels */
        .section-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        /* ROI Badge */
        .roi-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(34, 197, 94, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--accent-green);
        }

        /* Empty state */
        .empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Glow effect */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 12px rgba(59, 130, 246, 0.5); }
        }

        .recently-updated {
            animation: glow 2s ease-in-out infinite;
            border-color: var(--accent) !important;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="logo">
            <svg class="logo-icon-svg" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" stroke="url(#g1)" stroke-width="1" opacity="0.3"/>
                <circle cx="50" cy="6" r="4" fill="#3b82f6"/>
                <circle cx="85" cy="25" r="3" fill="#06b6d4"/>
                <circle cx="94" cy="50" r="3" fill="#3b82f6"/>
                <circle cx="85" cy="75" r="3" fill="#06b6d4"/>
                <circle cx="50" cy="94" r="4" fill="#3b82f6"/>
                <circle cx="15" cy="75" r="3" fill="#06b6d4"/>
                <circle cx="6" cy="50" r="3" fill="#3b82f6"/>
                <circle cx="15" cy="25" r="3" fill="#06b6d4"/>
                <path d="M50 10 L50 22 M82 27 L72 35 M90 50 L78 50 M82 73 L72 65 M50 90 L50 78 M18 73 L28 65 M10 50 L22 50 M18 27 L28 35"
                      stroke="url(#g1)" stroke-width="1.5" opacity="0.5"/>
                <path d="M50 18 L75 28 L75 55 C75 70 50 82 50 82 C50 82 25 70 25 55 L25 28 Z"
                      fill="url(#g2)" stroke="url(#g1)" stroke-width="2"/>
                <text x="50" y="58" text-anchor="middle" font-family="Arial" font-size="32" font-weight="bold" fill="#fff">F</text>
                <defs>
                    <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6"/>
                        <stop offset="100%" style="stop-color:#06b6d4"/>
                    </linearGradient>
                    <linearGradient id="g2" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#1e3a5f"/>
                        <stop offset="100%" style="stop-color:#0f172a"/>
                    </linearGradient>
                </defs>
            </svg>
            <span class="logo-text">FixOnce</span>
        </div>
        <span class="status-dot" id="status-dot" title="Connected"></span>
    </header>

    <!-- MAIN -->
    <main>
        <!-- Project Identity -->
        <div class="section project-section" id="project-section">
            <div class="project-name" id="project-name">Loading...</div>
            <div class="project-goal">
                <span id="goal-text">‚Äî</span>
            </div>
            <div class="updated-badge" id="updated-badge">
                <span>‚ú®</span>
                <span id="updated-time">‚Äî</span>
            </div>
        </div>

        <!-- Stats -->
        <div class="section stats-section">
            <div class="stat">
                <div class="stat-value" id="stat-decisions">0</div>
                <div class="stat-label">Decisions</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-insights">0</div>
                <div class="stat-label">Insights</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-avoids">0</div>
                <div class="stat-label">Avoids</div>
            </div>
            <div class="stat" id="roi-stat" style="display: none;">
                <div class="stat-value" id="stat-roi">0</div>
                <div class="stat-label">Min Saved</div>
            </div>
        </div>

        <!-- Latest Decision -->
        <div class="section decision-section" id="decision-section">
            <span class="decision-icon">üîí</span>
            <span class="decision-text" id="decision-text">No decisions yet</span>
        </div>

        <!-- Active AI -->
        <div class="section ai-section">
            <span class="ai-dot"></span>
            <span class="ai-name" id="ai-name">Claude</span>
            <span class="ai-time" id="ai-time">now</span>
        </div>

        <!-- What Changed -->
        <div class="section changes-section" id="changes-section">
            <div class="section-label">What Changed</div>
            <div id="changes-list">
                <div class="change-item empty">No recent changes</div>
            </div>
        </div>

        <!-- Deep Dive Button -->
        <button class="deep-dive-btn" onclick="openFullDashboard()">
            <span>üîç</span>
            <span>Deep Dive</span>
        </button>
    </main>

    <script>
        let snapshot = null;

        async function fetchData() {
            try {
                const res = await fetch('/api/dashboard_snapshot');
                const data = await res.json();
                if (data.status === 'ok') {
                    snapshot = data.snapshot;
                    render();
                }
            } catch (e) {
                console.error('Fetch error:', e);
            }
        }

        function render() {
            if (!snapshot) return;

            const identity = snapshot.identity || {};
            const counts = identity.counts || {};
            const roi = snapshot.roi || {};

            // Project name
            document.getElementById('project-name').textContent = identity.name || 'FixOnce';

            // Goal
            const goal = identity.current_goal || identity.summary || 'No active goal';
            document.getElementById('goal-text').textContent = goal;

            // Updated time
            const updatedAt = snapshot.timestamp;
            if (updatedAt) {
                document.getElementById('updated-time').textContent = timeSince(updatedAt);
                const mins = (Date.now() - new Date(updatedAt).getTime()) / 60000;
                if (mins < 30) {
                    document.getElementById('updated-badge').classList.add('recent');
                }
            }

            // Stats
            document.getElementById('stat-decisions').textContent = counts.decisions || 0;
            document.getElementById('stat-insights').textContent = counts.insights || 0;
            document.getElementById('stat-avoids').textContent = counts.avoids || 0;

            // ROI
            const timeSaved = roi.time_saved_minutes || 0;
            if (timeSaved > 0) {
                document.getElementById('roi-stat').style.display = 'block';
                document.getElementById('stat-roi').textContent = timeSaved;
            }

            // Decision
            const decision = identity.last_decision;
            if (decision && decision.text) {
                document.getElementById('decision-text').textContent = decision.text;
            }

            // Active AI
            const ais = snapshot.active_ais || [];
            if (ais.length > 0) {
                const ai = ais[0];
                document.getElementById('ai-name').textContent = capitalize(ai.editor || 'Claude');
                const activityTime = ai.last_activity || ai.started_at;
                document.getElementById('ai-time').textContent = activityTime ? timeSince(activityTime) : 'now';
            }

            // What Changed
            renderChanges();

            // Glow effect for recent updates
            const activities = snapshot.activity || [];
            const tenMinAgo = Date.now() - (10 * 60 * 1000);
            const hasRecent = activities.some(a => new Date(a.timestamp).getTime() > tenMinAgo);
            if (hasRecent) {
                document.getElementById('project-section').classList.add('recently-updated');
            }
        }

        function renderChanges() {
            const activities = snapshot.activity || [];
            const container = document.getElementById('changes-list');

            if (activities.length === 0) {
                container.innerHTML = '<div class="change-item empty">No recent changes</div>';
                return;
            }

            const shown = [];
            const seen = new Set();

            for (const act of activities.slice(0, 6)) {
                const tool = act.tool || '';
                const humanName = act.human_name || '';
                let icon = 'üìù';
                let text = '';

                if (act.type === 'mcp_tool' || act.file_context === 'memory') {
                    if (tool === 'update_live_record') {
                        if (humanName.includes('Goal')) {
                            icon = 'üéØ'; text = 'Goal updated';
                        } else if (humanName.toLowerCase().includes('insight')) {
                            icon = 'üí°'; text = 'Insight added';
                        } else {
                            icon = 'üß†'; text = 'Memory updated';
                        }
                    } else if (tool === 'log_decision') {
                        icon = 'üîí'; text = 'Decision logged';
                    } else if (tool === 'log_avoid') {
                        icon = '‚ö†Ô∏è'; text = 'Avoid added';
                    } else if (tool === 'search_past_solutions') {
                        icon = 'üîç'; text = 'Searched memory';
                    } else if (tool === 'auto_init_session') {
                        icon = 'üöÄ'; text = 'Session started';
                    } else {
                        icon = 'üß†'; text = humanName || 'Memory updated';
                    }
                } else {
                    icon = 'üìù';
                    text = 'Edited ' + (act.human_name || 'file');
                }

                const key = icon + text;
                if (!seen.has(key)) {
                    seen.add(key);
                    shown.push({ icon, text });
                }
                if (shown.length >= 4) break;
            }

            container.innerHTML = shown.map(s =>
                `<div class="change-item">
                    <span class="change-icon">${s.icon}</span>
                    <span>${s.text}</span>
                </div>`
            ).join('');
        }

        function openFullDashboard() {
            // Try multiple methods to open in browser
            const url = window.location.origin + '/next';

            // Method 1: Try pywebview API
            if (window.pywebview) {
                window.pywebview.api.open_url(url);
                return;
            }

            // Method 2: Try to open in new window/tab
            const newWin = window.open(url, '_blank');
            if (newWin) return;

            // Method 3: Navigate in same window as fallback
            window.location.href = '/next';
        }

        function timeSince(dateStr) {
            const seconds = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
            if (seconds < 60) return 'now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        function capitalize(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        }

        // Init
        fetchData();
        setInterval(fetchData, 10000);
    </script>
</body>
</html>
